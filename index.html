<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการสนามแบดมินตัน</title>
    <style>
        :root {
            --primary: #1a2b47;
            --secondary: #00a8cc;
            --accent: #f39c12;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a3c;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light);
            margin: 0;
            padding: 0;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        nav {
            background-color: var(--white);
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav button {
            background-color: transparent;
            color: var(--dark);
            border: none;
            padding: 1rem 1.2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        nav button:hover, nav button.active {
            background-color: rgba(0, 168, 204, 0.1);
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        main {
            padding: 1.5rem 0;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--light);
            padding-bottom: 0.75rem;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .card h3 {
            color: var(--secondary);
            margin-top: 1.5rem;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        form div {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 168, 204, 0.2);
        }

        button {
            background-color: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            min-height: 48px;
        }

        button:hover:not(:disabled) {
            background-color: #0089a9;
            transform: translateY(-2px);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.danger { background-color: var(--danger); }
        button.danger:hover:not(:disabled) { background-color: #c0392b; }
        button.success { background-color: var(--success); }
        button.success:hover:not(:disabled) { background-color: #229954; }
        button.warning { background-color: var(--accent); }
        button.warning:hover:not(:disabled) { background-color: #e67e22; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover:not(:disabled) { background-color: #5a6268; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background-color: var(--light);
        }

        table th {
            background-color: var(--light);
            font-weight: bold;
            color: var(--primary);
        }

        .skill-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            color: var(--white);
            font-size: 0.8rem;
            font-weight: bold;
        }

        .skill-P { background-color: var(--success); }
        .skill-Nminus { background-color: #2c3e50; }
        .skill-N { background-color: var(--secondary); }
        .skill-Nplus { background-color: #e67e22; }
        .skill-BG { background-color: #95a5a6; }

        .check-in-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        .check-in-card {
            background-color: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .check-in-card:hover:not(.checked-in) {
            border-color: var(--secondary);
            transform: scale(1.05);
        }

        .check-in-card.checked-in {
            background-color: #e8f5e9;
            border-color: var(--success);
            cursor: default;
        }

        .check-in-card.playing-now {
            background-color: #fff3e0;
            border-color: var(--accent);
        }

        .check-in-card .player-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .check-in-card .status-icon {
            font-size: 1.5rem;
            margin-top: 0.5rem;
        }

        .match-card {
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--secondary);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--white);
        }

        .match-card h3 { margin-top: 0; }
        .match-teams { display: flex; justify-content: space-around; align-items: center; margin: 1.5rem 0; flex-wrap: wrap; gap: 1rem; }
        .team { text-align: center; min-width: 120px; }
        .team p { margin: 0.25rem 0; word-break: break-word; }
        .vs { font-size: 1.5rem; font-weight: bold; color: #888; }
        .match-controls { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .timer { font-size: 1.8rem; font-weight: bold; color: var(--primary); text-align: center; margin: 1rem 0; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .dashboard-card {
            background: linear-gradient(135deg, var(--white), var(--light));
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-card .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .dashboard-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .dashboard-card .label {
            color: var(--dark);
            font-weight: 500;
        }

        .dashboard-player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
        }

        .dashboard-player-card {
            background-color: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: box-shadow 0.3s;
            cursor: pointer;
        }

        .dashboard-player-card:hover {
            box-shadow: var(--shadow);
        }

        .dashboard-player-card .player-name {
            font-weight: 600;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .dashboard-player-card .player-skill {
            font-size: 0.7rem;
            margin: 0.25rem 0;
        }

        .dashboard-player-card .game-count {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .timeline {
            position: relative;
            padding: 1.5rem 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 35px;
            width: 2px;
            height: calc(100% + 10px);
            background-color: #e0e0e0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: relative;
            z-index: 1;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 1rem;
            border: 3px solid var(--white);
            box-shadow: 0 0 0 2px;
        }

        .timeline-dot.win {
            background-color: #e8f5e9;
            color: var(--success);
            box-shadow: 0 0 0 2px var(--success);
        }

        .timeline-dot.loss {
            background-color: #ffebee;
            color: var(--danger);
            box-shadow: 0 0 0 2px var(--danger);
        }

        .timeline-dot.draw {
            background-color: #fff3e0;
            color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .timeline-content {
            flex: 1;
            background-color: var(--light);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #e0e0e0;
        }

        .timeline-content.win {
            border-left-color: var(--success);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .timeline-content.loss {
            border-left-color: var(--danger);
            background-color: rgba(231, 76, 60, 0.05);
        }

        .timeline-content.draw {
            border-left-color: var(--accent);
            background-color: rgba(243, 156, 18, 0.05);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .timeline-result {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .timeline-result.win {
            background-color: var(--success);
        }

        .timeline-result.loss {
            background-color: var(--danger);
        }

        .timeline-result.draw {
            background-color: var(--accent);
        }

        .timeline-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #666;
            flex-wrap: wrap;
        }

        .timeline-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .timeline-opponents {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .timeline-opponents strong {
            color: var(--primary);
        }

        .stats-row {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            min-width: 150px;
            background-color: var(--white);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-box .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-box .label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .shuttle-counter {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .shuttle-counter div {
            text-align: center;
        }

        .shuttle-counter .count {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .court-shuttle-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0.75rem;
            background-color: #f0f8ff;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .shuttle-control-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .court-shuttle-control button {
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            min-height: auto;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
        }

        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary);
            font-size: 1.1rem;
            word-break: break-word;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
            padding: 0;
            min-height: auto;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }

        .toast {
            background-color: var(--white);
            border-left: 4px solid var(--secondary);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--accent);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .bulk-edit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 4px;
        }

        .bulk-edit-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .bulk-edit-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }

        .queue-card {
            background-color: var(--white);
            border: 2px solid #e0e0e0;
            border-left: 5px solid var(--secondary);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .queue-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .queue-card.created-just-now {
            border-left-color: var(--success);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .queue-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .queue-card-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .queue-card-number {
            background-color: var(--secondary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .queue-card-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .queue-team {
            text-align: center;
        }

        .queue-team h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .queue-team-players {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .queue-team-skills {
            font-size: 0.8rem;
            color: #888;
        }

        .queue-vs {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #ccc;
        }

        .queue-card-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #666;
            flex-wrap: wrap;
        }

        .queue-card-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .queue-card-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .queue-card-actions button {
            min-width: auto;
            font-size: 0.8rem;
            padding: 0.6rem 0.5rem;
        }

        .queue-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: #888;
        }

        .queue-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            color: #888;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            min-height: auto;
            transform: none;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--secondary);
        }

        .tab-btn.active {
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .quick-actions button {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            header h1 { font-size: 1.5rem; }
            nav button { padding: 0.8rem 0.5rem; font-size: 0.9rem; }
            .card { padding: 1rem; }
            .modal-content { width: 95%; padding: 1rem; }
            .timeline-item { margin-bottom: 1rem; }
            .timeline-dot { width: 28px; height: 28px; }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <header>
        <div class="container">
            <h1>🏸 ระบบจัดการสนามแบดมินตัน 🏸</h1>
        </div>
    </header>

    <nav>
        <button onclick="App.showView('dashboard')" class="active">แดชบอร์ด</button>
        <button onclick="App.showView('player-management')">จัดการผู้เล่น</button>
        <button onclick="App.showView('check-in')">เช็คอิน</button>
        <button onclick="App.showView('match-setup')">จัดคู่/จับสลาก</button>
        <button onclick="App.showView('active-matches')">สนามที่กำลังเล่น</button>
        <button onclick="App.showView('settings')">ตั้งค่า</button>
        <button onclick="App.showView('manager-tools')">หน้าผู้จัด</button>
    </nav>

    <main class="container">
        <!-- DASHBOARD VIEW -->
        <section id="dashboard" class="view active">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="icon">👥</div>
                    <div class="value" id="dash-total-players">0</div>
                    <div class="label">ผู้เล่นทั้งหมด</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">✅</div>
                    <div class="value" id="dash-checked-in">0</div>
                    <div class="label">เช็คอินแล้ว</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">🏐️</div>
                    <div class="value" id="dash-active-matches">0</div>
                    <div class="label">กำลังแข่ง</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">🏸</div>
                    <div class="value" id="dash-shuttle-in-play">0</div>
                    <div class="label">ลูกแบดพร้อมใช้</div>
                </div>
            </div>

            <div class="card">
                <h3>สถิติผู้เล่น (เรียงตามจำนวนเกมที่เล่นน้อยที่สุด)</h3>
                <div id="dashboard-player-list" class="dashboard-player-list"></div>
            </div>

            <div class="card">
                <h3>👥 ผู้เล่นคู่ที่เล่นด้วยกันบ่อยสุด</h3>
                <p style="font-size: 0.9rem; color: #888;">แสดงชื่อผู้เล่นคู่ที่เล่นด้วยกันบ่อย</p>
                <div id="frequent-partners-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
            </div>

            <div class="card">
                <h3>⚔️ อ่านอื่นที่เจอบ่อยสุด</h3>
                <p style="font-size: 0.9rem; color: #888;">แสดงชื่อผู้เล่นที่เป็นอ่านมากบ่อย</p>
                <div id="frequent-opponents-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
            </div>

            <div class="quick-actions">
                <button class="success" onclick="App.navigateAndShow('player-management')">➕ เพิ่มผู้เล่น</button>
                <button class="warning" onclick="App.navigateAndShow('match-setup')">🎲 จัดคู่เล่น</button>
                <button onclick="App.navigateAndShow('active-matches')">⏱️ ดูสนาม</button>
            </div>
        </section>

        <!-- PLAYER MANAGEMENT VIEW -->
        <section id="player-management" class="view">
            <div class="card">
                <h2>เพิ่มผู้เล่นคนเดียว</h2>
                <form id="add-player-form">
                    <div>
                        <label for="player-name">ชื่อผู้เล่น:</label>
                        <input type="text" id="player-name" required maxlength="50">
                    </div>
                    <div>
                        <label for="player-skill">ระดับมือ:</label>
                        <select id="player-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" id="btn-add-player">เพิ่มผู้เล่น</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>เพิ่มผู้เล่นแบบรวม (วางข้อความ)</h2>
                <p>คั่นลอกรายชื่อ (ห้ามมีการข้นบรรทัดใหม่ และเว้นวรรค)</p>
                <form id="bulk-add-form">
                    <div style="width: 100%;">
                        <label for="bulk-names">รายชื่อ:</label>
                        <textarea id="bulk-names" rows="5" placeholder="สมชาย&#10;สมศรี&#10;สมหงึ่ง"></textarea>
                    </div>
                    <div>
                        <label for="bulk-skill">ระดับมือ (สำหรับทุกคน):</label>
                        <select id="bulk-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success" id="btn-bulk-add">เพิ่มทั้งหมด</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>รายชื่อผู้เล่นทั้งหมด</h2>
                <input type="text" id="player-search" class="search-bar" placeholder="ค้นหาผู้เล่น...">
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ชื่อผู้เล่น</th>
                                <th style="width: 100px;">ระดับมือ</th>
                                <th>เกม</th>
                                <th style="width: 300px;">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="player-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="card bulk-edit-section">
                <h3>แก้ไขระดับมือแบบรวม</h3>
                <p>เลือกผู้เล่นที่ต้องการแก้ไขระดับมือใหม่</p>
                <div class="bulk-edit-list" id="bulk-edit-list"></div>
                <form id="bulk-edit-form">
                    <div>
                        <label for="bulk-edit-skill">ระดับมือใหม่:</label>
                        <select id="bulk-edit-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N">N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success" id="btn-bulk-edit">อัปเดตระดับมือ</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- CHECK-IN VIEW -->
        <section id="check-in" class="view">
            <div class="card">
                <h2>เช็คอินผู้เล่น</h2>
                <p>กดที่ชื่อผู้เล่นเพื่อเช็คอิน (ผู้เล่นที่เช็คอินแล้วจะยังคงสถานะนั้นหลังจบเกม 🏸 ผู้เล่นที่กำลังลงเล่นจะมีไอคอน 🏸)</p>
                <div id="check-in-list" class="check-in-grid"></div>
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="danger" onclick="App.resetAllCheckIns()">🔄 รีเซ็ตการเช็คอินทั้งหมด</button>
                </div>
            </div>
        </section>

        <!-- MATCH SETUP VIEW -->
        <section id="match-setup" class="view">
            <div class="card">
                <h2>🎮 จัดคู่เล่นแบดมินตัน</h2>
                
                <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid var(--light);">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                        <span>🎮 สดใจจัดคู่</span>
                        <small style="color: #888; font-weight: normal; font-size: 0.75rem;">(ลงเล่นทันที)</small>
                    </h3>
                    
                    <div id="match-setup-controls">
                        <!-- กลุ่มแรก: จัดคู่ปกติและสุ่ม -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; color: var(--primary);">จัดคู่เล่นทันที</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <label for="court-select-dropdown" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">🛏️ เลือกสนาม:</label>
                                    <select id="court-select-dropdown" style="width: 100%;"></select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">&nbsp;</label>
                                    <button class="warning" onclick="App.manualSetupStart()" id="btn-manual-setup" style="width: 100%; min-height: 42px;">🖊️ จัดคู่เอง</button>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">&nbsp;</label>
                                    <button class="success" onclick="App.simpleRandomMatch()" id="btn-random-setup" style="width: 100%; min-height: 42px;" disabled>🎲 จับสลากสุ่ม</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="match-setup-content">
                        <p style="color: #888; font-size: 0.9rem; margin: 0; padding: 0.75rem; background-color: var(--light); border-radius: 8px; border-left: 3px solid var(--secondary);">💡 กรุณาไปที่หน้า "เช็คอิน" เพื่อเลือกผู้เล่นก่อน</p>
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                        <span>⏳ คิวรอเล่น</span>
                        <span id="queue-badge" style="background-color: var(--secondary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">0</span>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <button class="success" onclick="App.queueMatchStart()" id="btn-queue-setup" style="width: 100%; min-height: 42px;" disabled>
                            ➕ คิวแบบน้อยสุด
                        </button>
                        <button class="success" onclick="App.queueRandomStart()" id="btn-queue-random" style="width: 100%; min-height: 42px;" disabled>
                            🎲 คิวแบบสุ่ม
                        </button>
                        <button class="secondary" onclick="App.switchToQueueTab()" id="btn-view-queue" style="width: 100%; min-height: 42px;" disabled>
                            📋 ดูรายชื่อคิว
                        </button>
                    </div>

                    <div id="queue-setup-tab" style="display: none;">
                        <div style="margin-bottom: 1.5rem; padding: 0.75rem; background-color: var(--light); border-radius: 8px; border-left: 3px solid var(--danger);">
                            <p style="color: #888; margin: 0; font-size: 0.9rem;">📌 เลือกคิวแล้วคลิกปุ่มเพื่อลงเล่น</p>
                        </div>
                        <div id="queue-list" style="display: grid; gap: 1rem;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACTIVE MATCHES VIEW -->
        <section id="active-matches" class="view">
            <div class="card">
                <h2>สตัฟอลูกแบดพร้อมใช้</h2>
                <div class="shuttle-counter">
                    <div>
                        <div class="count" id="live-shuttle-in-play">0</div>
                        <div>ลูกแบดใหม่ (พร้อมใช้)</div>
                    </div>
                    <div>
                        <div class="count" id="live-shuttle-practice">0</div>
                        <div>ลูกแบดซ้อม (พร้อมใช้)</div>
                    </div>
                </div>
                <form id="live-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="live-shuttle-action">จัดการสตัฟ:</label>
                        <select id="live-shuttle-action">
                            <option value="add">เพิ่มลูกใหม่ (เข้าสตัฟ)</option>
                            <option value="add-practice">เพิ่มลูกซ้อม (เข้าสตัฟ)</option>
                            <option value="remove">ลบลูกซ้อม (ทิ้ง)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="live-shuttle-amount">จำนวน:</label>
                        <input type="number" id="live-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit" id="btn-update-shuttle">ตกลง</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>สนามที่กำลังเล่นสนามแบดมินตัน</h2>
                <p style="color: var(--secondary); font-weight: bold;">หมายเหตุ: ระบบไดว้ลูกแบดพร้อมใช้ (ลูกซ้อม) ออกไป 1 ลูกแล้ว เมื่อเริ่มแมตช์</p>
                <div id="active-matches-list"></div>
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="settings" class="view">
            <div class="card">
                <h2>ตั้งค่าสนาม</h2>
                <h3>จัดการสนาม</h3>
                <form id="add-court-form">
                    <div>
                        <label for="court-name">ชื่อสนาม:</label>
                        <input type="text" id="court-name" required maxlength="50">
                    </div>
                    <div>
                        <button type="submit" id="btn-add-court">เพิ่มสนาม</button>
                    </div>
                </form>
                <div id="court-list" style="margin-top: 20px;"></div>
            </div>
            <div class="card">
                <h3>จัดการลูกแบด</h3>
                <div class="shuttle-counter">
                    <div>
                        <div class="count" id="settings-shuttle-new">0</div>
                        <div>ลูกแบดใหม่ (พร้อมใช้)</div>
                    </div>
                    <div>
                        <div class="count" id="settings-shuttle-practice">0</div>
                        <div>ลูกแบดซ้อม (พร้อมใช้)</div>
                    </div>
                </div>
                <form id="settings-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="settings-shuttle-action">การกระทำ:</label>
                        <select id="settings-shuttle-action">
                            <option value="add">เพิ่มลูกใหม่ (เข้าสตัฟ)</option>
                            <option value="add-practice">เพิ่มลูกซ้อม (เข้าสตัฟ)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="settings-shuttle-amount">จำนวน:</label>
                        <input type="number" id="settings-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit" id="btn-settings-shuttle">ตกลง</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- MANAGER TOOLS VIEW -->
        <section id="manager-tools" class="view">
            <div class="card">
                <h2>เครื่องมือผู้ดูแลระบบ</h2>
                <p>เครื่องมือเหล่านี้ใช้สำหรับจัดการข้อมูลในระบบทั้งหมด</p>

                <h3>ล้างข้อมูลผู้เล่นทั้งหมด</h3>
                <p style="color: var(--danger); font-weight: bold;">การกระทำนี้จะลบผู้เล่นทั้งหมดออกจากระบบ (แต่ข้อมูลประวัติการเล่นยังคงอยู่)</p>
                <button class="danger" onclick="App.clearAllPlayers()">เคลียร์ผู้เล่นทั้งหมด</button>
            </div>
        </section>
    </main>

    <!-- PLAYER HISTORY MODAL -->
    <div id="player-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-player-name">ประวัติการเล่นผู้เล่น</h2>
                <button class="close-modal" onclick="App.closePlayerHistoryModal()">✕</button>
            </div>
            <div id="modal-player-stats"></div>
            <div id="modal-game-records"></div>
        </div>
    </div>

<script>
    /**
     * ========================================================
     * REFACTORED BADMINTON COURT MANAGEMENT SYSTEM
     * ========================================================
     * Improvements:
     * 1. Fixed memory leaks with proper timer cleanup
     * 2. Enhanced validation with regex and bounds checking
     * 3. Separated shuttle management (new vs practice)
     * 4. Better error handling with fallback states
     * 5. Fixed race conditions with submit state
     * 6. Improved state persistence and recovery
     * ========================================================
     */

    // ============================================================
    // CONSTANTS & CONFIG
    // ============================================================

    const SKILL_VALUES = { 'BG': 1, 'N-': 2, 'N': 3, 'N+': 4, 'P': 5 };
    const SKILLS_LIST = ['BG', 'N-', 'N', 'N+', 'P'];
    const STORAGE_KEY = 'badmintonAppState';
    const MAX_NAME_LENGTH = 50;
    const MIN_PLAYERS_FOR_MATCH = 4;
    const STORAGE_WARNING_THRESHOLD = 90; // percentage

    // ============================================================
    // UTILITY - SECURITY & VALIDATION
    // ============================================================

    /**
     * HTML escape to prevent XSS attacks
     */
    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    /**
     * Sanitize input and validate format
     */
    function sanitizeInput(input) {
        const trimmed = String(input || '').trim();
        // Remove null bytes and other control characters
        const cleaned = trimmed.replace(/[\x00-\x1F\x7F]/g, '');
        return escapeHtml(cleaned);
    }

    /**
     * Enhanced name validation with regex
     */
    function validatePlayerName(name) {
        name = String(name || '').trim();

        if (!name || name.length === 0) {
            return { valid: false, error: 'ชื่อผู้เล่นห้ามว่าง' };
        }

        if (name.length > MAX_NAME_LENGTH) {
            return { valid: false, error: `ชื่อผู้เล่นยาวเกิน (สูงสุด ${MAX_NAME_LENGTH} ตัวอักษร)` };
        }

        // Allow Thai, English, numbers, and basic punctuation only
        if (!/^[\p{L}\p{N}\s\-\.]+$/u.test(name)) {
            return { valid: false, error: 'มีตัวอักษรที่ไม่อนุญาต' };
        }

        if (appState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
            return { valid: false, error: 'ชื่อผู้เล่นนี้มีอยู่แล้ว' };
        }

        return { valid: true, error: '' };
    }

    /**
     * Validate skill level
     */
    function validateSkill(skill) {
        return SKILLS_LIST.includes(String(skill));
    }

    /**
     * Validate positive number
     */
    function validateNumber(value, minValue = 1) {
        const num = parseInt(value);
        if (isNaN(num) || num < minValue) {
            return { valid: false, error: `ต้องเป็นตัวเลขและมากกว่า ${minValue - 1}` };
        }
        return { valid: true, error: '' };
    }

    /**
     * Validate court name
     */
    function validateCourtName(name) {
        name = String(name || '').trim();

        if (!name || name.length === 0) {
            return { valid: false, error: 'ชื่อสนามห้ามว่าง' };
        }

        if (name.length > 50) {
            return { valid: false, error: 'ชื่อสนามยาวเกิน' };
        }

        if (appState.courts.some(c => c.name.toLowerCase() === name.toLowerCase())) {
            return { valid: false, error: 'ชื่อสนามนี้มีอยู่แล้ว' };
        }

        return { valid: true, error: '' };
    }

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================

    /**
     * Get default state structure
     */
    function getDefaultState() {
        return {
            players: [],
            courts: [],
            matches: [],
            matchQueues: [],
            history: {},
            shuttlecocks: {
                newTotal: 0,
                newInPlay: 0,
                practiceTotal: 0,
                practiceInPlay: 0
            },
            nextId: { player: 1, court: 1, match: 1, queue: 1 }
        };
    }

    let appState = getDefaultState();

    const uiState = {
        manualSelectionOrder: [],
        matchTimers: {},
        currentFilter: '',
        isProcessing: false,
        activeEventListeners: []
    };

    /**
     * Save state to localStorage with quota checking
     */
    function saveState() {
        try {
            const stateToSave = JSON.stringify(appState);
            
            // Check storage size before saving
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    const percentUsed = (estimate.usage / estimate.quota) * 100;
                    if (percentUsed > STORAGE_WARNING_THRESHOLD) {
                        console.warn(`Storage usage: ${percentUsed.toFixed(2)}%`);
                    }
                });
            }

            localStorage.setItem(STORAGE_KEY, stateToSave);
            return true;
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                showError('Storage เต็มแล้ว ไม่สามารถบันทึกข้อมูลได้');
                console.error('QuotaExceededError:', e);
                return false;
            }
            console.error('Save state error:', e);
            return false;
        }
    }

    /**
     * Load state from localStorage with fallback
     */
    function loadState() {
        try {
            const savedState = localStorage.getItem(STORAGE_KEY);
            
            if (!savedState) {
                appState = getDefaultState();
                return;
            }

            appState = JSON.parse(savedState);
            validateAndFixState();

        } catch (e) {
            console.error('Load state error:', e);
            appState = getDefaultState();
            showWarning('ข้อมูลเสียหาย สร้างใหม่แล้ว');
        }
    }

    /**
     * Validate and repair corrupted state
     */
    function validateAndFixState() {
        // Ensure core objects exist
        if (!appState.history || typeof appState.history !== 'object') {
            appState.history = {};
        }
        if (!appState.matchQueues || !Array.isArray(appState.matchQueues)) {
            appState.matchQueues = [];
        }
        if (!appState.shuttlecocks) {
            appState.shuttlecocks = {
                newTotal: 0,
                newInPlay: 0,
                practiceTotal: 0,
                practiceInPlay: 0
            };
        }
        if (!appState.nextId) {
            appState.nextId = { player: 1, court: 1, match: 1, queue: 1 };
        }

        // Validate player data
        appState.players.forEach(p => {
            if (typeof p.isCheckedIn === 'undefined') p.isCheckedIn = false;
            if (typeof p.isPlaying === 'undefined') p.isPlaying = false;
            if (!appState.history[p.id]) {
                appState.history[p.id] = { games: [] };
            } else if (!Array.isArray(appState.history[p.id].games)) {
                appState.history[p.id].games = [];
            }
        });

        // Validate match data
        appState.matches.forEach(m => {
            if (typeof m.newShuttleUsed === 'undefined') m.newShuttleUsed = 0;
            if (typeof m.practiceShuttleUsed === 'undefined') m.practiceShuttleUsed = 0;
        });

        // Recalculate IDs
        const maxPlayerId = appState.players.length > 0 
            ? Math.max(...appState.players.map(p => p.id)) 
            : 0;
        const maxCourtId = appState.courts.length > 0 
            ? Math.max(...appState.courts.map(c => c.id)) 
            : 0;

        let maxGameId = 0;
        Object.values(appState.history).forEach(playerHistory => {
            if (playerHistory?.games && Array.isArray(playerHistory.games)) {
                playerHistory.games.forEach(game => {
                    if (game.id > maxGameId) maxGameId = game.id;
                });
            }
        });

        const maxMatchId = appState.matches.length > 0 
            ? Math.max(...appState.matches.map(m => m.id)) 
            : 0;
        const maxQueueId = appState.matchQueues.length > 0 
            ? Math.max(...appState.matchQueues.map(q => q.id)) 
            : 0;

        appState.nextId = {
            player: maxPlayerId + 1,
            court: maxCourtId + 1,
            match: Math.max(maxMatchId, maxGameId) + 1,
            queue: maxQueueId + 1
        };
    }

    // ============================================================
    // NOTIFICATION SYSTEM
    // ============================================================

    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        if (duration > 0) {
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        return toast;
    }

    function showError(message) {
        console.error('Error:', message);
        showToast(`❌ ${message}`, 'error');
    }

    function showSuccess(message) {
        console.log('Success:', message);
        showToast(`✅ ${message}`, 'success');
    }

    function showWarning(message) {
        console.warn('Warning:', message);
        showToast(`⚠️ ${message}`, 'warning');
    }

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================

    function formatTime(ms) {
        if (!ms) return '00:00';
        const totalSeconds = Math.floor(Math.max(0, ms) / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function formatDate(timestamp) {
        if (!timestamp || typeof timestamp !== 'number') return '-';
        
        try {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'เมื่อวาน';
            } else if (diffDays < 7) {
                return `${diffDays} วันที่แล้ว`;
            } else {
                return date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
            }
        } catch (e) {
            console.warn('formatDate error:', e);
            return '-';
        }
    }

    function getSkillClass(skill) {
        return String(skill || 'N').replace('+', 'plus').replace('-', 'minus');
    }

    function getSkillValue(skill) {
        return SKILL_VALUES[String(skill) || 'N'] || 3;
    }

    // ============================================================
    // PLAYER UTILITIES
    // ============================================================

    const PlayerUtils = {
        getById: (id) => {
            const player = appState.players.find(p => p.id === id);
            if (!player) {
                console.warn(`Player not found: ${id}`);
                return null;
            }
            return player;
        },

        isAvailable: (player) => {
            return player && player.isCheckedIn && !player.isPlaying;
        },

        getGameCount: (playerId) => {
            const history = appState.history[playerId];
            return (history && Array.isArray(history.games)) ? history.games.length : 0;
        }
    };

    // ============================================================
    // COURT UTILITIES
    // ============================================================

    const CourtUtils = {
        getAvailable: () => {
            return appState.courts.filter(c => c.status === 'free');
        },

        getById: (id) => {
            const court = appState.courts.find(c => c.id == id);
            if (!court) {
                console.warn(`Court not found: ${id}`);
                return null;
            }
            return court;
        }
    };

    // ============================================================
    // TIMER MANAGEMENT WITH CLEANUP
    // ============================================================

    function startTimer(matchId, card) {
        // Stop existing timer first
        stopTimer(matchId);

        const match = appState.matches.find(m => m.id === matchId);
        if (!match) return;

        if (!match.startTime) {
            match.startTime = Date.now();
            saveState();
        }

        const timerEl = card 
            ? card.querySelector(`#match-timer-${matchId}`) 
            : document.getElementById(`match-timer-${matchId}`);
        
        if (!timerEl) return;

        const updateTimer = () => {
            const elapsedTime = Date.now() - match.startTime;
            timerEl.textContent = formatTime(elapsedTime);
        };

        updateTimer();
        
        const timerId = setInterval(updateTimer, 1000);
        uiState.matchTimers[matchId] = timerId;

        return timerId;
    }

    function stopTimer(matchId) {
        if (uiState.matchTimers[matchId]) {
            clearInterval(uiState.matchTimers[matchId]);
            delete uiState.matchTimers[matchId];
        }
    }

    /**
     * Cleanup all timers - called on page unload
     */
    function cleanupAllTimers() {
        Object.values(uiState.matchTimers).forEach(timerId => {
            clearInterval(timerId);
        });
        uiState.matchTimers = {};
    }

    // ============================================================
    // APP NAMESPACE - Main Application Controller
    // ============================================================

    const App = {
        /**
         * Show specific view
         */
        showView: function(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));

            const selectedView = document.getElementById(viewId);
            if (selectedView) {
                selectedView.classList.add('active');
            }

            const activeNavBtn = document.querySelector(`nav button[onclick*="${viewId}"]`);
            if (activeNavBtn) activeNavBtn.classList.add('active');

            // Render appropriate content
            switch(viewId) {
                case 'dashboard':
                    this.renderDashboard();
                    break;
                case 'player-management':
                    this.renderPlayerList();
                    break;
                case 'check-in':
                    this.renderCheckInList();
                    break;
                case 'match-setup':
                    this.renderMatchSetup();
                    break;
                case 'active-matches':
                    this.renderActiveMatches();
                    break;
                case 'settings':
                    this.renderSettings();
                    break;
            }
        },

        navigateAndShow: function(viewId) {
            this.showView(viewId);
        },

        /**
         * Dashboard rendering
         */
        renderDashboard: function() {
            const totalPlayers = appState.players.length;
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn).length;
            const activeMatches = appState.matches.length;
            const newShuttleInPlay = appState.shuttlecocks.newInPlay;

            document.getElementById('dash-total-players').textContent = totalPlayers;
            document.getElementById('dash-checked-in').textContent = checkedInPlayers;
            document.getElementById('dash-active-matches').textContent = activeMatches;
            document.getElementById('dash-shuttle-in-play').textContent = newShuttleInPlay;

            this.renderDashboardPlayerStats();
            this.renderFrequentPartners();
            this.renderFrequentOpponents();
            this.updateShuttleDisplay();
        },

        renderDashboardPlayerStats: function() {
            const listEl = document.getElementById('dashboard-player-list');
            listEl.innerHTML = '';

            const playerGameCounts = {};
            appState.players.forEach(p => {
                playerGameCounts[p.id] = PlayerUtils.getGameCount(p.id);
            });

            const sortedPlayers = appState.players.slice().sort((a, b) => {
                const countA = playerGameCounts[a.id];
                const countB = playerGameCounts[b.id];
                if (countA !== countB) return countA - countB;
                return a.name.localeCompare(b.name, 'th');
            });

            sortedPlayers.forEach(player => {
                const skillClass = getSkillClass(player.skill);
                const card = document.createElement('div');
                card.classList.add('dashboard-player-card');
                card.style.cursor = 'pointer';
                card.onclick = () => this.openPlayerHistoryModal(player.id);
                card.innerHTML = `
                    <div class="player-name">${escapeHtml(player.name)}</div>
                    <div class="player-skill"><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></div>
                    <div class="game-count">${playerGameCounts[player.id]} เกม</div>
                `;
                listEl.appendChild(card);
            });
        },

        renderFrequentPartners: function() {
            const listEl = document.getElementById('frequent-partners-list');
            listEl.innerHTML = '';

            const partnerMap = {};
            Object.entries(appState.history).forEach(([playerIdStr, playerHistory]) => {
                if (playerHistory?.games && Array.isArray(playerHistory.games)) {
                    const playerId = parseInt(playerIdStr);
                    playerHistory.games.forEach(game => {
                        if (game.team1?.includes(playerId)) {
                            game.team1.forEach(partnerId => {
                                if (partnerId !== playerId) {
                                    partnerMap[partnerId] = (partnerMap[partnerId] || 0) + 1;
                                }
                            });
                        } else if (game.team2?.includes(playerId)) {
                            game.team2.forEach(partnerId => {
                                if (partnerId !== playerId) {
                                    partnerMap[partnerId] = (partnerMap[partnerId] || 0) + 1;
                                }
                            });
                        }
                    });
                }
            });

            const sortedPartners = Object.entries(partnerMap)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);

            if (sortedPartners.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1/-1;">ยังไม่มีประวัติการจับคู่</p>';
                return;
            }

            sortedPartners.forEach(([partnerId, count]) => {
                const partner = PlayerUtils.getById(parseInt(partnerId));
                if (!partner) return;

                const card = document.createElement('div');
                card.style.cssText = 'background-color: var(--light); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--success);';
                card.innerHTML = `
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">${escapeHtml(partner.name)}</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${count}</div>
                    <div style="font-size: 0.85rem; color: #888;">ครั้งที่เล่นด้วยกัน</div>
                `;
                listEl.appendChild(card);
            });
        },

        renderFrequentOpponents: function() {
            const listEl = document.getElementById('frequent-opponents-list');
            listEl.innerHTML = '';

            const opponentMap = {};
            Object.entries(appState.history).forEach(([playerIdStr, playerHistory]) => {
                if (playerHistory?.games && Array.isArray(playerHistory.games)) {
                    playerHistory.games.forEach(game => {
                        const playerId = parseInt(playerIdStr);

                        if (game.team1?.includes(playerId)) {
                            game.team2?.forEach(opponentId => {
                                if (!opponentMap[opponentId]) {
                                    opponentMap[opponentId] = { wins: 0, losses: 0 };
                                }
                                if (game.winner === 1) {
                                    opponentMap[opponentId].losses++;
                                } else if (game.winner === 2) {
                                    opponentMap[opponentId].wins++;
                                }
                            });
                        } else if (game.team2?.includes(playerId)) {
                            game.team1?.forEach(opponentId => {
                                if (!opponentMap[opponentId]) {
                                    opponentMap[opponentId] = { wins: 0, losses: 0 };
                                }
                                if (game.winner === 2) {
                                    opponentMap[opponentId].losses++;
                                } else if (game.winner === 1) {
                                    opponentMap[opponentId].wins++;
                                }
                            });
                        }
                    });
                }
            });

            const sortedOpponents = Object.entries(opponentMap)
                .map(([opponentId, stats]) => ({
                    id: opponentId,
                    ...stats,
                    total: stats.wins + stats.losses
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);

            if (sortedOpponents.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1/-1;">ยังไม่มีประวัติการเจอหน้า</p>';
                return;
            }

            sortedOpponents.forEach(({ id, wins, losses, total }) => {
                const opponent = PlayerUtils.getById(parseInt(id));
                if (!opponent) return;

                const winRate = total > 0 ? ((wins / total) * 100).toFixed(0) : 0;
                const card = document.createElement('div');
                card.style.cssText = 'background-color: var(--light); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--danger);';
                card.innerHTML = `
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">${escapeHtml(opponent.name)}</div>
                    <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">
                        <span style="color: var(--success);">${wins}W</span> <span style="color: var(--danger);">${losses}L</span>
                    </div>
                    <div style="font-size: 0.85rem; color: #888;">${total} ครั้ง (ชนะ ${winRate}%)</div>
                `;
                listEl.appendChild(card);
            });
        },

        /**
         * Player management functions
         */
        addPlayer: function(name, skill) {
            const nameValidation = validatePlayerName(name);
            if (!nameValidation.valid) {
                return { success: false, error: nameValidation.error };
            }

            if (!validateSkill(skill)) {
                return { success: false, error: 'ระดับมือไม่ถูกต้อง' };
            }

            const newPlayer = {
                id: appState.nextId.player++,
                name: sanitizeInput(name),
                skill: String(skill),
                isCheckedIn: false,
                isPlaying: false
            };

            appState.players.push(newPlayer);
            appState.history[newPlayer.id] = { games: [] };
            return { success: true, player: newPlayer };
        },

        renderPlayerList: function(filter = '') {
            uiState.currentFilter = filter;
            const listEl = document.getElementById('player-list');
            const bulkEditListEl = document.getElementById('bulk-edit-list');
            listEl.innerHTML = '';
            bulkEditListEl.innerHTML = '';

            const filteredPlayers = appState.players.filter(p =>
                p.name.toLowerCase().includes(filter.toLowerCase()) ||
                p.id.toString().includes(filter)
            );

            if (filteredPlayers.length === 0 && filter.length > 0) {
                listEl.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">ไม่พบผู้เล่นที่ตรงกัน</td></tr>';
            }

            filteredPlayers.forEach(player => {
                const skillClass = getSkillClass(player.skill);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="text" id="name-edit-${player.id}" value="${escapeHtml(player.name)}"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                               placeholder="ชื่อผู้เล่น" maxlength="50">
                    </td>
                    <td><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></td>
                    <td>${PlayerUtils.getGameCount(player.id)}</td>
                    <td>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            <button class="success" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                    onclick="App.updatePlayerName(${player.id}, document.getElementById('name-edit-${player.id}').value)">บันทึก</button>
                            <select id="edit-skill-${player.id}" style="padding: 0.5rem; width: auto;">
                                ${SKILLS_LIST.map(s =>
                                    `<option value="${s}" ${s === player.skill ? 'selected' : ''}>${s}</option>`
                                ).join('')}
                            </select>
                            <button class="warning" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                    onclick="App.updatePlayerSkill(${player.id}, document.getElementById('edit-skill-${player.id}').value)">อัปเดต</button>
                            <button class="danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                    onclick="App.deletePlayer(${player.id})">ลบ</button>
                        </div>
                    </td>
                `;
                listEl.appendChild(tr);

                const bulkItem = document.createElement('div');
                bulkItem.classList.add('bulk-edit-item');
                bulkItem.innerHTML = `
                    <span>${escapeHtml(player.name)} <span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></span>
                    <input type="checkbox" data-player-id="${player.id}">
                `;
                bulkEditListEl.appendChild(bulkItem);
            });
        },

        updatePlayerName: function(id, newName) {
            const player = PlayerUtils.getById(id);
            if (!player) return;

            const nameValidation = validatePlayerName(newName);
            if (!nameValidation.valid) {
                showError(nameValidation.error);
                return;
            }

            const oldName = player.name;
            player.name = sanitizeInput(newName);
            saveState();
            this.renderPlayerList(uiState.currentFilter);
            showSuccess(`เปลี่ยนชื่อจาก "${escapeHtml(oldName)}" เป็น "${escapeHtml(player.name)}" สำเร็จ`);
        },

        updatePlayerSkill: function(id, newSkill) {
            if (!validateSkill(newSkill)) {
                showError('ระดับมือไม่ถูกต้อง');
                return;
            }

            const player = PlayerUtils.getById(id);
            if (!player) return;

            if (player.skill === newSkill) {
                showWarning('ระดับมือเดิมอยู่แล้ว');
                return;
            }

            player.skill = String(newSkill);
            saveState();
            this.renderPlayerList(uiState.currentFilter);
            showSuccess(`อัปเดตระดับมือ ${escapeHtml(player.name)} เป็น ${newSkill}`);
        },

        deletePlayer: function(id) {
            const player = PlayerUtils.getById(id);
            if (!player) return;

            const gameCount = PlayerUtils.getGameCount(id);

            if (confirm(`คุณแน่ใจว่าต้องการลบ ${escapeHtml(player.name)}?\n\nเกมที่เล่นมา: ${gameCount} เกม\n⚠️ การกระทำนี้ไม่สามารถถอยกลับได้`)) {
                appState.players = appState.players.filter(p => p.id !== id);
                appState.matches = appState.matches.filter(m => !m.team1.includes(id) && !m.team2.includes(id));
                delete appState.history[id];
                saveState();
                this.renderPlayerList(uiState.currentFilter);
                this.renderActiveMatches();
                showSuccess(`ลบ ${escapeHtml(player.name)} สำเร็จ`);
            }
        },

        clearAllPlayers: function() {
            if (appState.matches.length > 0) {
                showError('ไม่สามารถลบผู้เล่นได้! มีผู้เล่นบางคนกำลังแข่ง');
                return;
            }

            if (confirm(`คุณแน่ใจว่าต้องการลบข้อมูลผู้เล่นทั้งหมด?\n⚠️ การกระทำนี้ไม่สามารถถอยกลับได้`)) {
                appState.players = [];
                appState.nextId.player = 1;
                saveState();
                this.renderDashboard();
                this.renderPlayerList();
                this.renderCheckInList();
                showSuccess('ลบข้อมูลผู้เล่นทั้งหมดสำเร็จ');
            }
        },

        /**
         * Check-in functions
         */
        toggleCheckIn: function(id) {
            const player = PlayerUtils.getById(id);
            if (!player) return;

            if (player.isPlaying) {
                showError(`${escapeHtml(player.name)} กำลังแข่งอยู่`);
                return;
            }

            player.isCheckedIn = !player.isCheckedIn;

            if (player.isCheckedIn) {
                player.checkInTime = Date.now();
            } else {
                delete player.checkInTime;
            }

            saveState();
            this.renderCheckInList();
            this.renderDashboard();
        },

        resetAllCheckIns: function() {
            if (appState.players.some(p => p.isPlaying)) {
                showError('ไม่สามารถรีเซ็ตได้ มีผู้เล่นบางคนกำลังแข่ง');
                return;
            }

            if (confirm('คุณแน่ใจว่าต้องการรีเซ็ตการเช็คอินทั้งหมด?')) {
                appState.players.forEach(p => {
                    p.isCheckedIn = false;
                    p.isPlaying = false;
                    delete p.checkInTime;
                });
                saveState();
                this.renderCheckInList();
                this.renderDashboard();
                showSuccess('รีเซ็ตการเช็คอินสำเร็จ');
            }
        },

        renderCheckInList: function() {
            const listEl = document.getElementById('check-in-list');
            listEl.innerHTML = '';

            const playingIds = new Set();
            appState.matches.forEach(m => {
                [...m.team1, ...m.team2].forEach(id => playingIds.add(id));
            });

            appState.players.forEach(p => {
                p.isPlaying = playingIds.has(p.id);
            });
            saveState();

            const sortedPlayers = appState.players.slice().sort((a, b) => {
                const statusA = a.isCheckedIn ? (a.isPlaying ? 2 : 1) : 3;
                const statusB = b.isCheckedIn ? (b.isPlaying ? 2 : 1) : 3;

                if (statusA !== statusB) return statusA - statusB;

                if (a.isCheckedIn && b.isCheckedIn && !a.isPlaying && !b.isPlaying) {
                    if (a.checkInTime && b.checkInTime) {
                        if (a.checkInTime !== b.checkInTime) return a.checkInTime - b.checkInTime;
                    }
                }

                return a.name.localeCompare(b.name, 'th');
            });

            sortedPlayers.forEach(player => {
                const skillClass = getSkillClass(player.skill);
                const gameCount = PlayerUtils.getGameCount(player.id);
                const card = document.createElement('div');
                card.classList.add('check-in-card');

                if (player.isCheckedIn) card.classList.add('checked-in');
                if (player.isPlaying) card.classList.add('playing-now');

                card.onclick = () => this.toggleCheckIn(player.id);

                let statusIcon = player.isCheckedIn ? '✅' : '❌';
                if (player.isPlaying) {
                    statusIcon = '🏸';
                    card.classList.remove('checked-in');
                }

                card.innerHTML = `
                    <div class="player-name">${escapeHtml(player.name)}</div>
                    <div class="player-skill"><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></div>
                    <div style="font-size:0.8rem; color:#888;">${gameCount} เกม</div>
                    <div class="status-icon">${statusIcon}</div>
                `;
                listEl.appendChild(card);
            });
        },

        /**
         * Court management
         */
        addCourt: function(name) {
            const validation = validateCourtName(name);
            if (!validation.valid) {
                showError(validation.error);
                return false;
            }

            const newCourt = {
                id: appState.nextId.court++,
                name: sanitizeInput(name),
                status: 'free',
                currentMatchId: null
            };

            appState.courts.push(newCourt);
            saveState();
            this.renderCourtList();
            this.renderMatchSetup();
            showSuccess(`เพิ่มสนาม ${escapeHtml(newCourt.name)} สำเร็จ`);
            return true;
        },

        deleteCourt: function(id) {
            const court = CourtUtils.getById(id);
            if (!court) return;

            if (court.status === 'playing') {
                showError(`ไม่สามารถลบสนาม ${escapeHtml(court.name)} ได้เนื่องจากมีแมตช์กำลังแข่ง`);
                return;
            }

            if (confirm(`คุณแน่ใจว่าต้องการลบสนาม ${escapeHtml(court.name)}?`)) {
                appState.courts = appState.courts.filter(c => c.id !== id);
                saveState();
                this.renderCourtList();
                this.renderMatchSetup();
                showSuccess(`ลบสนาม ${escapeHtml(court.name)} สำเร็จ`);
            }
        },

        renderCourtList: function() {
            const listEl = document.getElementById('court-list');
            listEl.innerHTML = '';

            if (appState.courts.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888;">ยังไม่มีสนามที่เพิ่มเข้ามา</p>';
                return;
            }

            appState.courts.forEach(court => {
                const li = document.createElement('div');
                li.style.cssText = 'background-color: ' + (court.status === 'playing' ? '#ffe0b2' : 'var(--light)') + '; padding: 1rem; margin-bottom: 0.75rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';
                li.innerHTML = `
                    <span>
                        ${escapeHtml(court.name)}
                        <span style="font-size: 0.8rem; color: ${court.status === 'playing' ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                            (${court.status === 'playing' ? 'กำลังเล่น' : 'ว่าง'})
                        </span>
                    </span>
                    <button class="danger" style="padding: 0.5rem 1rem;" onclick="App.deleteCourt(${court.id})">ลบ</button>
                `;
                listEl.appendChild(li);
            });
        },

        renderSettings: function() {
            this.renderCourtList();
            this.updateShuttleDisplay();
        },

        /**
         * Shuttle management
         */
        updateShuttleDisplay: function() {
            const newInPlay = appState.shuttlecocks.newInPlay;
            const practiceInPlay = appState.shuttlecocks.practiceInPlay;

            // Dashboard
            const dashEl = document.getElementById('dash-shuttle-in-play');
            if (dashEl) dashEl.textContent = newInPlay;

            // Live
            const liveNewEl = document.getElementById('live-shuttle-in-play');
            if (liveNewEl) liveNewEl.textContent = newInPlay;

            const livePracticeEl = document.getElementById('live-shuttle-practice');
            if (livePracticeEl) livePracticeEl.textContent = practiceInPlay;

            // Settings
            const settingsNewEl = document.getElementById('settings-shuttle-new');
            if (settingsNewEl) settingsNewEl.textContent = newInPlay;

            const settingsPracticeEl = document.getElementById('settings-shuttle-practice');
            if (settingsPracticeEl) settingsPracticeEl.textContent = practiceInPlay;
        },

        updateGlobalShuttlecocks: function(action, type, amount) {
            const validation = validateNumber(amount);
            if (!validation.valid) {
                showError(validation.error);
                return;
            }

            amount = parseInt(amount);

            if (type === 'new') {
                switch (action) {
                    case 'add':
                        appState.shuttlecocks.newTotal += amount;
                        appState.shuttlecocks.newInPlay += amount;
                        break;
                    case 'remove':
                        if (appState.shuttlecocks.newInPlay < amount) {
                            showError('ลูกแบดใหม่ไม่พอ');
                            return;
                        }
                        appState.shuttlecocks.newInPlay -= amount;
                        break;
                }
            } else if (type === 'practice') {
                switch (action) {
                    case 'add':
                        appState.shuttlecocks.practiceTotal += amount;
                        appState.shuttlecocks.practiceInPlay += amount;
                        break;
                    case 'remove':
                        if (appState.shuttlecocks.practiceInPlay < amount) {
                            showError('ลูกแบดซ้อมไม่พอ');
                            return;
                        }
                        appState.shuttlecocks.practiceInPlay -= amount;
                        break;
                }
            }

            if (appState.shuttlecocks.newInPlay < 0) appState.shuttlecocks.newInPlay = 0;
            if (appState.shuttlecocks.practiceInPlay < 0) appState.shuttlecocks.practiceInPlay = 0;

            saveState();
            this.updateShuttleDisplay();
            showSuccess(`จัดการสตัฟสำเร็จ: ${amount} ลูก`);
        },

        /**
         * Match setup
         */
        renderMatchSetup: function() {
            this.renderCourtSelectDropdown('court-select-dropdown');

            const setupContentEl = document.getElementById('match-setup-content');
            setupContentEl.innerHTML = '<p style="color: #888; font-size: 0.9rem; margin: 0; padding: 0.75rem; background-color: var(--light); border-radius: 8px; border-left: 3px solid var(--secondary);">💡 กรุณาไปที่หน้า "เช็คอิน" เพื่อเลือกผู้เล่นก่อน</p>';
            uiState.manualSelectionOrder = [];
            
            this.updateQueueDisplay();
        },

        renderCourtSelectDropdown: function(targetId) {
            const selectEl = document.getElementById(targetId);
            selectEl.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- เลือกสนามว่าง --';
            selectEl.appendChild(defaultOption);

            const availableCourts = CourtUtils.getAvailable();
            availableCourts.forEach(court => {
                const option = document.createElement('option');
                option.value = court.id;
                option.textContent = escapeHtml(court.name);
                selectEl.appendChild(option);
            });

            const hasAvailableCourt = availableCourts.length > 0;
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            const canSetup = hasAvailableCourt && checkedInPlayers.length >= MIN_PLAYERS_FOR_MATCH;

            const randomBtn = document.getElementById('btn-random-setup');
            const queueBtn = document.getElementById('btn-queue-setup');
            
            if (randomBtn) randomBtn.disabled = !canSetup;
            if (queueBtn) queueBtn.disabled = !canSetup;
        },

        switchToQueueTab: function() {
            const queueTab = document.getElementById('queue-setup-tab');
            queueTab.style.display = 'block';
            this.renderQueueList();
        },

        updateQueueDisplay: function() {
            const count = appState.matchQueues.length;
            const queueBadge = document.getElementById('queue-badge');
            
            if (queueBadge) queueBadge.textContent = count;
            
            const btnQueueSetup = document.getElementById('btn-queue-setup');
            const btnQueueRandom = document.getElementById('btn-queue-random');
            const btnViewQueue = document.getElementById('btn-view-queue');
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            
            if (btnQueueSetup) {
                btnQueueSetup.disabled = checkedInPlayers.length < 4;
            }
            if (btnQueueRandom) {
                btnQueueRandom.disabled = checkedInPlayers.length < 4;
            }
            if (btnViewQueue) {
                btnViewQueue.disabled = count === 0;
            }
        },

        renderQueueList: function() {
            const listEl = document.getElementById('queue-list');
            listEl.innerHTML = '';

            if (appState.matchQueues.length === 0) {
                listEl.innerHTML = `
                    <div class="queue-empty">
                        <div class="queue-empty-icon">🔭</div>
                        <h3 style="margin: 0;">ไม่มีคิวรอเล่น</h3>
                        <p style="margin: 0.5rem 0;">กลับไปหน้า "สดใจจัดคู่" เพื่อสร้างคิวใหม่</p>
                    </div>
                `;
                return;
            }

            appState.matchQueues.forEach((queue, index) => {
                const team1Names = queue.team1.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');
                const team2Names = queue.team2.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');

                const team1Skills = queue.team1.map(id => PlayerUtils.getById(id)?.skill || '?');
                const team2Skills = queue.team2.map(id => PlayerUtils.getById(id)?.skill || '?');

                const createdTime = formatDate(queue.createdAt);
                const isNew = Date.now() - queue.createdAt < 60000;

                const card = document.createElement('div');
                card.classList.add('queue-card');
                if (isNew) card.classList.add('created-just-now');

                card.innerHTML = `
                    <div class="queue-card-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="queue-card-number">${index + 1}</div>
                            <div class="queue-card-title">คิวเล่น #${queue.id}</div>
                        </div>
                        <span style="font-size: 0.85rem; color: #888;">สร้างเมื่อ ${createdTime}</span>
                    </div>

                    <div class="queue-card-teams">
                        <div class="queue-team">
                            <h4>ทีม 1</h4>
                            <div class="queue-team-players">${team1Names}</div>
                            <div class="queue-team-skills">${team1Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</div>
                        </div>
                        <div class="queue-vs">VS</div>
                        <div class="queue-team">
                            <h4>ทีม 2</h4>
                            <div class="queue-team-players">${team2Names}</div>
                            <div class="queue-team-skills">${team2Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</div>
                        </div>
                    </div>

                    <div class="queue-card-meta">
                        <span>👥 ${queue.team1.length + queue.team2.length} คน</span>
                        <span>🏸 Balanced</span>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <h5 style="margin: 0 0 0.75rem 0; color: var(--primary); font-size: 0.9rem; font-weight: bold;">🎮 จัดคู่เล่นแบบปกติ</h5>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="warning" onclick="App.manualSetupQueueStart(${queue.id})" style="flex: 1; min-height: 40px;" title="เลือกสนามเอง">
                                    🖊️ จัดคู่เอง
                                </button>
                                <button class="secondary" onclick="App.randomShuffleQueue(${queue.id})" style="flex: 1; min-height: 40px;" title="จับสลากใหม่">
                                    🎲 สุ่มทีม
                                </button>
                            </div>
                        </div>
                        <div>
                            <h5 style="margin: 0 0 0.75rem 0; color: var(--primary); font-size: 0.9rem; font-weight: bold;">⏳ บันทึกเข้าคิว</h5>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="success" onclick="App.callQueueToPlay(${queue.id})" style="flex: 1.2; min-height: 40px;" title="เรียกลงเล่นทันที">
                                    ✓ เรียกลงเล่น
                                </button>
                                <button class="danger" onclick="App.deleteQueue(${queue.id})" style="flex: 0.6; min-height: 40px; padding: 0;" title="ลบคิว">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                listEl.appendChild(card);
            });
        },

        addToQueue: function(team1Ids, team2Ids) {
            const queueId = appState.nextId.queue++;
            const newQueue = {
                id: queueId,
                team1: team1Ids,
                team2: team2Ids,
                createdAt: Date.now(),
                createdBy: 'auto',
                newShuttleUsed: 0,
                practiceShuttleUsed: 0
            };

            appState.matchQueues.push(newQueue);
            saveState();
            this.updateQueueDisplay();
            showSuccess(`เพิ่มคิวเล่น #${queueId} สำเร็จ`);

            return queueId;
        },

        callQueueToPlay: function(queueId) {
            const queue = appState.matchQueues.find(q => q.id === queueId);
            if (!queue) {
                showError('ไม่พบคิวที่ระบุ');
                return;
            }

            const queuePlayers = [...queue.team1, ...queue.team2];
            const allPlayersAvailable = queuePlayers.every(id => {
                const player = PlayerUtils.getById(id);
                return player && player.isCheckedIn && !player.isPlaying;
            });

            if (!allPlayersAvailable) {
                showError('ผู้เล่นบางคนในคิวนี้ไม่พร้อมเล่น (อาจกำลังแข่ง)');
                return;
            }

            const availableCourts = CourtUtils.getAvailable();
            if (availableCourts.length === 0) {
                showError('ไม่มีสนามว่างให้ใช้งาน');
                return;
            }

            const team1Names = queue.team1.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');
            const team2Names = queue.team2.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');

            if (confirm(`เรียกลงเล่น:\nทีม 1: ${team1Names}\nทีม 2: ${team2Names}\nลงสนาม "${escapeHtml(availableCourts[0].name)}" หรือไม่?`)) {
                if (this.createMatch(availableCourts[0].id, queue.team1, queue.team2)) {
                    appState.matchQueues = appState.matchQueues.filter(q => q.id !== queueId);
                    saveState();
                    this.updateQueueDisplay();
                    this.renderCourtSelectDropdown('court-select-dropdown');
                }
            }
        },

        deleteQueue: function(queueId) {
            if (confirm(`ลบคิวเล่น #${queueId} ออกจากระบบ?`)) {
                appState.matchQueues = appState.matchQueues.filter(q => q.id !== queueId);
                saveState();
                this.updateQueueDisplay();
                this.renderQueueList();
                showSuccess('ลบคิวเล่นสำเร็จ');
            }
        },

        /**
         * Manual setup for queue
         */
        manualSetupQueueStart: function(queueId) {
            const queue = appState.matchQueues.find(q => q.id === queueId);
            if (!queue) {
                showError('ไม่พบคิวที่ระบุ');
                return;
            }

            // Check if all players are still available
            const queuePlayers = [...queue.team1, ...queue.team2];
            const allPlayersAvailable = queuePlayers.every(id => {
                const player = PlayerUtils.getById(id);
                return player && player.isCheckedIn && !player.isPlaying;
            });

            if (!allPlayersAvailable) {
                showError('ผู้เล่นบางคนในคิวนี้ไม่พร้อมเล่น');
                return;
            }

            const availableCourts = CourtUtils.getAvailable();
            if (availableCourts.length === 0) {
                showError('ไม่มีสนามว่างให้ใช้งาน');
                return;
            }

            // Show court selection
            const courtOptions = availableCourts.map((c, i) => `${i + 1}. ${c.name}`).join('\n');
            const selectedNum = prompt(`เลือกสนาม:\n${courtOptions}\n\nกรอกเลขที่:`);

            if (!selectedNum) return;

            const courtIndex = parseInt(selectedNum) - 1;
            if (courtIndex < 0 || courtIndex >= availableCourts.length) {
                showError('หมายเลขสนามไม่ถูกต้อง');
                return;
            }

            const courtId = availableCourts[courtIndex].id;
            if (this.createMatch(courtId, queue.team1, queue.team2)) {
                appState.matchQueues = appState.matchQueues.filter(q => q.id !== queueId);
                saveState();
                this.updateQueueDisplay();
                this.renderQueueList();
                this.renderMatchSetup();
            }
        },

        /**
         * Random shuffle for queue players
         */
        randomShuffleQueue: function(queueId) {
            const queue = appState.matchQueues.find(q => q.id === queueId);
            if (!queue) {
                showError('ไม่พบคิวที่ระบุ');
                return;
            }

            // Check if all players are still available
            const queuePlayers = [...queue.team1, ...queue.team2];
            const allPlayersAvailable = queuePlayers.every(id => {
                const player = PlayerUtils.getById(id);
                return player && player.isCheckedIn && !player.isPlaying;
            });

            if (!allPlayersAvailable) {
                showError('ผู้เล่นบางคนในคิวนี้ไม่พร้อมเล่น');
                return;
            }

            // Shuffle players
            const shuffled = [...queuePlayers].sort(() => 0.5 - Math.random());
            
            // Balance by skill
            shuffled.sort((a, b) => {
                const skillA = getSkillValue(PlayerUtils.getById(a)?.skill || 'N');
                const skillB = getSkillValue(PlayerUtils.getById(b)?.skill || 'N');
                return skillB - skillA;
            });

            queue.team1 = [shuffled[0], shuffled[3]];
            queue.team2 = [shuffled[1], shuffled[2]];

            saveState();
            this.renderQueueList();
            showSuccess('จับสลากคิวใหม่สำเร็จ');
        },

        manualSetupStart: function() {
            const courtId = document.getElementById('court-select-dropdown').value;
            if (!courtId) {
                showError('กรุณาเลือกสนามว่างก่อน');
                return;
            }

            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`ต้องมีผู้เล่นที่เช็คอินแล้วและว่างอยู่ ${MIN_PLAYERS_FOR_MATCH} คนขึ้นไป`);
                return;
            }

            const setupContentEl = document.getElementById('match-setup-content');
            setupContentEl.innerHTML = `
                <h3>สนาม ${escapeHtml(appState.courts.find(c => c.id == courtId).name)}</h3>
                <p>เลือกผู้เล่น 4 คนตามลำดับ (1-2 สำหรับทีม 1, 3-4 สำหรับทีม 2) <span id="selection-status" style="font-weight: bold; color: var(--secondary);">: เลือกคนที่ 1</span></p>
                <div id="manual-selection-grid" class="check-in-grid"></div>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button class="success" onclick="App.confirmManualMatch(${courtId})" id="btn-confirm-manual" disabled>ยืนยันคู่เล่นแบดมินตัน</button>
                    <button class="danger" onclick="App.renderMatchSetup()">ยกเลิก</button>
                </div>
            `;

            uiState.manualSelectionOrder = [];
            this.renderManualSelectionGrid(checkedInPlayers);
        },

        renderManualSelectionGrid: function(players) {
            const gridEl = document.getElementById('manual-selection-grid');
            const statusEl = document.getElementById('selection-status');
            const confirmBtn = document.getElementById('btn-confirm-manual');
            gridEl.innerHTML = '';

            players.forEach(player => {
                const skillClass = getSkillClass(player.skill);
                const gameCount = PlayerUtils.getGameCount(player.id);
                const isSelected = uiState.manualSelectionOrder.includes(player.id);
                const card = document.createElement('div');
                card.classList.add('check-in-card');
                if (isSelected) card.style.backgroundColor = '#e0f7fa';
                card.onclick = () => this.toggleManualSelection(player.id, players);

                let orderBadge = '';
                if (isSelected) {
                    const order = uiState.manualSelectionOrder.indexOf(player.id) + 1;
                    orderBadge = `<div style="position: absolute; top: 5px; right: 5px; background: var(--secondary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${order}</div>`;
                }

                card.innerHTML = `
                    ${orderBadge}
                    <div class="player-name">${escapeHtml(player.name)}</div>
                    <div class="player-skill"><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></div>
                    <div style="font-size: 0.8rem; color: #888;">${gameCount} เกม</div>
                `;
                gridEl.appendChild(card);
            });

            statusEl.textContent = `: เลือกคนที่ ${uiState.manualSelectionOrder.length + 1}`;
            confirmBtn.disabled = uiState.manualSelectionOrder.length !== 4;
        },

        toggleManualSelection: function(playerId, players) {
            const index = uiState.manualSelectionOrder.indexOf(playerId);
            if (index > -1) {
                uiState.manualSelectionOrder.splice(index, 1);
            } else if (uiState.manualSelectionOrder.length < 4) {
                uiState.manualSelectionOrder.push(playerId);
            }
            this.renderManualSelectionGrid(players);
        },

        confirmManualMatch: function(courtId) {
            if (uiState.manualSelectionOrder.length !== 4) {
                showError('กรุณาเลือกผู้เล่นให้ครบ 4 คน');
                return;
            }

            const team1Ids = [uiState.manualSelectionOrder[0], uiState.manualSelectionOrder[1]];
            const team2Ids = [uiState.manualSelectionOrder[2], uiState.manualSelectionOrder[3]];

            const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
            const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

            if (confirm(`คุณแน่ใจว่าต้องการจัดคู่:\nทีม 1: ${escapeHtml(team1Names)}\nทีม 2: ${escapeHtml(team2Names)}\nลงสนามหรือไม่?`)) {
                if (this.createMatch(courtId, team1Ids, team2Ids)) {
                    uiState.manualSelectionOrder = [];
                    this.renderCourtSelectDropdown('court-select-dropdown');
                }
            }
        },

        simpleRandomMatch: function() {
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`ต้องมีผู้เล่นที่เช็คอินแล้ว ${MIN_PLAYERS_FOR_MATCH} คน`);
                return;
            }

            const availableCourts = CourtUtils.getAvailable();
            if (availableCourts.length === 0) {
                showError('ไม่มีสนามว่างให้ใช้งาน');
                return;
            }

            const shuffledPlayers = checkedInPlayers.sort(() => 0.5 - Math.random());
            const selectedPlayers = shuffledPlayers.slice(0, 4);

            selectedPlayers.sort((a, b) =>
                getSkillValue(b.skill) - getSkillValue(a.skill)
            );

            const team1Ids = [selectedPlayers[0].id, selectedPlayers[3].id];
            const team2Ids = [selectedPlayers[1].id, selectedPlayers[2].id];

            const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
            const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

            const team1Skills = team1Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');
            const team2Skills = team2Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');

            if (confirm(`จับสลากได้คู่ (Balanced):\n\nทีม 1: ${escapeHtml(team1Names)}\n       (${team1Skills})\n\nทีม 2: ${escapeHtml(team2Names)}\n       (${team2Skills})\n\nลงสนามหรือไม่?`)) {
                if (this.createMatch(availableCourts[0].id, team1Ids, team2Ids)) {
                    this.renderCourtSelectDropdown('court-select-dropdown');
                }
            }
        },

        queueMatchStart: function() {
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`ต้องมีผู้เล่นที่เช็คอิน ${MIN_PLAYERS_FOR_MATCH} คนขึ้นไป`);
                return;
            }

            const playerStats = checkedInPlayers.map(p => ({
                id: p.id,
                name: p.name,
                skillValue: getSkillValue(p.skill),
                gameCount: PlayerUtils.getGameCount(p.id)
            }));

            playerStats.sort((a, b) => a.gameCount - b.gameCount);

            const top4 = playerStats.slice(0, 4);
            top4.sort((a, b) => a.skillValue - b.skillValue);

            const team1Ids = [top4[0].id, top4[3].id];
            const team2Ids = [top4[1].id, top4[2].id];

            const team1Names = team1Ids.map(id => escapeHtml(PlayerUtils.getById(id).name)).join(' & ');
            const team2Names = team2Ids.map(id => escapeHtml(PlayerUtils.getById(id).name)).join(' & ');

            if (confirm(`เพิ่มคิวรอเล่น (เกมต่ำสุด):\nทีม 1: ${team1Names}\nทีม 2: ${team2Names}\n\nต้องการเพิ่มเข้าคิวหรือไม่?`)) {
                this.addToQueue(team1Ids, team2Ids);
                this.switchToQueueTab();
            }
        },

        /**
         * Create random queue
         */
        queueRandomStart: function() {
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`ต้องมีผู้เล่นที่เช็คอิน ${MIN_PLAYERS_FOR_MATCH} คนขึ้นไป`);
                return;
            }

            const shuffledPlayers = checkedInPlayers.sort(() => 0.5 - Math.random());
            const selectedPlayers = shuffledPlayers.slice(0, 4);

            selectedPlayers.sort((a, b) =>
                getSkillValue(b.skill) - getSkillValue(a.skill)
            );

            const team1Ids = [selectedPlayers[0].id, selectedPlayers[3].id];
            const team2Ids = [selectedPlayers[1].id, selectedPlayers[2].id];

            const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
            const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

            const team1Skills = team1Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');
            const team2Skills = team2Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');

            if (confirm(`เพิ่มคิวรอเล่น (จับสลากสุ่ม):\n\nทีม 1: ${escapeHtml(team1Names)}\n       (${team1Skills})\n\nทีม 2: ${escapeHtml(team2Names)}\n       (${team2Skills})\n\nต้องการเพิ่มเข้าคิวหรือไม่?`)) {
                this.addToQueue(team1Ids, team2Ids);
                this.switchToQueueTab();
            }
        },

        /**
         * Create match and start timer
         */
        createMatch: function(courtId, team1Ids, team2Ids) {
            if (!courtId || team1Ids.length !== 2 || team2Ids.length !== 2) {
                showError('ข้อมูลเกมไม่ครบถ้วน');
                return false;
            }

            const court = CourtUtils.getById(courtId);
            if (!court || court.status !== 'free') {
                showError('สนามไม่ว่างหรือไม่พบ');
                return false;
            }

            // Use new shuttle if available
            if (appState.shuttlecocks.newInPlay < 1) {
                showError('ลูกแบดพร้อมใช้ไม่พอ');
                return false;
            }

            appState.shuttlecocks.newInPlay -= 1;

            const matchId = appState.nextId.match++;
            const newMatch = {
                id: matchId,
                courtId: courtId,
                courtName: court.name,
                team1: team1Ids,
                team2: team2Ids,
                startTime: Date.now(),
                newShuttleUsed: 1,
                practiceShuttleUsed: 0
            };

            appState.matches.push(newMatch);
            court.status = 'playing';
            court.currentMatchId = matchId;

            [...team1Ids, ...team2Ids].forEach(playerId => {
                const player = PlayerUtils.getById(playerId);
                if (player) {
                    player.isPlaying = true;
                }
            });

            saveState();
            this.renderActiveMatches();
            this.renderCheckInList();
            this.renderDashboard();
            this.showView('active-matches');
            showSuccess(`จัดคู่สำเร็จ! สนาม ${escapeHtml(court.name)}`);
            return true;
        },

        /**
         * Active matches
         */
        renderActiveMatches: function() {
            const listEl = document.getElementById('active-matches-list');
            listEl.innerHTML = '';

            if (appState.matches.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888;">ไม่มีสนามที่กำลังแข่งขัน</p>';
                return;
            }

            appState.matches.forEach(match => {
                const team1Names = match.team1.map(id => PlayerUtils.getById(id)?.name || '???').join(' & ');
                const team2Names = match.team2.map(id => PlayerUtils.getById(id)?.name || '???').join(' & ');

                const team1Skills = match.team1.map(id => PlayerUtils.getById(id)?.skill || '?');
                const team2Skills = match.team2.map(id => PlayerUtils.getById(id)?.skill || '?');

                const card = document.createElement('div');
                card.classList.add('match-card');
                card.dataset.matchId = match.id;

                card.innerHTML = `
                    <h3>สนาม ${escapeHtml(match.courtName)}</h3>
                    <div class="timer" id="match-timer-${match.id}">00:00</div>
                    <div class="match-teams">
                        <div class="team">
                            <h4>ทีม 1</h4>
                            <p>${escapeHtml(team1Names)}</p>
                            <p>${team1Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</p>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team">
                            <h4>ทีม 2</h4>
                            <p>${escapeHtml(team2Names)}</p>
                            <p>${team2Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</p>
                        </div>
                    </div>

                    <div class="court-shuttle-control">
                        <div class="shuttle-control-item">
                            <span style="font-weight: bold; color: var(--primary);">ลูกใหม่:</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'new', -1)">-</button>
                            <span style="font-weight: bold; font-size: 1.2rem; min-width: 30px; text-align: center;" id="match-shuttle-new-${match.id}">${match.newShuttleUsed}</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'new', 1)">+</button>
                        </div>
                        <div class="shuttle-control-item">
                            <span style="font-weight: bold; color: var(--primary);">ลูกซ้อม:</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'practice', -1)">-</button>
                            <span style="font-weight: bold; font-size: 1.2rem; min-width: 30px; text-align: center;" id="match-shuttle-practice-${match.id}">${match.practiceShuttleUsed}</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'practice', 1)">+</button>
                        </div>
                    </div>

                    <h4 style="margin-top: 1.5rem; text-align: center;">ใครชนะ?</h4>
                    <div class="match-controls">
                        <button class="success" onclick="App.recordMatchResult(${match.id}, 1)">ทีม 1 ชนะ</button>
                        <button style="background-color: #f1c40f; color: var(--dark);" onclick="App.recordMatchResult(${match.id}, 0)">เสมอ</button>
                        <button class="success" onclick="App.recordMatchResult(${match.id}, 2)">ทีม 2 ชนะ</button>
                    </div>
                    <div class="match-controls" style="margin-top: 1rem;">
                        <button class="danger" onclick="App.cancelMatch(${match.id})">ยกเลิกแมตช์</button>
                    </div>
                `;
                listEl.appendChild(card);
                startTimer(match.id, card);
            });
            this.updateShuttleDisplay();
            this.renderDashboard();
        },

        updateMatchShuttleUsed: function(matchId, type, amount) {
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) {
                showError('ไม่พบข้อมูลเกม');
                return;
            }

            if (type === 'new') {
                if (match.newShuttleUsed + amount >= 0) {
                    match.newShuttleUsed += amount;
                    document.getElementById(`match-shuttle-new-${matchId}`).textContent = match.newShuttleUsed;
                } else {
                    showError('จำนวนลูกแบดใหม่ต้องไม่ติดลบ');
                    return;
                }
            } else if (type === 'practice') {
                if (match.practiceShuttleUsed + amount >= 0) {
                    match.practiceShuttleUsed += amount;
                    document.getElementById(`match-shuttle-practice-${matchId}`).textContent = match.practiceShuttleUsed;
                } else {
                    showError('จำนวนลูกแบดซ้อมต้องไม่ติดลบ');
                    return;
                }
            }

            saveState();
        },

        recordMatchResult: function(matchId, winningTeam) {
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) {
                showError('ไม่พบข้อมูลเกม');
                return;
            }

            if (![0, 1, 2].includes(winningTeam)) {
                showError('ผลการแข่งไม่ถูกต้อง');
                return;
            }

            const gameResult = {
                id: appState.nextId.match++,
                matchId: matchId,
                courtId: match.courtId,
                startTime: match.startTime,
                endTime: Date.now(),
                duration: Date.now() - match.startTime,
                team1: match.team1,
                team2: match.team2,
                winner: winningTeam,
                newShuttleUsed: match.newShuttleUsed,
                practiceShuttleUsed: match.practiceShuttleUsed
            };

            const allPlayers = [...match.team1, ...match.team2];
            allPlayers.forEach(playerId => {
                if (!appState.history[playerId]) {
                    appState.history[playerId] = { games: [] };
                }
                appState.history[playerId].games.push(gameResult);
            });

            this.endMatch(matchId);
            saveState();

            const resultText = winningTeam === 1 ? 'ทีม 1 ชนะ' : winningTeam === 2 ? 'ทีม 2 ชนะ' : 'เสมอ';
            showSuccess(`บันทึกผล: ${resultText}`);
        },

        endMatch: function(matchId) {
            const matchIndex = appState.matches.findIndex(m => m.id === matchId);
            if (matchIndex === -1) return;

            const match = appState.matches[matchIndex];

            stopTimer(matchId);

            const allPlayers = [...match.team1, ...match.team2];
            allPlayers.forEach(playerId => {
                const player = PlayerUtils.getById(playerId);
                if (player) {
                    player.isPlaying = false;
                }
            });

            const court = CourtUtils.getById(match.courtId);
            if (court) {
                court.status = 'free';
                delete court.currentMatchId;
            }

            appState.matches.splice(matchIndex, 1);

            saveState();
            this.renderActiveMatches();
            this.renderCheckInList();
            this.renderDashboard();
            this.renderCourtList();
            this.renderMatchSetup();
        },

        cancelMatch: function(matchId) {
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) return;

            if (confirm(`ยกเลิกแมตช์สนาม ${escapeHtml(match.courtName)}?`)) {
                appState.shuttlecocks.newInPlay += 1;
                this.endMatch(matchId);
                showSuccess(`ยกเลิกแมตช์สนาม ${escapeHtml(match.courtName)} สำเร็จ`);
            }
        },

        /**
         * Player history modal
         */
        openPlayerHistoryModal: function(playerId) {
            const player = PlayerUtils.getById(playerId);
            const history = appState.history[playerId];

            if (!player || !history || history.games.length === 0) {
                showError('ไม่พบประวัติการเล่น');
                return;
            }

            document.getElementById('modal-player-name').textContent = `ประวัติการเล่นผู้เล่น ${escapeHtml(player.name)}`;

            const statsHtml = this.getPlayerStatsHtml(playerId, player, history);
            document.getElementById('modal-player-stats').innerHTML = statsHtml;

            const timelineHtml = this.getPlayerTimelineHtml(playerId, history);
            document.getElementById('modal-game-records').innerHTML = timelineHtml;

            document.getElementById('player-history-modal').classList.add('active');
        },

        closePlayerHistoryModal: function() {
            document.getElementById('player-history-modal').classList.remove('active');
        },

        getPlayerStatsHtml: function(playerId, player, history) {
            const gamesPlayed = history.games.length;

            const wins = history.games.filter(g => {
                const isTeam1 = g.team1?.includes(playerId);
                const isTeam2 = g.team2?.includes(playerId);

                if (isTeam1 && g.winner === 1) return true;
                if (isTeam2 && g.winner === 2) return true;
                return false;
            }).length;

            const draws = history.games.filter(g => g.winner === 0).length;
            const losses = gamesPlayed - wins - draws;

            const winRate = gamesPlayed > 0 ? ((wins / gamesPlayed) * 100).toFixed(1) : 0;

            return `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                        ${escapeHtml(player.name)} 
                        <span style="font-size: 0.8rem; background: var(--secondary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">${escapeHtml(player.skill)}</span>
                    </h4>
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="value">${gamesPlayed}</div>
                            <div class="label">เกมทั้งหมด</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--success);">
                            <div class="value" style="color: var(--success);">${wins}</div>
                            <div class="label">ชนะ</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--accent);">
                            <div class="value" style="color: var(--accent);">${draws}</div>
                            <div class="label">เสมอ</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--danger);">
                            <div class="value" style="color: var(--danger);">${losses}</div>
                            <div class="label">แพ้</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--primary);">
                            <div class="value">${winRate}%</div>
                            <div class="label">อัตราชนะ</div>
                        </div>
                    </div>
                </div>
            `;
        },

        getPlayerTimelineHtml: function(playerId, history) {
            const recentGames = history.games.slice().reverse();

            const timelineHTML = recentGames.map((game, index) => {
                const myTeam = game.team1?.includes(playerId) ? 1 : 2;
                const opponentTeam = myTeam === 1 ? game.team2 : game.team1;
                const opponentNames = opponentTeam.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');
                const myTeammates = (myTeam === 1 ? game.team1 : game.team2).filter(id => id !== playerId).map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');

                let resultClass = 'draw';
                let resultText = '🤝 เสมอ';
                let dotIcon = '➖';

                if ((myTeam === 1 && game.winner === 1) || (myTeam === 2 && game.winner === 2)) {
                    resultClass = 'win';
                    resultText = '✅ ชนะ';
                    dotIcon = '✓';
                } else if ((myTeam === 1 && game.winner === 2) || (myTeam === 2 && game.winner === 1)) {
                    resultClass = 'loss';
                    resultText = '❌ แพ้';
                    dotIcon = '✗';
                }

                const timeAgo = formatDate(game.startTime);
                const duration = formatTime(game.duration);

                return `
                    <div class="timeline-item">
                        <div class="timeline-dot ${resultClass}">${dotIcon}</div>
                        <div class="timeline-content ${resultClass}">
                            <div class="timeline-header">
                                <div class="timeline-title">vs ${opponentNames}</div>
                                <span class="timeline-result ${resultClass}">${resultText}</span>
                            </div>
                            <div class="timeline-opponents">
                                <strong>คู่เล่น:</strong> ${myTeammates || '-'}
                            </div>
                            <div class="timeline-meta">
                                <span>🕐 ${timeAgo}</span>
                                <span>⏱️ ${duration}</span>
                                <span>🏸 ลูก: ${game.newShuttleUsed} (ใหม่) + ${game.practiceShuttleUsed} (ซ้อม)</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                    <h4 style="color: var(--primary); margin: 0 0 1rem 0;">📊 ประวัติแข่ง (${history.games.length} เกม)</h4>
                    <div class="timeline">${timelineHTML}</div>
                </div>
            `;
        }
    };

    // ============================================================
    // EVENT LISTENERS WITH SUBMIT STATE PROTECTION
    // ============================================================

    /**
     * Helper to prevent double submit
     */
    function createSubmitHandler(callback) {
        return function(e) {
            e.preventDefault();
            
            if (uiState.isProcessing) return;
            
            uiState.isProcessing = true;
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
            
            try {
                callback.call(this);
            } catch (error) {
                console.error('Submit error:', error);
                showError('เกิดข้อผิดพลาดกรุณาลองใหม่');
            } finally {
                uiState.isProcessing = false;
                if (submitBtn) submitBtn.disabled = false;
            }
        };
    }

    // Add player form
    document.getElementById('add-player-form')?.addEventListener('submit', createSubmitHandler(function() {
        const name = document.getElementById('player-name').value;
        const skill = document.getElementById('player-skill').value;
        const result = App.addPlayer(name, skill);

        if (result.success) {
            saveState();
            App.renderPlayerList();
            document.getElementById('player-name').value = '';
            showSuccess(`เพิ่ม ${escapeHtml(result.player.name)} สำเร็จ`);
        } else {
            showError(result.error);
        }
    }));

    // Bulk add form
    document.getElementById('bulk-add-form')?.addEventListener('submit', createSubmitHandler(function() {
        const namesText = document.getElementById('bulk-names').value;
        const skill = document.getElementById('bulk-skill').value;
        
        if (!namesText.trim()) {
            showError('ไม่มีรายชื่อที่ต้องเพิ่ม');
            return;
        }

        if (!validateSkill(skill)) {
            showError('ระดับมือไม่ถูกต้อง');
            return;
        }

        const names = namesText.split('\n').map(n => n.trim()).filter(n => n.length > 0);

        if (names.length === 0) {
            showError('ไม่มีชื่อผู้เล่นที่ถูกต้อง');
            return;
        }

        const added = [];
        const duplicates = [];
        const failed = [];

        names.forEach(name => {
            if (appState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                duplicates.push(name);
                return;
            }
            const result = App.addPlayer(name, skill);
            if (result.success) {
                added.push(name);
            } else {
                failed.push(`${name} (${result.error})`);
            }
        });

        saveState();
        App.renderPlayerList();

        let summary = `📊 สรุปการเพิ่มผู้เล่น\n`;
        if (added.length > 0) summary += `✅ เพิ่มสำเร็จ: ${added.length} คน\n`;
        if (duplicates.length > 0) summary += `⚠️ ชื่อซ้ำ: ${duplicates.length} คน\n`;
        if (failed.length > 0) summary += `❌ ล้มเหลว: ${failed.length} คน\n`;
        summary += `""""""""""""""""""\nรวมทั้งสิ้น: ${names.length} คน`;

        alert(summary);
        document.getElementById('bulk-names').value = '';
    }));

    // Player search
    document.getElementById('player-search')?.addEventListener('input', function(e) {
        App.renderPlayerList(e.target.value);
    });

    // Bulk edit form
    document.getElementById('bulk-edit-form')?.addEventListener('submit', createSubmitHandler(function() {
        const newSkill = document.getElementById('bulk-edit-skill').value;

        if (!validateSkill(newSkill)) {
            showError('ระดับมือไม่ถูกต้อง');
            return;
        }

        const checkboxes = document.querySelectorAll('#bulk-edit-list input[type="checkbox"]:checked');

        if (checkboxes.length === 0) {
            showError('กรุณาเลือกผู้เล่นอย่างน้อยหนึ่งคน');
            return;
        }

        let updatedCount = 0;
        checkboxes.forEach(checkbox => {
            const playerId = parseInt(checkbox.dataset.playerId);
            const player = PlayerUtils.getById(playerId);
            if (player && player.skill !== newSkill) {
                player.skill = String(newSkill);
                updatedCount++;
            }
        });

        if (updatedCount > 0) {
            saveState();
            App.renderPlayerList(uiState.currentFilter);
            showSuccess(`อัปเดตระดับมือผู้เล่น ${updatedCount} คนเป็น ${newSkill}`);
        } else {
            showWarning('ผู้เล่นที่เลือกมีระดับมือนี้อยู่แล้ว');
        }
    }));

    // Add court form
    document.getElementById('add-court-form')?.addEventListener('submit', createSubmitHandler(function() {
        const name = document.getElementById('court-name').value;
        if (App.addCourt(name)) {
            document.getElementById('court-name').value = '';
        }
    }));

    // Live shuttle form
    document.getElementById('live-shuttle-form')?.addEventListener('submit', createSubmitHandler(function() {
        const action = document.getElementById('live-shuttle-action').value;
        const amount = document.getElementById('live-shuttle-amount').value;
        
        const type = action.includes('remove') ? 'practice' : action.includes('practice') ? 'practice' : 'new';
        const actualAction = action.includes('remove') ? 'remove' : 'add';
        
        App.updateGlobalShuttlecocks(actualAction, type, amount);
        document.getElementById('live-shuttle-amount').value = '1';
    }));

    // Settings shuttle form
    document.getElementById('settings-shuttle-form')?.addEventListener('submit', createSubmitHandler(function() {
        const action = document.getElementById('settings-shuttle-action').value;
        const amount = document.getElementById('settings-shuttle-amount').value;
        
        const type = action.includes('practice') ? 'practice' : 'new';
        App.updateGlobalShuttlecocks('add', type, amount);
        document.getElementById('settings-shuttle-amount').value = '1';
    }));

    // Modal close
    document.getElementById('player-history-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            App.closePlayerHistoryModal();
        }
    });

    // ============================================================
    // INITIALIZATION & CLEANUP
    // ============================================================

    window.addEventListener('load', function() {
        loadState();
        App.showView('dashboard');
    });

    window.addEventListener('beforeunload', function() {
        cleanupAllTimers();
        saveState();
    });

    // Auto save state periodically
    let autoSaveTimer;
    window.addEventListener('change', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveState();
        }, 2000);
    });
</script>
</body>
</html>