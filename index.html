<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô</title>
    <style>
        :root {
            --primary: #1a2b47;
            --secondary: #00a8cc;
            --accent: #f39c12;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a3c;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light);
            margin: 0;
            padding: 0;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        nav {
            background-color: var(--white);
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav button {
            background-color: transparent;
            color: var(--dark);
            border: none;
            padding: 1rem 1.2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        nav button:hover, nav button.active {
            background-color: rgba(0, 168, 204, 0.1);
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        main {
            padding: 1.5rem 0;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--light);
            padding-bottom: 0.75rem;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .card h3 {
            color: var(--secondary);
            margin-top: 1.5rem;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        form div {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 168, 204, 0.2);
        }

        button {
            background-color: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            min-height: 48px;
        }

        button:hover:not(:disabled) {
            background-color: #0089a9;
            transform: translateY(-2px);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.danger { background-color: var(--danger); }
        button.danger:hover:not(:disabled) { background-color: #c0392b; }
        button.success { background-color: var(--success); }
        button.success:hover:not(:disabled) { background-color: #229954; }
        button.warning { background-color: var(--accent); }
        button.warning:hover:not(:disabled) { background-color: #e67e22; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover:not(:disabled) { background-color: #5a6268; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background-color: var(--light);
        }

        table th {
            background-color: var(--light);
            font-weight: bold;
            color: var(--primary);
        }

        .skill-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            color: var(--white);
            font-size: 0.8rem;
            font-weight: bold;
        }

        .skill-P { background-color: var(--success); }
        .skill-Nminus { background-color: #2c3e50; }
        .skill-N { background-color: var(--secondary); }
        .skill-Nplus { background-color: #e67e22; }
        .skill-BG { background-color: #95a5a6; }

        .check-in-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        .check-in-card {
            background-color: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .check-in-card:hover:not(.checked-in) {
            border-color: var(--secondary);
            transform: scale(1.05);
        }

        .check-in-card.checked-in {
            background-color: #e8f5e9;
            border-color: var(--success);
            cursor: default;
        }

        .check-in-card.playing-now {
            background-color: #fff3e0;
            border-color: var(--accent);
        }

        .check-in-card .player-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .check-in-card .status-icon {
            font-size: 1.5rem;
            margin-top: 0.5rem;
        }

        .match-card {
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--secondary);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--white);
        }

        .match-card h3 { margin-top: 0; }
        .match-teams { display: flex; justify-content: space-around; align-items: center; margin: 1.5rem 0; flex-wrap: wrap; gap: 1rem; }
        .team { text-align: center; min-width: 120px; }
        .team p { margin: 0.25rem 0; word-break: break-word; }
        .vs { font-size: 1.5rem; font-weight: bold; color: #888; }
        .match-controls { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .timer { font-size: 1.8rem; font-weight: bold; color: var(--primary); text-align: center; margin: 1rem 0; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .dashboard-card {
            background: linear-gradient(135deg, var(--white), var(--light));
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-card .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .dashboard-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .dashboard-card .label {
            color: var(--dark);
            font-weight: 500;
        }

        .dashboard-player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
        }

        .dashboard-player-card {
            background-color: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: box-shadow 0.3s;
            cursor: pointer;
        }

        .dashboard-player-card:hover {
            box-shadow: var(--shadow);
        }

        .dashboard-player-card .player-name {
            font-weight: 600;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .dashboard-player-card .player-skill {
            font-size: 0.7rem;
            margin: 0.25rem 0;
        }

        .dashboard-player-card .game-count {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .timeline {
            position: relative;
            padding: 1.5rem 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 35px;
            width: 2px;
            height: calc(100% + 10px);
            background-color: #e0e0e0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: relative;
            z-index: 1;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 1rem;
            border: 3px solid var(--white);
            box-shadow: 0 0 0 2px;
        }

        .timeline-dot.win {
            background-color: #e8f5e9;
            color: var(--success);
            box-shadow: 0 0 0 2px var(--success);
        }

        .timeline-dot.loss {
            background-color: #ffebee;
            color: var(--danger);
            box-shadow: 0 0 0 2px var(--danger);
        }

        .timeline-dot.draw {
            background-color: #fff3e0;
            color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .timeline-content {
            flex: 1;
            background-color: var(--light);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #e0e0e0;
        }

        .timeline-content.win {
            border-left-color: var(--success);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .timeline-content.loss {
            border-left-color: var(--danger);
            background-color: rgba(231, 76, 60, 0.05);
        }

        .timeline-content.draw {
            border-left-color: var(--accent);
            background-color: rgba(243, 156, 18, 0.05);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .timeline-result {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .timeline-result.win {
            background-color: var(--success);
        }

        .timeline-result.loss {
            background-color: var(--danger);
        }

        .timeline-result.draw {
            background-color: var(--accent);
        }

        .timeline-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #666;
            flex-wrap: wrap;
        }

        .timeline-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .timeline-opponents {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .timeline-opponents strong {
            color: var(--primary);
        }

        .stats-row {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            min-width: 150px;
            background-color: var(--white);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-box .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-box .label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .shuttle-counter {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .shuttle-counter div {
            text-align: center;
        }

        .shuttle-counter .count {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .court-shuttle-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0.75rem;
            background-color: #f0f8ff;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .shuttle-control-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .court-shuttle-control button {
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            min-height: auto;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
        }

        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary);
            font-size: 1.1rem;
            word-break: break-word;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
            padding: 0;
            min-height: auto;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }

        .toast {
            background-color: var(--white);
            border-left: 4px solid var(--secondary);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--accent);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .bulk-edit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 4px;
        }

        .bulk-edit-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .bulk-edit-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }

        .queue-card {
            background-color: var(--white);
            border: 2px solid #e0e0e0;
            border-left: 5px solid var(--secondary);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .queue-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .queue-card.created-just-now {
            border-left-color: var(--success);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .queue-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .queue-card-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .queue-card-number {
            background-color: var(--secondary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .queue-card-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .queue-team {
            text-align: center;
        }

        .queue-team h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .queue-team-players {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .queue-team-skills {
            font-size: 0.8rem;
            color: #888;
        }

        .queue-vs {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #ccc;
        }

        .queue-card-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #666;
            flex-wrap: wrap;
        }

        .queue-card-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .queue-card-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .queue-card-actions button {
            min-width: auto;
            font-size: 0.8rem;
            padding: 0.6rem 0.5rem;
        }

        .queue-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: #888;
        }

        .queue-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            color: #888;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            min-height: auto;
            transform: none;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--secondary);
        }

        .tab-btn.active {
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .quick-actions button {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            header h1 { font-size: 1.5rem; }
            nav button { padding: 0.8rem 0.5rem; font-size: 0.9rem; }
            .card { padding: 1rem; }
            .modal-content { width: 95%; padding: 1rem; }
            .timeline-item { margin-bottom: 1rem; }
            .timeline-dot { width: 28px; height: 28px; }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <header>
        <div class="container">
            <h1>üè∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô üè∏</h1>
        </div>
    </header>

    <nav>
        <button onclick="App.showView('dashboard')" class="active">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        <button onclick="App.showView('player-management')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
        <button onclick="App.showView('check-in')">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</button>
        <button onclick="App.showView('match-setup')">‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà/‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å</button>
        <button onclick="App.showView('active-matches')">‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô</button>
        <button onclick="App.showView('settings')">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button onclick="App.showView('manager-tools')">‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
    </nav>

    <main class="container">
        <!-- DASHBOARD VIEW -->
        <section id="dashboard" class="view active">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="icon">üë•</div>
                    <div class="value" id="dash-total-players">0</div>
                    <div class="label">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">‚úÖ</div>
                    <div class="value" id="dash-checked-in">0</div>
                    <div class="label">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">üèêÔ∏è</div>
                    <div class="value" id="dash-active-matches">0</div>
                    <div class="label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">üè∏</div>
                    <div class="value" id="dash-shuttle-in-play">0</div>
                    <div class="label">‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</div>
                </div>
            </div>

            <div class="card">
                <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</h3>
                <div id="dashboard-player-list" class="dashboard-player-list"></div>
            </div>

            <div class="card">
                <h3>üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h3>
                <p style="font-size: 0.9rem; color: #888;">‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ö‡πà‡∏≠‡∏¢</p>
                <div id="frequent-partners-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
            </div>

            <div class="card">
                <h3>‚öîÔ∏è ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</h3>
                <p style="font-size: 0.9rem; color: #888;">‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏ö‡πà‡∏≠‡∏¢</p>
                <div id="frequent-opponents-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
            </div>

            <div class="quick-actions">
                <button class="success" onclick="App.navigateAndShow('player-management')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
                <button class="warning" onclick="App.navigateAndShow('match-setup')">üé≤ ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô</button>
                <button onclick="App.navigateAndShow('active-matches')">‚è±Ô∏è ‡∏î‡∏π‡∏™‡∏ô‡∏≤‡∏°</button>
            </div>
        </section>

        <!-- PLAYER MANAGEMENT VIEW -->
        <section id="player-management" class="view">
            <div class="card">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</h2>
                <form id="add-player-form">
                    <div>
                        <label for="player-name">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
                        <input type="text" id="player-name" required maxlength="50">
                    </div>
                    <div>
                        <label for="player-skill">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠:</label>
                        <select id="player-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" id="btn-add-player">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏° (‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</h2>
                <p>‡∏Ñ‡∏±‡πà‡∏ô‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ)</p>
                <form id="bulk-add-form">
                    <div style="width: 100%;">
                        <label for="bulk-names">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠:</label>
                        <textarea id="bulk-names" rows="5" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢&#10;‡∏™‡∏°‡∏®‡∏£‡∏µ&#10;‡∏™‡∏°‡∏´‡∏á‡∏∂‡πà‡∏á"></textarea>
                    </div>
                    <div>
                        <label for="bulk-skill">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô):</label>
                        <select id="bulk-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success" id="btn-bulk-add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <input type="text" id="player-search" class="search-bar" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...">
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
                                <th style="width: 100px;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠</th>
                                <th>‡πÄ‡∏Å‡∏°</th>
                                <th style="width: 300px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="player-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="card bulk-edit-section">
                <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°</h3>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</p>
                <div class="bulk-edit-list" id="bulk-edit-list"></div>
                <form id="bulk-edit-form">
                    <div>
                        <label for="bulk-edit-skill">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà:</label>
                        <select id="bulk-edit-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N">N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success" id="btn-bulk-edit">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- CHECK-IN VIEW -->
        <section id="check-in" class="view">
            <div class="card">
                <h2>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
                <p>‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏° üè∏ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô üè∏)</p>
                <div id="check-in-list" class="check-in-grid"></div>
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="danger" onclick="App.resetAllCheckIns()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>
        </section>

        <!-- MATCH SETUP VIEW -->
        <section id="match-setup" class="view">
            <div class="card">
                <h2>üéÆ ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô</h2>
                
                <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid var(--light);">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                        <span>üéÆ ‡∏™‡∏î‡πÉ‡∏à‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà</span>
                        <small style="color: #888; font-weight: normal; font-size: 0.75rem;">(‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</small>
                    </h3>
                    
                    <div id="match-setup-controls">
                        <!-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏£‡∏Å: ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏° -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; color: var(--primary);">‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <label for="court-select-dropdown" style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">üõèÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°:</label>
                                    <select id="court-select-dropdown" style="width: 100%;"></select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">&nbsp;</label>
                                    <button class="warning" onclick="App.manualSetupStart()" id="btn-manual-setup" style="width: 100%; min-height: 42px;">üñäÔ∏è ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á</button>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">&nbsp;</label>
                                    <button class="success" onclick="App.simpleRandomMatch()" id="btn-random-setup" style="width: 100%; min-height: 42px;" disabled>üé≤ ‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡∏™‡∏∏‡πà‡∏°</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="match-setup-content">
                        <p style="color: #888; font-size: 0.9rem; margin: 0; padding: 0.75rem; background-color: var(--light); border-radius: 8px; border-left: 3px solid var(--secondary);">üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ "‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô</p>
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                        <span>‚è≥ ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
                        <span id="queue-badge" style="background-color: var(--secondary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">0</span>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <button class="success" onclick="App.queueMatchStart()" id="btn-queue-setup" style="width: 100%; min-height: 42px;" disabled>
                            ‚ûï ‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏ö‡∏ö‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î
                        </button>
                        <button class="success" onclick="App.queueRandomStart()" id="btn-queue-random" style="width: 100%; min-height: 42px;" disabled>
                            üé≤ ‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
                        </button>
                        
                        <button class="success" onclick="App.queueManualStart()" id="btn-queue-manual" style="width: 100%; min-height: 42px;" disabled>
                            üß© ‡∏Ñ‡∏¥‡∏ß‡∏à‡∏±‡∏î‡πÄ‡∏≠‡∏á
                        </button>
<button class="secondary" onclick="App.switchToQueueTab()" id="btn-view-queue" style="width: 100%; min-height: 42px;" disabled>
                            üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß
                        </button>
                    </div>

                    <div id="queue-setup-tab" style="display: none;">
                        <div style="margin-bottom: 1.5rem; padding: 0.75rem; background-color: var(--light); border-radius: 8px; border-left: 3px solid var(--danger);">
                            <p style="color: #888; margin: 0; font-size: 0.9rem;">üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô</p>
                        </div>
                        <div id="queue-list" style="display: grid; gap: 1rem;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACTIVE MATCHES VIEW -->
        <section id="active-matches" class="view">
            <div class="card">
                <h2>‡∏™‡∏ï‡∏±‡∏ü‡∏≠‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</h2>
                <div class="shuttle-counter">
                    <div>
                        <div class="count" id="live-shuttle-in-play">0</div>
                        <div>‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ)</div>
                    </div>
                    <div>
                        <div class="count" id="live-shuttle-practice">0</div>
                        <div>‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏ã‡πâ‡∏≠‡∏° (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ)</div>
                    </div>
                </div>
                <form id="live-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="live-shuttle-action">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡∏±‡∏ü:</label>
                        <select id="live-shuttle-action">
                            <option value="add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡∏±‡∏ü)</option>
                            <option value="add-practice">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡∏±‡∏ü)</option>
                            <option value="remove">‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡∏ó‡∏¥‡πâ‡∏á)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="live-shuttle-amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                        <input type="number" id="live-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit" id="btn-update-shuttle">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô</h2>
                <p style="color: var(--secondary); font-weight: bold;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡∏ß‡πâ‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°) ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ 1 ‡∏•‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏°‡∏ï‡∏ä‡πå</p>
                <div id="active-matches-list"></div>
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="settings" class="view">
            <div class="card">
                <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏°</h2>
                <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°</h3>
                <form id="add-court-form">
                    <div>
                        <label for="court-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏≤‡∏°:</label>
                        <input type="text" id="court-name" required maxlength="50">
                    </div>
                    <div>
                        <button type="submit" id="btn-add-court">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏≤‡∏°</button>
                    </div>
                </form>
                <div id="court-list" style="margin-top: 20px;"></div>
            </div>
            <div class="card">
                <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î</h3>
                <div class="shuttle-counter">
                    <div>
                        <div class="count" id="settings-shuttle-new">0</div>
                        <div>‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ)</div>
                    </div>
                    <div>
                        <div class="count" id="settings-shuttle-practice">0</div>
                        <div>‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏ã‡πâ‡∏≠‡∏° (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ)</div>
                    </div>
                </div>
                <form id="settings-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="settings-shuttle-action">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥:</label>
                        <select id="settings-shuttle-action">
                            <option value="add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡∏±‡∏ü)</option>
                            <option value="add-practice">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡∏±‡∏ü)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="settings-shuttle-amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                        <input type="number" id="settings-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit" id="btn-settings-shuttle">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- MANAGER TOOLS VIEW -->
        <section id="manager-tools" class="view">
            <div class="card">
                <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>

                <h3>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <p style="color: var(--danger); font-weight: bold;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;"><button class="danger" onclick="App.clearAllPlayers()">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
<button class="warning" onclick="App.clearAllHistory()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>
            </div>
        </section>
    </main>

    <!-- PLAYER HISTORY MODAL -->
    <div id="player-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-player-name">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
                <button class="close-modal" onclick="App.closePlayerHistoryModal()">‚úï</button>
            </div>
            <div id="modal-player-stats"></div>
            <div id="modal-game-records"></div>
        </div>
    </div>

<script>
    /**
     * ========================================================
     * REFACTORED BADMINTON COURT MANAGEMENT SYSTEM
     * ========================================================
     * Improvements:
     * 1. Fixed memory leaks with proper timer cleanup
     * 2. Enhanced validation with regex and bounds checking
     * 3. Separated shuttle management (new vs practice)
     * 4. Better error handling with fallback states
     * 5. Fixed race conditions with submit state
     * 6. Improved state persistence and recovery
     * ========================================================
     */

    // ============================================================
    // CONSTANTS & CONFIG
    // ============================================================

    const SKILL_VALUES = { 'BG': 1, 'N-': 2, 'N': 3, 'N+': 4, 'P': 5 };
    const SKILLS_LIST = ['BG', 'N-', 'N', 'N+', 'P'];
    const STORAGE_KEY = 'badmintonAppState';
    const MAX_NAME_LENGTH = 50;
    const MIN_PLAYERS_FOR_MATCH = 4;
    const STORAGE_WARNING_THRESHOLD = 90; // percentage

    // ============================================================
    // UTILITY - SECURITY & VALIDATION
    // ============================================================

    /**
     * HTML escape to prevent XSS attacks
     */
    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    /**
     * Sanitize input and validate format
     */
    function sanitizeInput(input) {
        const trimmed = String(input || '').trim();
        // Remove null bytes and other control characters
        const cleaned = trimmed.replace(/[\x00-\x1F\x7F]/g, '');
        return escapeHtml(cleaned);
    }

    /**
     * Enhanced name validation with regex
     */
    function validatePlayerName(name) {
        name = String(name || '').trim();

        if (!name || name.length === 0) {
            return { valid: false, error: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á' };
        }

        if (name.length > MAX_NAME_LENGTH) {
            return { valid: false, error: `‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${MAX_NAME_LENGTH} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)` };
        }

        // Allow Thai, English, numbers, and basic punctuation only
        if (!/^[\p{L}\p{M}\p{N}\s\-\.]+$/u.test(name)) {
            return { valid: false, error: '‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' };
        }

        if (appState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
            return { valid: false, error: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß' };
        }

        return { valid: true, error: '' };
    }

    /**
     * Validate skill level
     */
    function validateSkill(skill) {
        return SKILLS_LIST.includes(String(skill));
    }

    /**
     * Validate positive number
     */
    function validateNumber(value, minValue = 1) {
        const num = parseInt(value);
        if (isNaN(num) || num < minValue) {
            return { valid: false, error: `‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ${minValue - 1}` };
        }
        return { valid: true, error: '' };
    }

    /**
     * Validate court name
     */
    function validateCourtName(name) {
        name = String(name || '').trim();

        if (!name || name.length === 0) {
            return { valid: false, error: '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏≤‡∏°‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á' };
        }

        if (name.length > 50) {
            return { valid: false, error: '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô' };
        }

        if (appState.courts.some(c => c.name.toLowerCase() === name.toLowerCase())) {
            return { valid: false, error: '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß' };
        }

        return { valid: true, error: '' };
    }

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================

    /**
     * Get default state structure
     */
    function getDefaultState() {
        return {
            players: [],
            courts: [],
            matches: [],
            matchQueues: [],
            history: {},
            shuttlecocks: {
                newTotal: 0,
                newInPlay: 0,
                practiceTotal: 0,
                practiceInPlay: 0
            },
            nextId: { player: 1, court: 1, match: 1, queue: 1 }
        };
    }

    let appState = getDefaultState();

    const uiState = {
        manualSelectionOrder: [],
        matchTimers: {},
        currentFilter: '',
        isProcessing: false,
        activeEventListeners: []
    };

    /**
     * Save state to localStorage with quota checking
     */
    function saveState() {
        try {
            const stateToSave = JSON.stringify(appState);
            
            // Check storage size before saving
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    const percentUsed = (estimate.usage / estimate.quota) * 100;
                    if (percentUsed > STORAGE_WARNING_THRESHOLD) {
                        console.warn(`Storage usage: ${percentUsed.toFixed(2)}%`);
                    }
                });
            }

            localStorage.setItem(STORAGE_KEY, stateToSave);
            return true;
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                showError('Storage ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                console.error('QuotaExceededError:', e);
                return false;
            }
            console.error('Save state error:', e);
            return false;
        }
    }

    /**
     * Load state from localStorage with fallback
     */
    function loadState() {
        try {
            const savedState = localStorage.getItem(STORAGE_KEY);
            
            if (!savedState) {
                appState = getDefaultState();
                return;
            }

            appState = JSON.parse(savedState);
            validateAndFixState();

        } catch (e) {
            console.error('Load state error:', e);
            appState = getDefaultState();
            showWarning('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß');
        }
    }

    /**
     * Validate and repair corrupted state
     */
    function validateAndFixState() {
        // Ensure core objects exist
        if (!appState.history || typeof appState.history !== 'object') {
            appState.history = {};
        }
        if (!appState.matchQueues || !Array.isArray(appState.matchQueues)) {
            appState.matchQueues = [];
        }
        if (!appState.shuttlecocks) {
            appState.shuttlecocks = {
                newTotal: 0,
                newInPlay: 0,
                practiceTotal: 0,
                practiceInPlay: 0
            };
        }
        if (!appState.nextId) {
            appState.nextId = { player: 1, court: 1, match: 1, queue: 1 };
        }

        // Validate player data
        appState.players.forEach(p => {
            if (typeof p.isCheckedIn === 'undefined') p.isCheckedIn = false;
            if (typeof p.isPlaying === 'undefined') p.isPlaying = false;
            if (!appState.history[p.id]) {
                appState.history[p.id] = { games: [] };
            } else if (!Array.isArray(appState.history[p.id].games)) {
                appState.history[p.id].games = [];
            }
        });

        // Validate match data
        appState.matches.forEach(m => {
            if (typeof m.newShuttleUsed === 'undefined') m.newShuttleUsed = 0;
            if (typeof m.practiceShuttleUsed === 'undefined') m.practiceShuttleUsed = 0;
        });

        // Recalculate IDs
        const maxPlayerId = appState.players.length > 0 
            ? Math.max(...appState.players.map(p => p.id)) 
            : 0;
        const maxCourtId = appState.courts.length > 0 
            ? Math.max(...appState.courts.map(c => c.id)) 
            : 0;

        let maxGameId = 0;
        Object.values(appState.history).forEach(playerHistory => {
            if (playerHistory?.games && Array.isArray(playerHistory.games)) {
                playerHistory.games.forEach(game => {
                    if (game.id > maxGameId) maxGameId = game.id;
                });
            }
        });

        const maxMatchId = appState.matches.length > 0 
            ? Math.max(...appState.matches.map(m => m.id)) 
            : 0;
        const maxQueueId = appState.matchQueues.length > 0 
            ? Math.max(...appState.matchQueues.map(q => q.id)) 
            : 0;

        appState.nextId = {
            player: maxPlayerId + 1,
            court: maxCourtId + 1,
            match: Math.max(maxMatchId, maxGameId) + 1,
            queue: maxQueueId + 1
        };
    }

    // ============================================================
    // NOTIFICATION SYSTEM
    // ============================================================

    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        if (duration > 0) {
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        return toast;
    }

    function showError(message) {
        console.error('Error:', message);
        showToast(`‚ùå ${message}`, 'error');
    }

    function showSuccess(message) {
        console.log('Success:', message);
        showToast(`‚úÖ ${message}`, 'success');
    }

    function showWarning(message) {
        console.warn('Warning:', message);
        showToast(`‚ö†Ô∏è ${message}`, 'warning');
    }

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================

    function formatTime(ms) {
        if (!ms) return '00:00';
        const totalSeconds = Math.floor(Math.max(0, ms) / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function formatDate(timestamp) {
        if (!timestamp || typeof timestamp !== 'number') return '-';
        
        try {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô';
            } else if (diffDays < 7) {
                return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            } else {
                return date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
            }
        } catch (e) {
            console.warn('formatDate error:', e);
            return '-';
        }
    }

    function getSkillClass(skill) {
        return String(skill || 'N').replace('+', 'plus').replace('-', 'minus');
    }

    function getSkillValue(skill) {
        return SKILL_VALUES[String(skill) || 'N'] || 3;
    }

    // ============================================================
    // PLAYER UTILITIES
    // ============================================================

    const PlayerUtils = {
        getById: (id) => {
            const player = appState.players.find(p => p.id === id);
            if (!player) {
                console.warn(`Player not found: ${id}`);
                return null;
            }
            return player;
        },

        isAvailable: (player) => {
            return player && player.isCheckedIn && !player.isPlaying;
        },

        getGameCount: (playerId) => {
            const history = appState.history[playerId];
            return (history && Array.isArray(history.games)) ? history.games.length : 0;
        }
    };

    // ============================================================
    // COURT UTILITIES
    // ============================================================

    const CourtUtils = {
        getAvailable: () => {
            return appState.courts.filter(c => c.status === 'free');
        },

        getById: (id) => {
            const court = appState.courts.find(c => c.id == id);
            if (!court) {
                console.warn(`Court not found: ${id}`);
                return null;
            }
            return court;
        }
    };

    // ============================================================
    // TIMER MANAGEMENT WITH CLEANUP
    // ============================================================

    function startTimer(matchId, card) {
        // Stop existing timer first
        stopTimer(matchId);

        const match = appState.matches.find(m => m.id === matchId);
        if (!match) return;

        if (!match.startTime) {
            match.startTime = Date.now();
            saveState();
        }

        const timerEl = card 
            ? card.querySelector(`#match-timer-${matchId}`) 
            : document.getElementById(`match-timer-${matchId}`);
        
        if (!timerEl) return;

        const updateTimer = () => {
            const elapsedTime = Date.now() - match.startTime;
            timerEl.textContent = formatTime(elapsedTime);
        };

        updateTimer();
        
        const timerId = setInterval(updateTimer, 1000);
        uiState.matchTimers[matchId] = timerId;

        return timerId;
    }

    function stopTimer(matchId) {
        if (uiState.matchTimers[matchId]) {
            clearInterval(uiState.matchTimers[matchId]);
            delete uiState.matchTimers[matchId];
        }
    }

    /**
     * Cleanup all timers - called on page unload
     */
    function cleanupAllTimers() {
        Object.values(uiState.matchTimers).forEach(timerId => {
            clearInterval(timerId);
        });
        uiState.matchTimers = {};
    }

    // ============================================================
    // APP NAMESPACE - Main Application Controller
    // ============================================================

    const App = {
        /**
         * Show specific view
         */
        showView: function(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));

            const selectedView = document.getElementById(viewId);
            if (selectedView) {
                selectedView.classList.add('active');
            }

            const activeNavBtn = document.querySelector(`nav button[onclick*="${viewId}"]`);
            if (activeNavBtn) activeNavBtn.classList.add('active');

            // Render appropriate content
            switch(viewId) {
                case 'dashboard':
                    this.renderDashboard();
                    break;
                case 'player-management':
                    this.renderPlayerList();
                    break;
                case 'check-in':
                    this.renderCheckInList();
                    break;
                case 'match-setup':
                    this.renderMatchSetup();
                    break;
                case 'active-matches':
                    this.renderActiveMatches();
                    break;
                case 'settings':
                    this.renderSettings();
                    break;
            }
        },

        navigateAndShow: function(viewId) {
            this.showView(viewId);
        },

        /**
         * Dashboard rendering
         */
        renderDashboard: function() {
            const totalPlayers = appState.players.length;
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn).length;
            const activeMatches = appState.matches.length;
            const newShuttleInPlay = appState.shuttlecocks.newInPlay;

            document.getElementById('dash-total-players').textContent = totalPlayers;
            document.getElementById('dash-checked-in').textContent = checkedInPlayers;
            document.getElementById('dash-active-matches').textContent = activeMatches;
            document.getElementById('dash-shuttle-in-play').textContent = newShuttleInPlay;

            this.renderDashboardPlayerStats();
            this.renderFrequentPartners();
            this.renderFrequentOpponents();
            this.updateShuttleDisplay();
        },

        renderDashboardPlayerStats: function() {
            const listEl = document.getElementById('dashboard-player-list');
            listEl.innerHTML = '';

            const playerGameCounts = {};
window.App = App; // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ App ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° onclick
            appState.players.forEach(p => {
                playerGameCounts[p.id] = PlayerUtils.getGameCount(p.id);
            });

            const sortedPlayers = appState.players.slice().sort((a, b) => {
                const countA = playerGameCounts[a.id];
                const countB = playerGameCounts[b.id];
                if (countA !== countB) return countA - countB;
                return a.name.localeCompare(b.name, 'th');
            });

            sortedPlayers.forEach(player => {
                const skillClass = getSkillClass(player.skill);
                const card = document.createElement('div');
                card.classList.add('dashboard-player-card');
                card.style.cursor = 'pointer';
                card.onclick = () => this.openPlayerHistoryModal(player.id);
                card.innerHTML = `
                    <div class="player-name">${escapeHtml(player.name)}</div>
                    <div class="player-skill"><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></div>
                    <div class="game-count">${playerGameCounts[player.id]} ‡πÄ‡∏Å‡∏°</div>
                `;
                listEl.appendChild(card);
            });
        },

        renderFrequentPartners: function() {
            const listEl = document.getElementById('frequent-partners-list');
            listEl.innerHTML = '';

            const partnerMap = {};
            Object.entries(appState.history).forEach(([playerIdStr, playerHistory]) => {
                if (playerHistory?.games && Array.isArray(playerHistory.games)) {
                    const playerId = parseInt(playerIdStr);
                    playerHistory.games.forEach(game => {
                        if (game.team1?.includes(playerId)) {
                            game.team1.forEach(partnerId => {
                                if (partnerId !== playerId) {
                                    partnerMap[partnerId] = (partnerMap[partnerId] || 0) + 1;
                                }
                            });
                        } else if (game.team2?.includes(playerId)) {
                            game.team2.forEach(partnerId => {
                                if (partnerId !== playerId) {
                                    partnerMap[partnerId] = (partnerMap[partnerId] || 0) + 1;
                                }
                            });
                        }
                    });
                }
            });

            const sortedPartners = Object.entries(partnerMap)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);

            if (sortedPartners.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1/-1;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</p>';
                return;
            }

            sortedPartners.forEach(([partnerId, count]) => {
                const partner = PlayerUtils.getById(parseInt(partnerId));
                if (!partner) return;

                const card = document.createElement('div');
                card.style.cssText = 'background-color: var(--light); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--success);';
                card.innerHTML = `
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">${escapeHtml(partner.name)}</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${count}</div>
                    <div style="font-size: 0.85rem; color: #888;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô</div>
                `;
                listEl.appendChild(card);
            });
        },

        renderFrequentOpponents: function() {
            const listEl = document.getElementById('frequent-opponents-list');
            listEl.innerHTML = '';

            const opponentMap = {};
            Object.entries(appState.history).forEach(([playerIdStr, playerHistory]) => {
                if (playerHistory?.games && Array.isArray(playerHistory.games)) {
                    playerHistory.games.forEach(game => {
                        const playerId = parseInt(playerIdStr);

                        if (game.team1?.includes(playerId)) {
                            game.team2?.forEach(opponentId => {
                                if (!opponentMap[opponentId]) {
                                    opponentMap[opponentId] = { wins: 0, losses: 0 };
                                }
                                if (game.winner === 1) {
                                    opponentMap[opponentId].losses++;
                                } else if (game.winner === 2) {
                                    opponentMap[opponentId].wins++;
                                }
                            });
                        } else if (game.team2?.includes(playerId)) {
                            game.team1?.forEach(opponentId => {
                                if (!opponentMap[opponentId]) {
                                    opponentMap[opponentId] = { wins: 0, losses: 0 };
                                }
                                if (game.winner === 2) {
                                    opponentMap[opponentId].losses++;
                                } else if (game.winner === 1) {
                                    opponentMap[opponentId].wins++;
                                }
                            });
                        }
                    });
                }
            });

            const sortedOpponents = Object.entries(opponentMap)
                .map(([opponentId, stats]) => ({
                    id: opponentId,
                    ...stats,
                    total: stats.wins + stats.losses
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);

            if (sortedOpponents.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1/-1;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤</p>';
                return;
            }

            sortedOpponents.forEach(({ id, wins, losses, total }) => {
                const opponent = PlayerUtils.getById(parseInt(id));
                if (!opponent) return;

                const winRate = total > 0 ? ((wins / total) * 100).toFixed(0) : 0;
                const card = document.createElement('div');
                card.style.cssText = 'background-color: var(--light); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--danger);';
                card.innerHTML = `
                    <div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">${escapeHtml(opponent.name)}</div>
                    <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">
                        <span style="color: var(--success);">${wins}W</span> <span style="color: var(--danger);">${losses}L</span>
                    </div>
                    <div style="font-size: 0.85rem; color: #888;">${total} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ä‡∏ô‡∏∞ ${winRate}%)</div>
                `;
                listEl.appendChild(card);
            });
        },

        /**
         * Player management functions
         */
        addPlayer: function(name, skill) {
            const nameValidation = validatePlayerName(name);
            if (!nameValidation.valid) {
                return { success: false, error: nameValidation.error };
            }

            if (!validateSkill(skill)) {
                return { success: false, error: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
            }

            const newPlayer = {
                id: appState.nextId.player++,
                name: sanitizeInput(name),
                skill: String(skill),
                isCheckedIn: false,
                isPlaying: false
            };

            appState.players.push(newPlayer);
            appState.history[newPlayer.id] = { games: [] };
            return { success: true, player: newPlayer };
        },

        renderPlayerList: function(filter = '') {
            uiState.currentFilter = filter;
            const listEl = document.getElementById('player-list');
            const bulkEditListEl = document.getElementById('bulk-edit-list');
            listEl.innerHTML = '';
            bulkEditListEl.innerHTML = '';

            const filteredPlayers = appState.players.filter(p =>
                p.name.toLowerCase().includes(filter.toLowerCase()) ||
                p.id.toString().includes(filter)
            );

            if (filteredPlayers.length === 0 && filter.length > 0) {
                listEl.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</td></tr>';
            }

            filteredPlayers.forEach(player => {
                const skillClass = getSkillClass(player.skill);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="text" id="name-edit-${player.id}" value="${escapeHtml(player.name)}"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                               placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô" maxlength="50">
                    </td>
                    <td><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></td>
                    <td>${PlayerUtils.getGameCount(player.id)}</td>
                    <td>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                            <button class="success" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                    onclick="App.updatePlayerName(${player.id}, document.getElementById('name-edit-${player.id}').value)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            <select id="edit-skill-${player.id}" style="padding: 0.5rem; width: auto;">
                                ${SKILLS_LIST.map(s =>
                                    `<option value="${s}" ${s === player.skill ? 'selected' : ''}>${s}</option>`
                                ).join('')}
                            </select>
                            <button class="warning" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                    onclick="App.updatePlayerSkill(${player.id}, document.getElementById('edit-skill-${player.id}').value)">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
                            <button class="danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                    onclick="App.deletePlayer(${player.id})">‡∏•‡∏ö</button>
                        </div>
                    </td>
                `;
                listEl.appendChild(tr);

                const bulkItem = document.createElement('div');
                bulkItem.classList.add('bulk-edit-item');
                bulkItem.innerHTML = `
                    <span>${escapeHtml(player.name)} <span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></span>
                    <input type="checkbox" data-player-id="${player.id}">
                `;
                bulkEditListEl.appendChild(bulkItem);
            });
        },

        updatePlayerName: function(id, newName) {
            const player = PlayerUtils.getById(id);
            if (!player) return;

            const nameValidation = validatePlayerName(newName);
            if (!nameValidation.valid) {
                showError(nameValidation.error);
                return;
            }

            const oldName = player.name;
            player.name = sanitizeInput(newName);
            saveState();
            this.renderPlayerList(uiState.currentFilter);
            showSuccess(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å "${escapeHtml(oldName)}" ‡πÄ‡∏õ‡πá‡∏ô "${escapeHtml(player.name)}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        },

        updatePlayerSkill: function(id, newSkill) {
            if (!validateSkill(newSkill)) {
                showError('‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            const player = PlayerUtils.getById(id);
            if (!player) return;

            if (player.skill === newSkill) {
                showWarning('‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            player.skill = String(newSkill);
            saveState();
            this.renderPlayerList(uiState.currentFilter);
            showSuccess(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠ ${escapeHtml(player.name)} ‡πÄ‡∏õ‡πá‡∏ô ${newSkill}`);
        },

        deletePlayer: function(id) {
            const player = PlayerUtils.getById(id);
            if (!player) return;

            const gameCount = PlayerUtils.getGameCount(id);

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${escapeHtml(player.name)}?\n\n‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏≤: ${gameCount} ‡πÄ‡∏Å‡∏°\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
                appState.players = appState.players.filter(p => p.id !== id);
                appState.matches = appState.matches.filter(m => !m.team1.includes(id) && !m.team2.includes(id));
                delete appState.history[id];
                saveState();
                this.renderPlayerList(uiState.currentFilter);
                this.renderActiveMatches();
                showSuccess(`‡∏•‡∏ö ${escapeHtml(player.name)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
        },

        clearAllPlayers: function() {
            if (appState.matches.length > 0) {
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ! ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á');
                return;
            }

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
                appState.players = [];
                appState.nextId.player = 1;
                saveState();
                this.renderDashboard();
                this.renderPlayerList();
                this.renderCheckInList();
                showSuccess('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        },

        // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ
        clearAllHistory: function() {
          if (!appState || !appState.history) {
            alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤");
            return;
          }
          if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà")) return;
          for (const id in appState.history) {
            if (Array.isArray(appState.history[id]?.games)) {
              appState.history[id].games = [];
            }
          }
          appState.matches = [];
          if (typeof saveState === "function") saveState();
          if (typeof this.renderDashboard === "function") this.renderDashboard();
          if (typeof this.renderPlayerList === "function") this.renderPlayerList();
          if (typeof showSuccess === "function") showSuccess("‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        },
    

        /**
         * Check-in functions
         */
        toggleCheckIn: function(id) {
            const player = PlayerUtils.getById(id);
            if (!player) return;

            if (player.isPlaying) {
                showError(`${escapeHtml(player.name)} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà`);
                return;
            }

            player.isCheckedIn = !player.isCheckedIn;

            if (player.isCheckedIn) {
                player.checkInTime = Date.now();
            } else {
                delete player.checkInTime;
            }

            saveState();
            this.renderCheckInList();
            this.renderDashboard();
        },

        resetAllCheckIns: function() {
            if (appState.players.some(p => p.isPlaying)) {
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏î‡πâ ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á');
                return;
            }

            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                appState.players.forEach(p => {
                    p.isCheckedIn = false;
                    p.isPlaying = false;
                    delete p.checkInTime;
                });
                saveState();
                this.renderCheckInList();
                this.renderDashboard();
                showSuccess('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        },

        renderCheckInList: function() {
            const listEl = document.getElementById('check-in-list');
            listEl.innerHTML = '';

            const playingIds = new Set();
            appState.matches.forEach(m => {
                [...m.team1, ...m.team2].forEach(id => playingIds.add(id));
            });

            appState.players.forEach(p => {
                p.isPlaying = playingIds.has(p.id);
            });
            saveState();

            const sortedPlayers = appState.players.slice().sort((a, b) => {
                const statusA = a.isCheckedIn ? (a.isPlaying ? 2 : 1) : 3;
                const statusB = b.isCheckedIn ? (b.isPlaying ? 2 : 1) : 3;

                if (statusA !== statusB) return statusA - statusB;

                if (a.isCheckedIn && b.isCheckedIn && !a.isPlaying && !b.isPlaying) {
                    if (a.checkInTime && b.checkInTime) {
                        if (a.checkInTime !== b.checkInTime) return a.checkInTime - b.checkInTime;
                    }
                }

                return a.name.localeCompare(b.name, 'th');
            });

            sortedPlayers.forEach(player => {
                const skillClass = getSkillClass(player.skill);
                const gameCount = PlayerUtils.getGameCount(player.id);
                const card = document.createElement('div');
                card.classList.add('check-in-card');

                if (player.isCheckedIn) card.classList.add('checked-in');
                if (player.isPlaying) card.classList.add('playing-now');

                card.onclick = () => this.toggleCheckIn(player.id);

                let statusIcon = player.isCheckedIn ? '‚úÖ' : '‚ùå';
                if (player.isPlaying) {
                    statusIcon = 'üè∏';
                    card.classList.remove('checked-in');
                }

                card.innerHTML = `
                    <div class="player-name">${escapeHtml(player.name)}</div>
                    <div class="player-skill"><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></div>
                    <div style="font-size:0.8rem; color:#888;">${gameCount} ‡πÄ‡∏Å‡∏°</div>
                    <div class="status-icon">${statusIcon}</div>
                `;
                listEl.appendChild(card);
            });
        },

        /**
         * Court management
         */
        addCourt: function(name) {
            const validation = validateCourtName(name);
            if (!validation.valid) {
                showError(validation.error);
                return false;
            }

            const newCourt = {
                id: appState.nextId.court++,
                name: sanitizeInput(name),
                status: 'free',
                currentMatchId: null
            };

            appState.courts.push(newCourt);
            saveState();
            this.renderCourtList();
            this.renderMatchSetup();
            showSuccess(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(newCourt.name)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            return true;
        },

        deleteCourt: function(id) {
            const court = CourtUtils.getById(id);
            if (!court) return;

            if (court.status === 'playing') {
                showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(court.name)} ‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á`);
                return;
            }

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(court.name)}?`)) {
                appState.courts = appState.courts.filter(c => c.id !== id);
                saveState();
                this.renderCourtList();
                this.renderMatchSetup();
                showSuccess(`‡∏•‡∏ö‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(court.name)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
        },

        renderCourtList: function() {
            const listEl = document.getElementById('court-list');
            listEl.innerHTML = '';

            if (appState.courts.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</p>';
                return;
            }

            appState.courts.forEach(court => {
                const li = document.createElement('div');
                li.style.cssText = 'background-color: ' + (court.status === 'playing' ? '#ffe0b2' : 'var(--light)') + '; padding: 1rem; margin-bottom: 0.75rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';
                li.innerHTML = `
                    <span>
                        ${escapeHtml(court.name)}
                        <span style="font-size: 0.8rem; color: ${court.status === 'playing' ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                            (${court.status === 'playing' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô' : '‡∏ß‡πà‡∏≤‡∏á'})
                        </span>
                    </span>
                    <button class="danger" style="padding: 0.5rem 1rem;" onclick="App.deleteCourt(${court.id})">‡∏•‡∏ö</button>
                `;
                listEl.appendChild(li);
            });
        },

        renderSettings: function() {
            this.renderCourtList();
            this.updateShuttleDisplay();
        },

        /**
         * Shuttle management
         */
        updateShuttleDisplay: function() {
            const newInPlay = appState.shuttlecocks.newInPlay;
            const practiceInPlay = appState.shuttlecocks.practiceInPlay;

            // Dashboard
            const dashEl = document.getElementById('dash-shuttle-in-play');
            if (dashEl) dashEl.textContent = newInPlay;

            // Live
            const liveNewEl = document.getElementById('live-shuttle-in-play');
            if (liveNewEl) liveNewEl.textContent = newInPlay;

            const livePracticeEl = document.getElementById('live-shuttle-practice');
            if (livePracticeEl) livePracticeEl.textContent = practiceInPlay;

            // Settings
            const settingsNewEl = document.getElementById('settings-shuttle-new');
            if (settingsNewEl) settingsNewEl.textContent = newInPlay;

            const settingsPracticeEl = document.getElementById('settings-shuttle-practice');
            if (settingsPracticeEl) settingsPracticeEl.textContent = practiceInPlay;
        },

        updateGlobalShuttlecocks: function(action, type, amount) {
            const validation = validateNumber(amount);
            if (!validation.valid) {
                showError(validation.error);
                return;
            }

            amount = parseInt(amount);

            if (type === 'new') {
                switch (action) {
                    case 'add':
                        appState.shuttlecocks.newTotal += amount;
                        appState.shuttlecocks.newInPlay += amount;
                        break;
                    case 'remove':
                        if (appState.shuttlecocks.newInPlay < amount) {
                            showError('‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏û‡∏≠');
                            return;
                        }
                        appState.shuttlecocks.newInPlay -= amount;
                        break;
                }
            } else if (type === 'practice') {
                switch (action) {
                    case 'add':
                        appState.shuttlecocks.practiceTotal += amount;
                        appState.shuttlecocks.practiceInPlay += amount;
                        break;
                    case 'remove':
                        if (appState.shuttlecocks.practiceInPlay < amount) {
                            showError('‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏ã‡πâ‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠');
                            return;
                        }
                        appState.shuttlecocks.practiceInPlay -= amount;
                        break;
                }
            }

            if (appState.shuttlecocks.newInPlay < 0) appState.shuttlecocks.newInPlay = 0;
            if (appState.shuttlecocks.practiceInPlay < 0) appState.shuttlecocks.practiceInPlay = 0;

            saveState();
            this.updateShuttleDisplay();
            showSuccess(`‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡∏±‡∏ü‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${amount} ‡∏•‡∏π‡∏Å`);
        },

        /**
         * Match setup
         */
        renderMatchSetup: function() {
            this.renderCourtSelectDropdown('court-select-dropdown');

            const setupContentEl = document.getElementById('match-setup-content');
            setupContentEl.innerHTML = '<p style="color: #888; font-size: 0.9rem; margin: 0; padding: 0.75rem; background-color: var(--light); border-radius: 8px; border-left: 3px solid var(--secondary);">üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ "‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô</p>';
            uiState.manualSelectionOrder = [];
            
            this.updateQueueDisplay();
        },

        renderCourtSelectDropdown: function(targetId) {
            const selectEl = document.getElementById(targetId);
            selectEl.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á --';
            selectEl.appendChild(defaultOption);

            const availableCourts = CourtUtils.getAvailable();
            availableCourts.forEach(court => {
                const option = document.createElement('option');
                option.value = court.id;
                option.textContent = escapeHtml(court.name);
                selectEl.appendChild(option);
            });

            const hasAvailableCourt = availableCourts.length > 0;
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            const canSetup = hasAvailableCourt && checkedInPlayers.length >= MIN_PLAYERS_FOR_MATCH;

            const randomBtn = document.getElementById('btn-random-setup');
            const queueBtn = document.getElementById('btn-queue-setup');
            
            if (randomBtn) randomBtn.disabled = !canSetup;
            if (queueBtn) queueBtn.disabled = !canSetup;
        },

        switchToQueueTab: function() {
            const queueTab = document.getElementById('queue-setup-tab');
            queueTab.style.display = 'block';
            this.renderQueueList();
        },

        updateQueueDisplay: function() {
            const count = appState.matchQueues.length;
            const queueBadge = document.getElementById('queue-badge');
            
            if (queueBadge) queueBadge.textContent = count;
            
            const btnQueueSetup = document.getElementById('btn-queue-setup');
            const btnQueueRandom = document.getElementById('btn-queue-random');
            const btnViewQueue = document.getElementById('btn-view-queue');
            const btnQueueManual = document.getElementById('btn-queue-manual');
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            
            if (btnQueueSetup) {
                btnQueueSetup.disabled = checkedInPlayers.length < 4;
            }
            if (btnQueueRandom) {
                btnQueueRandom.disabled = checkedInPlayers.length < 4;
            }
            
            if (btnQueueManual) {
                btnQueueManual.disabled = checkedInPlayers.length < 4;
            }
if (btnViewQueue) {
                btnViewQueue.disabled = count === 0;
            }
        },

        renderQueueList: function() {
// --- LOCAL GAME COUNT CACHE (A: Render-queue only) ---
const __localGameCount = {};
try {
    if (appState && Array.isArray(appState.players)) {
        for (let pi = 0; pi < appState.players.length; pi++) {
            const pp = appState.players[pi];
            try {
                // call original getter once per player
                __localGameCount[pp.id] = (typeof PlayerUtils !== 'undefined' && typeof PlayerUtils.getGameCount === 'function') ? PlayerUtils.getGameCount(pp.id) : 0;
            } catch(e) {
                __localGameCount[pp.id] = 0;
            }
        }
    }
} catch(e){
    // fail-safe
}
function __getLocalCount(id){ return __localGameCount[id] !== undefined ? __localGameCount[id] : 0; }
// --- end local cache ---

            const listEl = document.getElementById('queue-list');
            listEl.innerHTML = '';

            if (appState.matchQueues.length === 0) {
                listEl.innerHTML = `
                    <div class="queue-empty">
                        <div class="queue-empty-icon">üî≠</div>
                        <h3 style="margin: 0;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</h3>
                        <p style="margin: 0.5rem 0;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ "‡∏™‡∏î‡πÉ‡∏à‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà</p>
                    </div>
                `;
                return;
            }

            appState.matchQueues.forEach((queue, index) => {
                const team1Names = queue.team1.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');
                const team2Names = queue.team2.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');

                const team1Skills = queue.team1.map(id => PlayerUtils.getById(id)?.skill || '?');
                const team2Skills = queue.team2.map(id => PlayerUtils.getById(id)?.skill || '?');

                const createdTime = formatDate(queue.createdAt);
                const isNew = Date.now() - queue.createdAt < 60000;

                const card = document.createElement('div');
                card.classList.add('queue-card');
                if (isNew) card.classList.add('created-just-now');

                card.innerHTML = `
                    <div class="queue-card-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="queue-card-number">${index + 1}</div>
                            <div class="queue-card-title">‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏•‡πà‡∏ô #${queue.id}</div>
                        </div>
                        <span style="font-size: 0.85rem; color: #888;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${createdTime}</span>
                    </div>

                    <div class="queue-card-teams">
                        <div class="queue-team">
                            <h4>‡∏ó‡∏µ‡∏° 1</h4>
                            <div class="queue-team-players">${team1Names}</div>
                            <div class="queue-team-skills">${team1Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</div>
                        </div>
                        <div class="queue-vs">VS</div>
                        <div class="queue-team">
                            <h4>‡∏ó‡∏µ‡∏° 2</h4>
                            <div class="queue-team-players">${team2Names}</div>
                            <div class="queue-team-skills">${team2Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</div>
                        </div>
                    </div>

                    <div class="queue-card-meta">
                        <span>üë• ${queue.team1.length + queue.team2.length} ‡∏Ñ‡∏ô</span>
                        <span>üè∏ Balanced</span>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <h5 style="margin: 0 0 0.75rem 0; color: var(--primary); font-size: 0.9rem; font-weight: bold;">üéÆ ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥</h5>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="warning" onclick="App.manualSetupQueueStart(${queue.id})" style="flex: 1; min-height: 40px;" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏≠‡∏á">
                                    üñäÔ∏è ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á
                                </button>
                                <button class="secondary" onclick="App.randomShuffleQueue(${queue.id})" style="flex: 1; min-height: 40px;" title="‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà">
                                    üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏µ‡∏°
                                </button>
                            </div>
                        </div>
                        <div>
                            <h5 style="margin: 0 0 0.75rem 0; color: var(--primary); font-size: 0.9rem; font-weight: bold;">‚è≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</h5>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="success" onclick="App.callQueueToPlay(${queue.id})" style="flex: 1.2; min-height: 40px;" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ">
                                    ‚úì ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô
                                </button>
                                <button class="danger" onclick="App.deleteQueue(${queue.id})" style="flex: 0.6; min-height: 40px; padding: 0;" title="‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                listEl.appendChild(card);
            });
        },

        addToQueue: function(team1Ids, team2Ids) {
            const queueId = appState.nextId.queue++;
            const newQueue = {
                id: queueId,
                team1: team1Ids,
                team2: team2Ids,
                createdAt: Date.now(),
                createdBy: 'auto',
                newShuttleUsed: 0,
                practiceShuttleUsed: 0
            };

            appState.matchQueues.push(newQueue);
            saveState();
            this.updateQueueDisplay();
            showSuccess(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏•‡πà‡∏ô #${queueId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);

            return queueId;
        },

        callQueueToPlay: function(queueId) {
            const queue = appState.matchQueues.find(q => q.id === queueId);
            if (!queue) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                return;
            }

            const queuePlayers = [...queue.team1, ...queue.team2];
            const allPlayersAvailable = queuePlayers.every(id => {
                const player = PlayerUtils.getById(id);
                return player && player.isCheckedIn && !player.isPlaying;
            });

            if (!allPlayersAvailable) {
                showError('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô (‡∏≠‡∏≤‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á)');
                return;
            }

            const availableCourts = CourtUtils.getAvailable();
            if (availableCourts.length === 0) {
                showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }

            const team1Names = queue.team1.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');
            const team2Names = queue.team2.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');

            if (confirm(`‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô:\n‡∏ó‡∏µ‡∏° 1: ${team1Names}\n‡∏ó‡∏µ‡∏° 2: ${team2Names}\n‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏° "${escapeHtml(availableCourts[0].name)}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                if (this.createMatch(availableCourts[0].id, queue.team1, queue.team2)) {
                    appState.matchQueues = appState.matchQueues.filter(q => q.id !== queueId);
                    saveState();
                    this.updateQueueDisplay();
                    this.renderCourtSelectDropdown('court-select-dropdown');
                }
            }
        },

        deleteQueue: function(queueId) {
            if (confirm(`‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏•‡πà‡∏ô #${queueId} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?`)) {
                appState.matchQueues = appState.matchQueues.filter(q => q.id !== queueId);
                saveState();
                this.updateQueueDisplay();
                this.renderQueueList();
                showSuccess('‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        },

        /**
         * Manual setup for queue
         */
        manualSetupQueueStart: function(queueId) {
            const queue = appState.matchQueues.find(q => q.id === queueId);
            if (!queue) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                return;
            }

            // Check if all players are still available
            const queuePlayers = [...queue.team1, ...queue.team2];
            const allPlayersAvailable = queuePlayers.every(id => {
                const player = PlayerUtils.getById(id);
                return player && player.isCheckedIn && !player.isPlaying;
            });

            if (!allPlayersAvailable) {
                showError('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô');
                return;
            }

            const availableCourts = CourtUtils.getAvailable();
            if (availableCourts.length === 0) {
                showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }

            // Show court selection
            const courtOptions = availableCourts.map((c, i) => `${i + 1}. ${c.name}`).join('\n');
            const selectedNum = prompt(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°:\n${courtOptions}\n\n‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:`);

            if (!selectedNum) return;

            const courtIndex = parseInt(selectedNum) - 1;
            if (courtIndex < 0 || courtIndex >= availableCourts.length) {
                showError('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            const courtId = availableCourts[courtIndex].id;
            if (this.createMatch(courtId, queue.team1, queue.team2)) {
                appState.matchQueues = appState.matchQueues.filter(q => q.id !== queueId);
                saveState();
                this.updateQueueDisplay();
                this.renderQueueList();
                this.renderMatchSetup();
            }
        },

        /**
         * Random shuffle for queue players
         */
        randomShuffleQueue: function(queueId) {
            const queue = appState.matchQueues.find(q => q.id === queueId);
            if (!queue) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                return;
            }

            // Check if all players are still available
            const queuePlayers = [...queue.team1, ...queue.team2];
            const allPlayersAvailable = queuePlayers.every(id => {
                const player = PlayerUtils.getById(id);
                return player && player.isCheckedIn && !player.isPlaying;
            });

            if (!allPlayersAvailable) {
                showError('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô');
                return;
            }

            // Shuffle players
            const shuffled = [...queuePlayers].sort(() => 0.5 - Math.random());
            
            // Balance by skill
            shuffled.sort((a, b) => {
                const skillA = getSkillValue(PlayerUtils.getById(a)?.skill || 'N');
                const skillB = getSkillValue(PlayerUtils.getById(b)?.skill || 'N');
                return skillB - skillA;
            });

            queue.team1 = [shuffled[0], shuffled[3]];
            queue.team2 = [shuffled[1], shuffled[2]];

            saveState();
            this.renderQueueList();
            showSuccess('‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        },

        manualSetupStart: function() {
            const courtId = document.getElementById('court-select-dropdown').value;
            if (!courtId) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ${MIN_PLAYERS_FOR_MATCH} ‡∏Ñ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ`);
                return;
            }

            const setupContentEl = document.getElementById('match-setup-content');
            setupContentEl.innerHTML = `
                <h3>‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(appState.courts.find(c => c.id == courtId).name)}</h3>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 4 ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (1-2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏° 1, 3-4 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏° 2) <span id="selection-status" style="font-weight: bold; color: var(--secondary);">: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1</span></p>
                <div id="manual-selection-grid" class="check-in-grid"></div>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button class="success" onclick="App.confirmManualMatch(${courtId})" id="btn-confirm-manual" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô</button>
                    <button class="danger" onclick="App.renderMatchSetup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            `;

            uiState.manualSelectionOrder = [];
            this.renderManualSelectionGrid(checkedInPlayers);
        },

        renderManualSelectionGrid: function(players) {
            const gridEl = document.getElementById('manual-selection-grid');
            const statusEl = document.getElementById('selection-status');
            const confirmBtn = document.getElementById('btn-confirm-manual');
            gridEl.innerHTML = '';

            players.forEach(player => {
                const skillClass = getSkillClass(player.skill);
                const gameCount = PlayerUtils.getGameCount(player.id);
                const isSelected = uiState.manualSelectionOrder.includes(player.id);
                const card = document.createElement('div');
                card.classList.add('check-in-card');
                if (isSelected) card.style.backgroundColor = '#e0f7fa';
                card.onclick = () => this.toggleManualSelection(player.id, players);

                let orderBadge = '';
                if (isSelected) {
                    const order = uiState.manualSelectionOrder.indexOf(player.id) + 1;
                    orderBadge = `<div style="position: absolute; top: 5px; right: 5px; background: var(--secondary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${order}</div>`;
                }

                card.innerHTML = `
                    ${orderBadge}
                    <div class="player-name">${escapeHtml(player.name)}</div>
                    <div class="player-skill"><span class="skill-badge skill-${skillClass}">${escapeHtml(player.skill)}</span></div>
                    <div style="font-size: 0.8rem; color: #888;">${gameCount} ‡πÄ‡∏Å‡∏°</div>
                `;
                gridEl.appendChild(card);
            });

            statusEl.textContent = `: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${uiState.manualSelectionOrder.length + 1}`;
            confirmBtn.disabled = uiState.manualSelectionOrder.length !== 4;
        },

        toggleManualSelection: function(playerId, players) {
            const index = uiState.manualSelectionOrder.indexOf(playerId);
            if (index > -1) {
                uiState.manualSelectionOrder.splice(index, 1);
            } else if (uiState.manualSelectionOrder.length < 4) {
                uiState.manualSelectionOrder.push(playerId);
            }
            this.renderManualSelectionGrid(players);
        },

        confirmManualMatch: function(courtId) {
            if (uiState.manualSelectionOrder.length !== 4) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô');
                return;
            }

            const team1Ids = [uiState.manualSelectionOrder[0], uiState.manualSelectionOrder[1]];
            const team2Ids = [uiState.manualSelectionOrder[2], uiState.manualSelectionOrder[3]];

            const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
            const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà:\n‡∏ó‡∏µ‡∏° 1: ${escapeHtml(team1Names)}\n‡∏ó‡∏µ‡∏° 2: ${escapeHtml(team2Names)}\n‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                if (this.createMatch(courtId, team1Ids, team2Ids)) {
                    uiState.manualSelectionOrder = [];
                    this.renderCourtSelectDropdown('court-select-dropdown');
                }
            }
        },

        simpleRandomMatch: function() {
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ${MIN_PLAYERS_FOR_MATCH} ‡∏Ñ‡∏ô`);
                return;
            }

            const availableCourts = CourtUtils.getAvailable();
            if (availableCourts.length === 0) {
                showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }

            const shuffledPlayers = checkedInPlayers.sort(() => 0.5 - Math.random());
            const selectedPlayers = shuffledPlayers.slice(0, 4);

            selectedPlayers.sort((a, b) =>
                getSkillValue(b.skill) - getSkillValue(a.skill)
            );

            const team1Ids = [selectedPlayers[0].id, selectedPlayers[3].id];
            const team2Ids = [selectedPlayers[1].id, selectedPlayers[2].id];

            const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
            const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

            const team1Skills = team1Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');
            const team2Skills = team2Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');

            if (confirm(`‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Ñ‡∏π‡πà (Balanced):\n\n‡∏ó‡∏µ‡∏° 1: ${escapeHtml(team1Names)}\n       (${team1Skills})\n\n‡∏ó‡∏µ‡∏° 2: ${escapeHtml(team2Names)}\n       (${team2Skills})\n\n‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                if (this.createMatch(availableCourts[0].id, team1Ids, team2Ids)) {
                    this.renderCourtSelectDropdown('court-select-dropdown');
                }
            }
        },

        queueMatchStart: function() {
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô ${MIN_PLAYERS_FOR_MATCH} ‡∏Ñ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ`);
                return;
            }

            const playerStats = checkedInPlayers.map(p => ({
                id: p.id,
                name: p.name,
                skillValue: getSkillValue(p.skill),
                gameCount: PlayerUtils.getGameCount(p.id)
            }));

            playerStats.sort((a, b) => a.gameCount - b.gameCount);

            const top4 = playerStats.slice(0, 4);
            top4.sort((a, b) => a.skillValue - b.skillValue);

            const team1Ids = [top4[0].id, top4[3].id];
            const team2Ids = [top4[1].id, top4[2].id];

            const team1Names = team1Ids.map(id => escapeHtml(PlayerUtils.getById(id).name)).join(' & ');
            const team2Names = team2Ids.map(id => escapeHtml(PlayerUtils.getById(id).name)).join(' & ');

            if (confirm(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î):\n‡∏ó‡∏µ‡∏° 1: ${team1Names}\n‡∏ó‡∏µ‡∏° 2: ${team2Names}\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                this.addToQueue(team1Ids, team2Ids);
                this.switchToQueueTab();
            }
        },

        /**
         * Create random queue
         */
        queueRandomStart: function() {
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô ${MIN_PLAYERS_FOR_MATCH} ‡∏Ñ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ`);
                return;
            }

            const shuffledPlayers = checkedInPlayers.sort(() => 0.5 - Math.random());
            const selectedPlayers = shuffledPlayers.slice(0, 4);

            selectedPlayers.sort((a, b) =>
                getSkillValue(b.skill) - getSkillValue(a.skill)
            );

            const team1Ids = [selectedPlayers[0].id, selectedPlayers[3].id];
            const team2Ids = [selectedPlayers[1].id, selectedPlayers[2].id];

            const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
            const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

            const team1Skills = team1Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');
            const team2Skills = team2Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');

            if (confirm(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡∏™‡∏∏‡πà‡∏°):\n\n‡∏ó‡∏µ‡∏° 1: ${escapeHtml(team1Names)}\n       (${team1Skills})\n\n‡∏ó‡∏µ‡∏° 2: ${escapeHtml(team2Names)}\n       (${team2Skills})\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                this.addToQueue(team1Ids, team2Ids);
                this.switchToQueueTab();
            }
        },

        /**
         * Manual queue builder (choose exact pairs then add to queue)
         */
        queueManualStart: function() {
            const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
            if (checkedInPlayers.length < MIN_PLAYERS_FOR_MATCH) {
                showError(`‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô ${MIN_PLAYERS_FOR_MATCH} ‡∏Ñ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ`);
                return;
            }

            const setupContentEl = document.getElementById('match-setup-content');
            setupContentEl.innerHTML = `
                <h3>üß© ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏≠‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 4 ‡∏Ñ‡∏ô)</h3>
                <p>‡πÅ‡∏ï‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 4 ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (1-2 ‡∏ó‡∏µ‡∏° 1, 3-4 ‡∏ó‡∏µ‡∏° 2) <span id="selection-status" style="font-weight: bold; color: var(--secondary);">: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1</span></p>
                <div id="manual-selection-grid" class="check-in-grid"></div>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button class="success" onclick="App.confirmManualQueue()" id="btn-confirm-manual" disabled>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</button>
                    <button class="danger" onclick="App.renderMatchSetup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            `;

            uiState.manualSelectionOrder = [];
            this.renderManualSelectionGrid(checkedInPlayers);
            const queueTab = document.getElementById('queue-setup-tab');
            if (queueTab) queueTab.style.display = 'block';
        },

        /**
         * Confirm manual queue and push to queue list
         */
        confirmManualQueue: function() {
            if (uiState.manualSelectionOrder.length !== 4) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô');
                return;
            }
            const team1Ids = [uiState.manualSelectionOrder[0], uiState.manualSelectionOrder[1]];
            const team2Ids = [uiState.manualSelectionOrder[2], uiState.manualSelectionOrder[3]];

            const team1Names = team1Ids.map(id => PlayerUtils.getById(id)?.name || '?').join(' & ');
            const team2Names = team2Ids.map(id => PlayerUtils.getById(id)?.name || '?').join(' & ');

            if (confirm(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏±‡∏î‡πÄ‡∏≠‡∏á):\n\n‡∏ó‡∏µ‡∏° 1: ${escapeHtml(team1Names)}\n‡∏ó‡∏µ‡∏° 2: ${escapeHtml(team2Names)}\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                this.addToQueue(team1Ids, team2Ids);
                uiState.manualSelectionOrder = [];
                this.switchToQueueTab();
                this.renderMatchSetup();
            }
        },


        /**
         * Create match and start timer
         */
        createMatch: function(courtId, team1Ids, team2Ids) {
            if (!courtId || team1Ids.length !== 2 || team2Ids.length !== 2) {
                showError('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return false;
            }

            const court = CourtUtils.getById(courtId);
            if (!court || court.status !== 'free') {
                showError('‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö');
                return false;
            }

            // Use new shuttle if available
            if (appState.shuttlecocks.newInPlay < 1) {
                showError('‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏û‡∏≠');
                return false;
            }

            appState.shuttlecocks.newInPlay -= 1;

            const matchId = appState.nextId.match++;
            const newMatch = {
                id: matchId,
                courtId: courtId,
                courtName: court.name,
                team1: team1Ids,
                team2: team2Ids,
                startTime: Date.now(),
                newShuttleUsed: 1,
                practiceShuttleUsed: 0
            };

            appState.matches.push(newMatch);
            court.status = 'playing';
            court.currentMatchId = matchId;

            [...team1Ids, ...team2Ids].forEach(playerId => {
                const player = PlayerUtils.getById(playerId);
                if (player) {
                    player.isPlaying = true;
                }
            });

            saveState();
            this.renderActiveMatches();
            this.renderCheckInList();
            this.renderDashboard();
            this.showView('active-matches');
            showSuccess(`‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(court.name)}`);
            return true;
        },

        /**
         * Active matches
         */
        renderActiveMatches: function() {
            const listEl = document.getElementById('active-matches-list');
            listEl.innerHTML = '';

            if (appState.matches.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</p>';
                return;
            }

            appState.matches.forEach(match => {
                const team1Names = match.team1.map(id => PlayerUtils.getById(id)?.name || '???').join(' & ');
                const team2Names = match.team2.map(id => PlayerUtils.getById(id)?.name || '???').join(' & ');

                const team1Skills = match.team1.map(id => PlayerUtils.getById(id)?.skill || '?');
                const team2Skills = match.team2.map(id => PlayerUtils.getById(id)?.skill || '?');

                const card = document.createElement('div');
                card.classList.add('match-card');
                card.dataset.matchId = match.id;

                card.innerHTML = `
                    <h3>‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(match.courtName)}</h3>
                    <div class="timer" id="match-timer-${match.id}">00:00</div>
                    <div class="match-teams">
                        <div class="team">
                            <h4>‡∏ó‡∏µ‡∏° 1</h4>
                            <p>${escapeHtml(team1Names)}</p>
                            <p>${team1Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</p>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team">
                            <h4>‡∏ó‡∏µ‡∏° 2</h4>
                            <p>${escapeHtml(team2Names)}</p>
                            <p>${team2Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${escapeHtml(s)}</span>`).join(' ')}</p>
                        </div>
                    </div>

                    <div class="court-shuttle-control">
                        <div class="shuttle-control-item">
                            <span style="font-weight: bold; color: var(--primary);">‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà:</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'new', -1)">-</button>
                            <span style="font-weight: bold; font-size: 1.2rem; min-width: 30px; text-align: center;" id="match-shuttle-new-${match.id}">${match.newShuttleUsed}</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'new', 1)">+</button>
                        </div>
                        <div class="shuttle-control-item">
                            <span style="font-weight: bold; color: var(--primary);">‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°:</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'practice', -1)">-</button>
                            <span style="font-weight: bold; font-size: 1.2rem; min-width: 30px; text-align: center;" id="match-shuttle-practice-${match.id}">${match.practiceShuttleUsed}</span>
                            <button onclick="App.updateMatchShuttleUsed(${match.id}, 'practice', 1)">+</button>
                        </div>
                    </div>

                    <h4 style="margin-top: 1.5rem; text-align: center;">‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞?</h4>
                    <div class="match-controls">
                        <button class="success" onclick="App.recordMatchResult(${match.id}, 1)">‡∏ó‡∏µ‡∏° 1 ‡∏ä‡∏ô‡∏∞</button>
                        <button style="background-color: #f1c40f; color: var(--dark);" onclick="App.recordMatchResult(${match.id}, 0)">‡πÄ‡∏™‡∏°‡∏≠</button>
                        <button class="success" onclick="App.recordMatchResult(${match.id}, 2)">‡∏ó‡∏µ‡∏° 2 ‡∏ä‡∏ô‡∏∞</button>
                    </div>
                    <div class="match-controls" style="margin-top: 1rem;">
                        <button class="danger" onclick="App.cancelMatch(${match.id})">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå</button>
                    </div>
                `;
                listEl.appendChild(card);
                startTimer(match.id, card);
            });
            this.updateShuttleDisplay();
            this.renderDashboard();
        },

        updateMatchShuttleUsed: function(matchId, type, amount) {
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°');
                return;
            }

            if (type === 'new') {
                if (match.newShuttleUsed + amount >= 0) {
                    match.newShuttleUsed += amount;
                    document.getElementById(`match-shuttle-new-${matchId}`).textContent = match.newShuttleUsed;
                } else {
                    showError('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
                    return;
                }
            } else if (type === 'practice') {
                if (match.practiceShuttleUsed + amount >= 0) {
                    match.practiceShuttleUsed += amount;
                    document.getElementById(`match-shuttle-practice-${matchId}`).textContent = match.practiceShuttleUsed;
                } else {
                    showError('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏ã‡πâ‡∏≠‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
                    return;
                }
            }

            saveState();
        },

        recordMatchResult: function(matchId, winningTeam) {
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°');
                return;
            }

            if (![0, 1, 2].includes(winningTeam)) {
                showError('‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            const gameResult = {
                id: appState.nextId.match++,
                matchId: matchId,
                courtId: match.courtId,
                startTime: match.startTime,
                endTime: Date.now(),
                duration: Date.now() - match.startTime,
                team1: match.team1,
                team2: match.team2,
                winner: winningTeam,
                newShuttleUsed: match.newShuttleUsed,
                practiceShuttleUsed: match.practiceShuttleUsed
            };

            const allPlayers = [...match.team1, ...match.team2];
            allPlayers.forEach(playerId => {
                if (!appState.history[playerId]) {
                    appState.history[playerId] = { games: [] };
                }
                appState.history[playerId].games.push(gameResult);
            });

            this.endMatch(matchId);
            saveState();

            const resultText = winningTeam === 1 ? '‡∏ó‡∏µ‡∏° 1 ‡∏ä‡∏ô‡∏∞' : winningTeam === 2 ? '‡∏ó‡∏µ‡∏° 2 ‡∏ä‡∏ô‡∏∞' : '‡πÄ‡∏™‡∏°‡∏≠';
            showSuccess(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•: ${resultText}`);
        },

        endMatch: function(matchId) {
            const matchIndex = appState.matches.findIndex(m => m.id === matchId);
            if (matchIndex === -1) return;

            const match = appState.matches[matchIndex];

            stopTimer(matchId);

            const allPlayers = [...match.team1, ...match.team2];
            allPlayers.forEach(playerId => {
                const player = PlayerUtils.getById(playerId);
                if (player) {
                    player.isPlaying = false;
                }
            });

            const court = CourtUtils.getById(match.courtId);
            if (court) {
                court.status = 'free';
                delete court.currentMatchId;
            }

            appState.matches.splice(matchIndex, 1);

            saveState();
            this.renderActiveMatches();
            this.renderCheckInList();
            this.renderDashboard();
            this.renderCourtList();
            this.renderMatchSetup();
        },

        cancelMatch: function(matchId) {
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) return;

            if (confirm(`‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(match.courtName)}?`)) {
                appState.shuttlecocks.newInPlay += 1;
                this.endMatch(matchId);
                showSuccess(`‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏™‡∏ô‡∏≤‡∏° ${escapeHtml(match.courtName)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
        },

        /**
         * Player history modal
         */
        openPlayerHistoryModal: function(playerId) {
            const player = PlayerUtils.getById(playerId);
            const history = appState.history[playerId];

            if (!player || !history || history.games.length === 0) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô');
                return;
            }

            document.getElementById('modal-player-name').textContent = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${escapeHtml(player.name)}`;

            const statsHtml = this.getPlayerStatsHtml(playerId, player, history);
            document.getElementById('modal-player-stats').innerHTML = statsHtml;

            const timelineHtml = this.getPlayerTimelineHtml(playerId, history);
            document.getElementById('modal-game-records').innerHTML = timelineHtml;

            document.getElementById('player-history-modal').classList.add('active');
        },

        closePlayerHistoryModal: function() {
            document.getElementById('player-history-modal').classList.remove('active');
        },

        getPlayerStatsHtml: function(playerId, player, history) {
            const gamesPlayed = history.games.length;

            const wins = history.games.filter(g => {
                const isTeam1 = g.team1?.includes(playerId);
                const isTeam2 = g.team2?.includes(playerId);

                if (isTeam1 && g.winner === 1) return true;
                if (isTeam2 && g.winner === 2) return true;
                return false;
            }).length;

            const draws = history.games.filter(g => g.winner === 0).length;
            const losses = gamesPlayed - wins - draws;

            const winRate = gamesPlayed > 0 ? ((wins / gamesPlayed) * 100).toFixed(1) : 0;

            return `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                        ${escapeHtml(player.name)} 
                        <span style="font-size: 0.8rem; background: var(--secondary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px;">${escapeHtml(player.skill)}</span>
                    </h4>
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="value">${gamesPlayed}</div>
                            <div class="label">‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--success);">
                            <div class="value" style="color: var(--success);">${wins}</div>
                            <div class="label">‡∏ä‡∏ô‡∏∞</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--accent);">
                            <div class="value" style="color: var(--accent);">${draws}</div>
                            <div class="label">‡πÄ‡∏™‡∏°‡∏≠</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--danger);">
                            <div class="value" style="color: var(--danger);">${losses}</div>
                            <div class="label">‡πÅ‡∏û‡πâ</div>
                        </div>
                        <div class="stat-box" style="border-left: 3px solid var(--primary);">
                            <div class="value">${winRate}%</div>
                            <div class="label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ä‡∏ô‡∏∞</div>
                        </div>
                    </div>
                </div>
            `;
        },

        getPlayerTimelineHtml: function(playerId, history) {
            const recentGames = history.games.slice().reverse();

            const timelineHTML = recentGames.map((game, index) => {
                const myTeam = game.team1?.includes(playerId) ? 1 : 2;
                const opponentTeam = myTeam === 1 ? game.team2 : game.team1;
                const opponentNames = opponentTeam.map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');
                const myTeammates = (myTeam === 1 ? game.team1 : game.team2).filter(id => id !== playerId).map(id => escapeHtml(PlayerUtils.getById(id)?.name || '???')).join(' & ');

                let resultClass = 'draw';
                let resultText = 'ü§ù ‡πÄ‡∏™‡∏°‡∏≠';
                let dotIcon = '‚ûñ';

                if ((myTeam === 1 && game.winner === 1) || (myTeam === 2 && game.winner === 2)) {
                    resultClass = 'win';
                    resultText = '‚úÖ ‡∏ä‡∏ô‡∏∞';
                    dotIcon = '‚úì';
                } else if ((myTeam === 1 && game.winner === 2) || (myTeam === 2 && game.winner === 1)) {
                    resultClass = 'loss';
                    resultText = '‚ùå ‡πÅ‡∏û‡πâ';
                    dotIcon = '‚úó';
                }

                const timeAgo = formatDate(game.startTime);
                const duration = formatTime(game.duration);

                return `
                    <div class="timeline-item">
                        <div class="timeline-dot ${resultClass}">${dotIcon}</div>
                        <div class="timeline-content ${resultClass}">
                            <div class="timeline-header">
                                <div class="timeline-title">vs ${opponentNames}</div>
                                <span class="timeline-result ${resultClass}">${resultText}</span>
                            </div>
                            <div class="timeline-opponents">
                                <strong>‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô:</strong> ${myTeammates || '-'}
                            </div>
                            <div class="timeline-meta">
                                <span>üïê ${timeAgo}</span>
                                <span>‚è±Ô∏è ${duration}</span>
                                <span>üè∏ ‡∏•‡∏π‡∏Å: ${game.newShuttleUsed} (‡πÉ‡∏´‡∏°‡πà) + ${game.practiceShuttleUsed} (‡∏ã‡πâ‡∏≠‡∏°)</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                    <h4 style="color: var(--primary); margin: 0 0 1rem 0;">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏Ç‡πà‡∏á (${history.games.length} ‡πÄ‡∏Å‡∏°)</h4>
                    <div class="timeline">${timelineHTML}</div>
                </div>
            `;
        }
    };

    // ============================================================
    // EVENT LISTENERS WITH SUBMIT STATE PROTECTION
    // ============================================================

    /**
     * Helper to prevent double submit
     */
    function createSubmitHandler(callback) {
        return function(e) {
            e.preventDefault();
            
            if (uiState.isProcessing) return;
            
            uiState.isProcessing = true;
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
            
            try {
                callback.call(this);
            } catch (error) {
                console.error('Submit error:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            } finally {
                uiState.isProcessing = false;
                if (submitBtn) submitBtn.disabled = false;
            }
        };
    }

    // Add player form
    document.getElementById('add-player-form')?.addEventListener('submit', createSubmitHandler(function() {
        const name = document.getElementById('player-name').value;
        const skill = document.getElementById('player-skill').value;
        const result = App.addPlayer(name, skill);

        if (result.success) {
            saveState();
            App.renderPlayerList();
            document.getElementById('player-name').value = '';
            showSuccess(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${escapeHtml(result.player.name)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        } else {
            showError(result.error);
        }
    }));

    // Bulk add form
    document.getElementById('bulk-add-form')?.addEventListener('submit', createSubmitHandler(function() {
        const namesText = document.getElementById('bulk-names').value;
        const skill = document.getElementById('bulk-skill').value;
        
        if (!namesText.trim()) {
            showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°');
            return;
        }

        if (!validateSkill(skill)) {
            showError('‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }

        const names = namesText.split('\n').map(n => n.trim()).filter(n => n.length > 0);

        if (names.length === 0) {
            showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }

        const added = [];
        const duplicates = [];
        const failed = [];

        names.forEach(name => {
            if (appState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                duplicates.push(name);
                return;
            }
            const result = App.addPlayer(name, skill);
            if (result.success) {
                added.push(name);
            } else {
                failed.push(`${name} (${result.error})`);
            }
        });

        saveState();
        App.renderPlayerList();

        let summary = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô\n`;
        if (added.length > 0) summary += `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${added.length} ‡∏Ñ‡∏ô\n`;
        if (duplicates.length > 0) summary += `‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥: ${duplicates.length} ‡∏Ñ‡∏ô\n`;
        if (failed.length > 0) summary += `‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${failed.length} ‡∏Ñ‡∏ô\n`;
        summary += `""""""""""""""""""\n‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${names.length} ‡∏Ñ‡∏ô`;

        alert(summary);
        document.getElementById('bulk-names').value = '';
    }));

    // Player search
    document.getElementById('player-search')?.addEventListener('input', function(e) {
        App.renderPlayerList(e.target.value);
    });

    // Bulk edit form
    document.getElementById('bulk-edit-form')?.addEventListener('submit', createSubmitHandler(function() {
        const newSkill = document.getElementById('bulk-edit-skill').value;

        if (!validateSkill(newSkill)) {
            showError('‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }

        const checkboxes = document.querySelectorAll('#bulk-edit-list input[type="checkbox"]:checked');

        if (checkboxes.length === 0) {
            showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏ô');
            return;
        }

        let updatedCount = 0;
        checkboxes.forEach(checkbox => {
            const playerId = parseInt(checkbox.dataset.playerId);
            const player = PlayerUtils.getById(playerId);
            if (player && player.skill !== newSkill) {
                player.skill = String(newSkill);
                updatedCount++;
            }
        });

        if (updatedCount > 0) {
            saveState();
            App.renderPlayerList(uiState.currentFilter);
            showSuccess(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${updatedCount} ‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${newSkill}`);
        } else {
            showWarning('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
        }
    }));

    // Add court form
    document.getElementById('add-court-form')?.addEventListener('submit', createSubmitHandler(function() {
        const name = document.getElementById('court-name').value;
        if (App.addCourt(name)) {
            document.getElementById('court-name').value = '';
        }
    }));

    // Live shuttle form
    document.getElementById('live-shuttle-form')?.addEventListener('submit', createSubmitHandler(function() {
        const action = document.getElementById('live-shuttle-action').value;
        const amount = document.getElementById('live-shuttle-amount').value;
        
        const type = action.includes('remove') ? 'practice' : action.includes('practice') ? 'practice' : 'new';
        const actualAction = action.includes('remove') ? 'remove' : 'add';
        
        App.updateGlobalShuttlecocks(actualAction, type, amount);
        document.getElementById('live-shuttle-amount').value = '1';
    }));

    // Settings shuttle form
    document.getElementById('settings-shuttle-form')?.addEventListener('submit', createSubmitHandler(function() {
        const action = document.getElementById('settings-shuttle-action').value;
        const amount = document.getElementById('settings-shuttle-amount').value;
        
        const type = action.includes('practice') ? 'practice' : 'new';
        App.updateGlobalShuttlecocks('add', type, amount);
        document.getElementById('settings-shuttle-amount').value = '1';
    }));

    // Modal close
    document.getElementById('player-history-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            App.closePlayerHistoryModal();
        }
    });

    // ============================================================
    // INITIALIZATION & CLEANUP
    // ============================================================

    window.addEventListener('load', function() {
        loadState();
        App.showView('dashboard');
    });

    window.addEventListener('beforeunload', function() {
        cleanupAllTimers();
        saveState();
    });

    // Auto save state periodically
    let autoSaveTimer;
    window.addEventListener('change', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            saveState();
        }, 2000);
    });
</script>

<!-- ==== Queue Editors v13 (full: searchable dropdowns + skill emoji + dnd + no-dup + red highlight + reset/auto + stats) ==== -->
<!-- Choices.js for searchable selects -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<!-- Chart.js for stats -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* Controls bar above queue list */
  .queue-controls {
    display:flex; gap:.5rem; flex-wrap:wrap;
    padding:.5rem 0; margin:.5rem 0 1rem 0;
  }
  .qc-btn {
    border:1px solid #c2c8cf; background:#f9fafb; color:#333;
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:.9rem;
  }
  .qc-btn:hover { background:#edf2f7; }
  .qc-btn.danger { border-color:#fda4a4; background:#fee2e2; color:#991b1b; }
  .qc-btn.primary { border-color:#6cb6ff; background:#eef6ff; color:#004c8c; }
  .qc-btn.success { border-color:#86efac; background:#dcfce7; color:#065f46; }

  /* v12 styles (editor, dnd, dup highlight) */
  .queue-inline-editor{margin-top:.75rem;padding:.75rem;background:#f9fafb;border:1px solid #d0d7de;border-radius:10px;color:#222;display:none}
  .queue-inline-row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
  .queue-inline-group{display:flex;flex-direction:column;gap:.35rem}
  .queue-inline-label{font-size:.8rem;color:#444}
  .queue-inline-select{width:100%;padding:6px 8px;font-size:.9rem;border:1px solid #b6c0ca;border-radius:8px;background:#fff;color:#111;cursor:pointer}
  .queue-inline-select option{color:#111;background:#fff}
  .queue-inline-title{font-weight:700;font-size:.9rem;color:#0f6cbd;display:flex;align-items:center;justify-content:space-between;margin:0 0 .5rem 0}
  .queue-tools{display:flex;gap:.5rem;flex-wrap:wrap}
  .queue-tool-btn{border:1px solid #c2c8cf;background:#f9fafb;color:#333;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:500}
  .queue-tool-btn:hover{background:#edf2f7}
  .queue-card-toggle{border:1px solid #6cb6ff;background:#f0f8ff;color:#004c8c;padding:4px 10px;border-radius:8px;cursor:pointer;font-size:.8rem;font-weight:600}
  .queue-drag-handle{border:1px dashed #b6c0ca;background:#fff;color:#555;padding:4px 10px;border-radius:8px;cursor:grab;font-size:.8rem;margin-left:.25rem}
  .queue-card.dragging{opacity:.6}
  .queue-card.drop-target{outline:2px dashed #22c55e; outline-offset:4px}
  .dup-badge{display:inline-flex;align-items:center;gap:6px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:999px;padding:2px 8px;font-size:.75rem;margin-left:.5rem}
  .dup-player { color: #b91c1c !important; font-weight: 700; }
  .queue-player-line { display:inline; }

  /* Stats modal */
  .stats-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:9999}
  .stats-modal{background:#fff;color:#111;max-width:900px;width:92vw;border-radius:14px;padding:16px;border:1px solid #d0d7de;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .stats-modal h3{margin:0 0 .5rem 0}
  .stats-modal .row{display:flex;gap:1rem;flex-wrap:wrap}
  .stats-modal .actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.5rem}
  .sm-btn{border:1px solid #c2c8cf;background:#f9fafb;color:#333;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .sm-btn:hover{background:#edf2f7}
  @media (max-width:640px){ .queue-inline-row{ grid-template-columns:1fr; } }
</style>

<script>
(function(){
  // ===== Emoji by skill =====
  const skillEmoji = { "N":"üü¢", "N+":"üîµ", "BG":"üü£", "B":"üü§", "A":"üü†", "S":"üü°" };
  const skillRank = { "N":1, "N+":2, "BG":3, "B":4, "A":5, "S":6 };

  // ===== Open editor state =====
  const OPEN_KEY = "queue_editor_open_ids";
  function loadOpenSet(){ try{ return new Set(JSON.parse(localStorage.getItem(OPEN_KEY)||"[]")); }catch(e){ return new Set(); } }
  function saveOpenSet(set){ try{ localStorage.setItem(OPEN_KEY, JSON.stringify(Array.from(set))); }catch(e){} }
  const openSet = loadOpenSet();

  // ===== Duplicate helpers =====
  function getUsedAcross(except){
    const used = new Set();
    (appState.matchQueues||[]).forEach(q => {
      (q.team1||[]).forEach((id, idx)=>{
        if (except && except.queueId===q.id && except.teamNo===1 && except.slotIndex===idx) return;
        used.add(id);
      });
      (q.team2||[]).forEach((id, idx)=>{
        if (except && except.queueId===q.id && except.teamNo===2 && except.slotIndex===idx) return;
        used.add(id);
      });
    });
    return used;
  }
  function getDuplicateIdSet(){
    const count = new Map();
    (appState.matchQueues||[]).forEach(q => {
      [...(q.team1||[]), ...(q.team2||[])].forEach(id => count.set(id, (count.get(id)||0)+1));
    });
    const dups = new Set(); for (const [id,c] of count.entries()){ if (c>1) dups.add(id); }
    return dups;
  }

  // ===== Build dropdown options with search labels (emoji + skill) and no-dup rule =====
  function playerLabel(p){
    const em = skillEmoji[p?.skill] || "";
    const nm = escapeHtml(p?.name || "???");
    const sk = escapeHtml(p?.skill || "?");
    return `${em} ${nm} (${sk})`;
  }
  function buildOptions(queue, teamNo, slotIndex){
    const currentId = (teamNo === 1 ? queue.team1[slotIndex] : queue.team2[slotIndex]);
    const excludeWithin = new Set([...queue.team1, ...queue.team2].filter(id => id !== currentId));
    const usedAcross = getUsedAcross({queueId: queue.id, teamNo, slotIndex});
    const candidates = (appState.players||[])
      .filter(p => p.isCheckedIn && !p.isPlaying && !excludeWithin.has(p.id) && !usedAcross.has(p.id))
      .sort((a,b) => a.name.localeCompare(b.name, 'th'));

    const cur = PlayerUtils.getById(currentId);
    const curLabel = cur ? playerLabel(cur) : '???';

    let opts = `<option value="${currentId}" selected>‚Ä¢ ${curLabel} ‚Äî ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</option>`;
    if (candidates.length){
      opts += `<option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡∏ô (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏∑‡πà‡∏ô) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>`;
      for (const p of candidates){
        opts += `<option value="${p.id}">${playerLabel(p)}</option>`;
      }
    } else {
      opts += `<option value="" disabled>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏∑‡πà‡∏ô)</option>`;
    }
    return opts;
  }

  // ===== Controls bar (Reset / Auto-Match / Stats) =====
  function ensureControlsBar(){
    const listEl = document.getElementById('queue-list');
    if (!listEl) return;
    if (document.querySelector('.queue-controls')) return;
    const bar = document.createElement('div');
    bar.className = 'queue-controls';
    bar.innerHTML = `
      <button class="qc-btn danger" id="qc-reset">üîÅ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="qc-btn success" id="qc-auto">‚ö° ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
      <button class="qc-btn primary" id="qc-stats">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
    `;
    listEl.parentNode.insertBefore(bar, listEl);
    // Hook
    bar.querySelector('#qc-reset').addEventListener('click', onResetQueues);
    bar.querySelector('#qc-auto').addEventListener('click', onAutoMatch);
    bar.querySelector('#qc-stats').addEventListener('click', openStats);
  }

  function onResetQueues(){
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
    appState.matchQueues = [];
    saveState();
    App.renderQueueList();
    showSuccess('‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
  }

  function onAutoMatch(){
    // Candidates: checked-in, not playing, and not used in any queue
    const usedAcross = getUsedAcross();
    const candidates = (appState.players||[])
      .filter(p => p.isCheckedIn && !p.isPlaying && !usedAcross.has(p.id))
      .slice();
    if (candidates.length < 4){
      showWarning('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
      return;
    }
    // Shuffle
    for (let i=candidates.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1)); const t=candidates[i]; candidates[i]=candidates[j]; candidates[j]=t;
    }
    // Group by 4 and try to balance skills
    function skillScore(s){ return skillRank[s] || 1; }
    const newQueues = [];
    let idCounter = Math.max(0, ...(appState.matchQueues||[]).map(q=>q.id||0)) + 1;
    for (let i=0;i+3<candidates.length;i+=4){
      const group = candidates.slice(i,i+4);
      // sort by skill to split strong & weak
      group.sort((a,b)=> (skillScore(b.skill)-skillScore(a.skill)));
      // simple balance: strongest+weakest vs 2nd+3rd
      const team1 = [group[0].id, group[3].id];
      const team2 = [group[1].id, group[2].id];
      newQueues.push({ id: idCounter++, team1, team2, createdAt: Date.now() });
    }
    if (!newQueues.length){
      showWarning('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ');
      return;
    }
    // Append
    appState.matchQueues = [...(appState.matchQueues||[]), ...newQueues];
    saveState();
    App.renderQueueList();
    showSuccess(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${newQueues.length} ‡∏Ñ‡∏¥‡∏ß`);
  }

  // ===== Per-card UI =====
  function ensureCardControls(cardEl, queue){
    const header = cardEl.querySelector('.queue-card-header') || cardEl.firstElementChild || cardEl;
    if (!header.querySelector(`.queue-card-toggle[data-qid="${queue.id}"]`)){
      const btn = document.createElement('button');
      btn.className = 'queue-card-toggle';
      btn.dataset.qid = queue.id;
      btn.textContent = 'üñãÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠';
      header.appendChild(btn);
    }
    if (!header.querySelector(`.queue-drag-handle[data-qid="${queue.id}"]`)){
      const dragBtn = document.createElement('button');
      dragBtn.className = 'queue-drag-handle';
      dragBtn.dataset.qid = queue.id;
      dragBtn.textContent = '‚Üï ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á';
      header.appendChild(dragBtn);
    }
    if (!header.querySelector(`.dup-badge[data-qid="${queue.id}"]`)){
      const dup = document.createElement('span');
      dup.className = 'dup-badge';
      dup.dataset.qid = queue.id;
      dup.textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏∑‡πà‡∏ô';
      dup.style.display = 'none';
      header.appendChild(dup);
    }
    if (!cardEl.getAttribute('draggable')) cardEl.setAttribute('draggable', 'true');

    let editor = cardEl.querySelector(`.queue-inline-editor[data-qid="${queue.id}"]`);
    if (!editor){
      editor = document.createElement('div');
      editor.className = 'queue-inline-editor';
      editor.dataset.qid = queue.id;
      editor.innerHTML = `
        <div class="queue-inline-title">
          <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</span>
          <div class="queue-tools">
            <button class="queue-tool-btn" data-action="swap-in" data-qid="${queue.id}">‚áÑ ‡∏™‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏ó‡∏µ‡∏°</button>
            <button class="queue-tool-btn" data-action="swap-cross" data-qid="${queue.id}">‚áÑ ‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏µ‡∏°</button>
          </div>
        </div>
        <div class="queue-inline-row">
          <div class="queue-inline-group">
            <div class="queue-inline-label">‡∏ó‡∏µ‡∏° 1 - ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1</div>
            <select class="queue-inline-select" data-qid="${queue.id}" data-team="1" data-slot="0">${buildOptions(queue,1,0)}</select>
          </div>
          <div class="queue-inline-group">
            <div class="queue-inline-label">‡∏ó‡∏µ‡∏° 1 - ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 2</div>
            <select class="queue-inline-select" data-qid="${queue.id}" data-team="1" data-slot="1">${buildOptions(queue,1,1)}</select>
          </div>
          <div class="queue-inline-group">
            <div class="queue-inline-label">‡∏ó‡∏µ‡∏° 2 - ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1</div>
            <select class="queue-inline-select" data-qid="${queue.id}" data-team="2" data-slot="0">${buildOptions(queue,2,0)}</select>
          </div>
          <div class="queue-inline-group">
            <div class="queue-inline-label">‡∏ó‡∏µ‡∏° 2 - ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 2</div>
            <select class="queue-inline-select" data-qid="${queue.id}" data-team="2" data-slot="1">${buildOptions(queue,2,1)}</select>
          </div>
        </div>
      `;
      cardEl.appendChild(editor);
    }
    editor.style.display = openSet.has(String(queue.id)) ? 'block' : 'none';

    // Initialize Choices on these selects
    initChoices(editor.querySelectorAll('.queue-inline-select'));
  }

  // ===== Choices init (searchable) =====
  function initChoices(nodeList){
    if (!window.Choices) return; // CDN not loaded yet
    nodeList.forEach(sel => {
      if (sel._choicesInstance) return;
      const ch = new Choices(sel, {
        searchEnabled: true,
        shouldSort: false,
        itemSelectText: '',
        removeItemButton: false,
        placeholder: false,
        searchPlaceholderValue: '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...',
        position: 'bottom'
      });
      sel._choicesInstance = ch;
    });
  }

  // ===== Duplicate marking & red highlight =====
  function markDuplicates(){
    const countById = new Map();
    (appState.matchQueues||[]).forEach(q => {
      [...(q.team1||[]), ...(q.team2||[])].forEach(id => {
        countById.set(id, (countById.get(id) || 0) + 1);
      });
    });
    (appState.matchQueues||[]).forEach(q => {
      const hasDup = [...q.team1, ...q.team2].some(id => (countById.get(id) || 0) > 1);
      const badge = document.querySelector(`.dup-badge[data-qid="${q.id}"]`);
      if (badge) badge.style.display = hasDup ? 'inline-flex' : 'none';
    });
  }
  function buildNamesHTML(ids, dupSet){
    return ids.map((pid, idx) => {
      const p = PlayerUtils.getById(pid);
      const nm = escapeHtml(p?.name || '???');
      const em = skillEmoji[p?.skill] || '';
      const cls = dupSet.has(pid) ? 'dup-player' : '';
      const span = `<span class="queue-player-line ${cls}">${em} ${nm}</span>`;
      return idx === 0 ? span : ` <span>&amp;</span> ` + span;
    }).join('');
  }
  function applyDuplicateHighlight(){
    const listEl = document.getElementById('queue-list');
    if (!listEl) return;
    const cards = Array.from(listEl.children).filter(el => el.nodeType===1);
    const dupSet = getDuplicateIdSet();

    for (let i=0; i<(appState.matchQueues||[]).length && i<cards.length; i++){
      const q = appState.matchQueues[i];
      const card = cards[i];
      const teamPlayerEls = card.querySelectorAll('.queue-team .queue-team-players');
      if (teamPlayerEls && teamPlayerEls.length >= 2){
        teamPlayerEls[0].innerHTML = buildNamesHTML(q.team1, dupSet);
        teamPlayerEls[1].innerHTML = buildNamesHTML(q.team2, dupSet);
        continue;
      }
      const teamSections = card.querySelectorAll('.queue-team');
      if (teamSections && teamSections.length >= 2){
        const ensureLine = (teamEl) => {
          let line = teamEl.querySelector('.queue-team-players');
          if (!line){
            line = document.createElement('div');
            line.className = 'queue-team-players';
            teamEl.appendChild(line);
          }
          return line;
        };
        ensureLine(teamSections[0]).innerHTML = buildNamesHTML(q.team1, dupSet);
        ensureLine(teamSections[1]).innerHTML = buildNamesHTML(q.team2, dupSet);
      }
    }
  }

  // ===== Drag & Drop reorder =====
  let dragState = { srcIndex: null };
  function installDrag(listEl){
    if (listEl.__queueDnDInstalled) return;
    listEl.addEventListener('dragstart', (e)=>{
      const card = e.target.closest('.queue-card');
      if (!card) return;
      dragState.srcIndex = +card.dataset.queueIndex;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try{ e.dataTransfer.setData('text/plain','queue-card'); }catch(_){}
    });
    listEl.addEventListener('dragend', (e)=>{
      const card = e.target.closest('.queue-card');
      if (card) card.classList.remove('dragging');
      Array.from(listEl.children).forEach(el=> el.classList && el.classList.remove('drop-target'));
      dragState.srcIndex = null;
    });
    listEl.addEventListener('dragover', (e)=>{
      const overCard = e.target.closest('.queue-card');
      if (!overCard) return;
      e.preventDefault();
      Array.from(listEl.children).forEach(el=> el.classList && el.classList.remove('drop-target'));
      overCard.classList.add('drop-target');
    });
    listEl.addEventListener('drop', (e)=>{
      const tgtCard = e.target.closest('.queue-card');
      if (!tgtCard) return;
      e.preventDefault();
      const dstIndex = +tgtCard.dataset.queueIndex;
      const srcIndex = dragState.srcIndex;
      Array.from(listEl.children).forEach(el=> el.classList && el.classList.remove('drop-target'));
      if (srcIndex==null || srcIndex===dstIndex) return;

      const arr = (appState.matchQueues||[]).slice();
      const [moved] = arr.splice(srcIndex,1);
      arr.splice(dstIndex,0,moved);
      appState.matchQueues = arr;
      saveState();
      App.renderQueueList();
      showSuccess('‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    });
    listEl.__queueDnDInstalled = true;
  }

  // ===== Stats modal =====
  function ensureStatsModal(){
    if (document.querySelector('.stats-backdrop')) return;
    const backdrop = document.createElement('div');
    backdrop.className = 'stats-backdrop';
    backdrop.innerHTML = `
      <div class="stats-modal">
        <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
        <div class="row">
          <canvas id="statsChart" height="280"></canvas>
        </div>
        <div class="actions">
          <button class="sm-btn" id="sm-close">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    backdrop.addEventListener('click', (e)=>{
      if (e.target.classList.contains('stats-backdrop')) closeStats();
    });
    backdrop.querySelector('#sm-close').addEventListener('click', closeStats);
  }
  function openStats(){
    ensureStatsModal();
    const el = document.querySelector('.stats-backdrop');
    el.style.display = 'flex';
    renderStatsChart();
  }
  function closeStats(){
    const el = document.querySelector('.stats-backdrop');
    if (el) el.style.display = 'none';
  }
  function renderStatsChart(){
    const ctx = document.getElementById('statsChart');
    if (!ctx) return;
    const hist = (appState.matchHistory||[]);
    // Try to normalize: support shapes {playerId, playerName, matches} or entries per match {playerId, playerName}
    const map = new Map();
    hist.forEach(h => {
      const name = h.playerName || h.name || (PlayerUtils.getById(h.playerId)?.name) || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
      const m = (typeof h.matches === 'number') ? h.matches : 1;
      map.set(name, (map.get(name)||0) + m);
    });
    const labels = Array.from(map.keys());
    const data = Array.from(map.values());

    // Sort descending for better readability
    const zipped = labels.map((l,i)=>({l, v:data[i]})).sort((a,b)=>b.v-a.v);
    const sortedLabels = zipped.map(z=>z.l);
    const sortedData = zipped.map(z=>z.v);

    // Destroy previous if exists
    if (window.__statsChart) { window.__statsChart.destroy(); }

    window.__statsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedLabels,
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå',
          data: sortedData
        }]
      },
      options: {
        indexAxis: 'y', // horizontal bars
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { beginAtZero: true, ticks: { precision: 0 } },
          y: { ticks: { autoSkip: false } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        }
      }
    });
  }

  // ===== Event delegation =====
  if (!window.__queueV13HandlersInstalled){
    document.addEventListener('click', function(ev){
      const btn = ev.target.closest('.queue-card-toggle');
      if (btn){
        const card = btn.closest('.queue-card') || btn.closest('*');
        const qid = String(btn.dataset.qid);
        const editor = (card && card.querySelector(`.queue-inline-editor[data-qid="${qid}"]`)) ||
                       document.querySelector(`.queue-inline-editor[data-qid="${qid}"]`);
        if (!editor) return;
        const willShow = (editor.style.display === 'none' || editor.style.display === '');
        editor.style.display = willShow ? 'block' : 'none';
        if (willShow) openSet.add(qid); else openSet.delete(qid);
        saveOpenSet(openSet);
        return;
      }
      const sw = ev.target.closest('.queue-tool-btn');
      if (sw){
        const qid = +sw.dataset.qid;
        const q = (appState.matchQueues||[]).find(x => x.id === qid);
        if (!q){ showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏'); return; }
        const action = sw.dataset.action;
        if (action==='swap-in'){
          if (q.team1.length>=2){ const t=q.team1[0]; q.team1[0]=q.team1[1]; q.team1[1]=t; }
          if (q.team2.length>=2){ const t2=q.team2[0]; q.team2[0]=q.team2[1]; q.team2[1]=t2; }
          saveState(); App.renderQueueList(); showSuccess('‡∏™‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }else if(action==='swap-cross'){
          if (q.team1.length>=2 && q.team2.length>=2){
            const t0=q.team1[0]; q.team1[0]=q.team2[0]; q.team2[0]=t0;
            const t1=q.team1[1]; q.team1[1]=q.team2[1]; q.team2[1]=t1;
            saveState(); App.renderQueueList(); showSuccess('‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          } else { showWarning('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏µ‡∏°'); }
        }
        return;
      }
    });

    document.addEventListener('change', function(ev){
      const sel = ev.target.closest('.queue-inline-select');
      if (!sel) return;
      const qid = +sel.dataset.qid, teamNo = +sel.dataset.team, slot = +sel.dataset.slot;
      const q = (appState.matchQueues||[]).find(x => x.id === qid); if (!q){ showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏'); return; }
      const currentId = (teamNo===1 ? q.team1[slot] : q.team2[slot]);
      const val = sel.value; if (!val) return;
      const newId = parseInt(val,10); if (Number.isNaN(newId)) return;

      const usedAcross = getUsedAcross({queueId: q.id, teamNo, slotIndex: slot});
      if (usedAcross.has(newId)){
        showError('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
        // Revert selection (also Choices UI if present)
        if (sel._choicesInstance){
          sel._choicesInstance.setChoiceByValue(String(currentId));
        } else {
          sel.value = String(currentId);
        }
        return;
      }
      if (teamNo===1) q.team1[slot] = newId; else q.team2[slot] = newId;
      saveState(); App.renderQueueList(); showSuccess('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
    });

    window.__queueV13HandlersInstalled = true;
  }

  // ===== Enhance on render =====
  function enhance(){
    const listEl = document.getElementById('queue-list');
    if (!listEl) return;
    ensureControlsBar();
    const cards = Array.from(listEl.children).filter(el => el.nodeType===1);
    for (let i=0; i<(appState.matchQueues||[]).length && i<cards.length; i++){
      const card = cards[i];
      ensureCardControls(card, appState.matchQueues[i]);
      card.dataset.queueIndex = i;
      card.classList.add('queue-card');
    }
    installDrag(listEl);
    markDuplicates();
    applyDuplicateHighlight();
  }

  // ===== Hook into App.renderQueueList =====
  const __origRender = App.renderQueueList.bind(App);
  App.renderQueueList = function(){
    __origRender();
    try{ enhance(); }catch(e){ console.error('enhance v13 error', e); }
  };

  // First pass (in case currently on queue tab)
  setTimeout(()=>{ try{ enhance(); }catch(e){} }, 0);

  // Expose for debug (optional)
  window.__queueEnhanceV13 = { onAutoMatch, onResetQueues, openStats };
})();
</script>
<!-- ==== /Queue Editors v13 ==== -->


<!-- ==== Consume queue on play (wrap App.callQueueToPlay) ==== -->
<script>
(function(){
  if (!window.__consumeOnPlayInstalled){
    const __origCall = App.callQueueToPlay ? App.callQueueToPlay.bind(App) : null;
    App.callQueueToPlay = function(queueId){
      // 1) Run original behavior first (assign to court / mark playing, etc.)
      try {
        if (typeof __origCall === 'function') __origCall(queueId);
      } catch(e){
        console.error('Original callQueueToPlay error:', e);
      }

      // 2) Remove the queue from waiting list if it still exists
      try {
        const arr = appState.matchQueues || [];
        const idx = arr.findIndex(q => q && q.id === queueId);
        if (idx >= 0) {
          arr.splice(idx, 1);
          appState.matchQueues = arr;
          saveState();
          showSuccess('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Äì ‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠');
        }
      } catch(e){
        console.error('consume-on-play removal error:', e);
      }

      // 3) Re-render the queue list (and let enhancers re-attach)
      try {
        if (typeof App.renderQueueList === 'function') App.renderQueueList();
      } catch(e){
        console.error('render after consume error:', e);
      }
    };
    window.__consumeOnPlayInstalled = true;
  }
})();
</script>


<!-- ==== Auto-log match history on play (v15) ==== -->
<script>
(function(){
  if (!window.__autoLogOnPlayInstalled){
    const __prevCall = App.callQueueToPlay ? App.callQueueToPlay.bind(App) : null;
    App.callQueueToPlay = function(queueId){
      // Snapshot queue before it's removed by previous wrapper
      let snapshot = null;
      try{
        const q = (appState.matchQueues || []).find(x => x && x.id === queueId);
        if (q){
          snapshot = JSON.parse(JSON.stringify(q));
        }
      }catch(e){ console.warn('snapshot error', e); }

      // Run previous wrapped behavior (assign court + remove from waiting)
      if (typeof __prevCall === 'function'){
        try{ __prevCall(queueId); }catch(e){ console.error('prev callQueueToPlay error', e); }
      }

      // Append to matchHistory per player for stats
      try{
        if (snapshot){
          if (!Array.isArray(appState.matchHistory)) appState.matchHistory = [];
          const allIds = [...(snapshot.team1 || []), ...(snapshot.team2 || [])];
          allIds.forEach(id => {
            const p = PlayerUtils.getById(id);
            appState.matchHistory.push({
              playerId: id,
              playerName: p ? p.name : ('#'+id),
              matches: 1,
              timestamp: Date.now(),
              queueId: snapshot.id,
              source: 'callQueueToPlay'
            });
          });
          saveState();
          // If stats modal is open, try to refresh chart
          if (document.querySelector('.stats-backdrop') && document.querySelector('.stats-backdrop').style.display === 'flex'){
            if (window.__statsChart){ try{ window.__statsChart.destroy(); }catch(e){} }
            if (typeof renderStatsChart === 'function'){ renderStatsChart(); }
          }
        }
      }catch(e){ console.error('auto-log history error', e); }
    };
    window.__autoLogOnPlayInstalled = true;
  }
})();
</script>





<script>
window.addEventListener("load", function() {
  if (!window.App) {
    console.warn("App ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô window");
    return;
  }

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  window.App.clearAllHistory = function() {
    if (!window.appState) {
      alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤");
      return;
    }
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà")) return;

    try {
      for (const playerId in appState.history) {
        if (appState.history[playerId] && Array.isArray(appState.history[playerId].games)) {
          appState.history[playerId].games = [];
        }
      }
      appState.matches = [];
      if (typeof saveState === "function") saveState();
      if (typeof App.renderDashboard === "function") App.renderDashboard();
      if (typeof App.renderPlayerList === "function") App.renderPlayerList();
      if (typeof showSuccess === "function") showSuccess("‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
    } catch (e) {
      console.error(e);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥");
    }
  };
});
</script>


<!-- ======= Game Count Mirror Sync (from Check-In) ======= -->
<script>
(function(){
  console.log('[SYNC] Mirror from Check-In initialized');

  function norm(s){ return (s||'').toString().trim(); }

  function getCheckInCounts(){
    const data = {};
    document.querySelectorAll('.check-in-card, .checkin .check-in-card, #check-in-list .check-in-card').forEach(card=>{
      const nameEl = card.querySelector('.player-name, .player');
      const countEl = card.querySelector('.status-count, .player-skill, small');
      if (!nameEl) return;
      const name = norm(nameEl.textContent).replace(/\(\s*\d+\s*‡πÄ‡∏Å‡∏°\)$/,'').trim();
      if (!name) return;
      // Extract count number
      let count = 0;
      if (countEl) {
        const t = norm(countEl.textContent);
        const m = t.match(/(\d+)\s*‡πÄ‡∏Å‡∏°/);
        if (m) count = parseInt(m[1]);
        else if (!isNaN(parseInt(t))) count = parseInt(t);
      }
      // fallback scan in whole card
      if (!count) {
        const m2 = norm(card.textContent).match(/(\d+)\s*‡πÄ‡∏Å‡∏°/);
        if (m2) count = parseInt(m2[1]);
      }
      data[name] = count;
    });
    return data;
  }

  function updateQueueCounts(){
    const counts = getCheckInCounts();
    if (!Object.keys(counts).length) return;

    document.querySelectorAll('.queue-player-line, .queue-player-name, .queue-player, .queue-card .queue-team-players span, .queue-card .queue-team-players div').forEach(el=>{
      const txt = norm(el.textContent).replace(/\(\s*\d+\s*‡πÄ‡∏Å‡∏°\)$/,'').trim();
      if (!txt) return;
      for (const [name,count] of Object.entries(counts)){
        if (txt.includes(name)){
          el.textContent = `${txt} (${count} ‡πÄ‡∏Å‡∏°)`;
          break;
        }
      }
    });
  }

  const runSync = ()=>{
    updateQueueCounts();
  };

  // Observe DOM changes to auto-update
  const obsTargets = ['#queue-list', '.queue-section', 'main'];
  obsTargets.forEach(sel=>{
    const el = document.querySelector(sel);
    if (el){
      const mo = new MutationObserver(()=> setTimeout(runSync,150));
      mo.observe(el,{childList:true,subtree:true});
    }
  });

  // periodic fallback
  setInterval(runSync, 3000);
  document.addEventListener('DOMContentLoaded', ()=>setTimeout(runSync,1000));
})();
</script>

</body>
</html>