<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô</title>
    <style>
        :root {
            --primary: #1a2b47;
            --secondary: #00a8cc;
            --accent: #f39c12;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a3c;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light);
            margin: 0;
            padding: 0;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        nav {
            background-color: var(--white);
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav button {
            background-color: transparent;
            color: var(--dark);
            border: none;
            padding: 1rem 1.2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        nav button:hover, nav button.active {
            background-color: rgba(0, 168, 204, 0.1);
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        main {
            padding: 1.5rem 0;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--light);
            padding-bottom: 0.75rem;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .card h3 {
            color: var(--secondary);
            margin-top: 1.5rem;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        form div {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 168, 204, 0.2);
        }

        button {
            background-color: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            min-height: 48px; /* Easier to tap */
        }

        button:hover {
            background-color: #0089a9;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.danger { background-color: var(--danger); }
        button.danger:hover { background-color: #c0392b; }
        button.success { background-color: var(--success); }
        button.success:hover { background-color: #229954; }
        button.warning { background-color: var(--accent); }
        button.warning:hover { background-color: #e67e22; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏°‡∏≠ */
        button.draw { background-color: #f1c40f; color: var(--dark); }
        button.draw:hover { background-color: #d8ac0c; }


        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        li {
            background-color: var(--light);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.3s;
        }
        li:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .skill-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            color: var(--white);
            font-size: 0.8rem;
            font-weight: bold;
        }
        .skill-P { background-color: var(--success); }
        .skill-Nminus { background-color: #2c3e50; } 
        .skill-N { background-color: var(--secondary); }
        .skill-Nplus { background-color: #e67e22; }
        .skill-BG { background-color: #95a5a6; }

        /* Check-in Card Style */
        .check-in-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }
        .check-in-card {
            background-color: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .check-in-card:hover:not(.checked-in) {
            border-color: var(--secondary);
            transform: scale(1.05);
        }
        .check-in-card.checked-in {
            background-color: #e8f5e9;
            border-color: var(--success);
            cursor: default;
        }
        .check-in-card.playing-now {
            background-color: #fff3e0; 
            border-color: var(--accent);
        }
        .check-in-card .player-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .check-in-card .player-skill {
            font-size: 0.8rem;
        }
        .check-in-card .status-icon {
            font-size: 1.5rem;
            margin-top: 0.5rem;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background-color: var(--white);
        }
        .player-item input[type="checkbox"] {
            min-width: 20px;
            min-height: 20px;
            margin-right: 1rem;
        }
        .player-item label {
            margin-bottom: 0;
            cursor: pointer;
            flex-grow: 1;
        }
        .player-name-link {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        .player-name-link:hover {
            text-decoration: underline;
        }

        /* Manual Selection Card Style */
        .manual-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .manual-selection-card {
            background-color: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .manual-selection-card:hover {
            border-color: var(--secondary);
        }
        .manual-selection-card.selected {
            background-color: #e0f7fa;
            border-color: var(--secondary);
            transform: scale(1.05);
        }
        .manual-selection-card .selection-order {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--secondary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .manual-selection-card .player-name {
            font-weight: 600;
        }
        .manual-selection-card .player-skill {
            font-size: 0.8rem;
        }
        .manual-selection-card .game-count {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
        }

        .match-card {
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--secondary);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--white);
        }
        .match-card h3 { margin-top: 0; }
        .match-teams { display: flex; justify-content: space-around; align-items: center; margin: 1.5rem 0; flex-wrap: wrap; gap: 1rem; }
        .team { text-align: center; min-width: 120px; }
        .team p { margin: 0.25rem 0; }
        .vs { font-size: 1.5rem; font-weight: bold; color: #888; }
        .match-controls { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .timer { font-size: 1.8rem; font-weight: bold; color: var(--primary); text-align: center; margin: 1rem 0; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .stat-card {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }
        .stat-card h4 { margin-top: 0; color: var(--secondary); }
        .stat-card .big-number { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        .stat-card p { margin: 0.5rem 0; }

        .shuttle-counter {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .shuttle-counter div {
            text-align: center;
        }
        .shuttle-counter .count {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* Per-court shuttle control */
        .court-shuttle-control {
            display: flex;
            flex-direction: column;
            gap: 10px; 
            padding: 0.75rem;
            background-color: #f0f8ff;
            border-radius: 8px;
            margin-top: 0.5rem;
        }
        .shuttle-control-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }
        .court-shuttle-control button {
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            min-height: auto;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
        }
        .court-shuttle-control .shuttle-label {
            font-weight: bold;
            min-width: 80px;
            text-align: right;
            color: var(--primary);
        }
        .court-shuttle-control .shuttle-count-display {
            font-weight: bold;
            font-size: 1.2rem;
            min-width: 30px;
            text-align: center;
            background-color: var(--white);
            padding: 0 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .dashboard-card {
            background: linear-gradient(135deg, var(--white), var(--light));
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .dashboard-card .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .dashboard-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        .dashboard-card .label {
            color: var(--dark);
            font-weight: 500;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        .quick-actions button {
            flex: 1;
            min-width: 200px;
        }
        
        /* Dashboard Player Stats */
        .dashboard-player-stats {
            margin-top: 2rem;
        }
        .dashboard-player-stats h3 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .dashboard-player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
        }
        .dashboard-player-card {
            background-color: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: box-shadow 0.3s;
            cursor: pointer;
        }
        .dashboard-player-card:hover {
            box-shadow: var(--shadow);
        }
        .dashboard-player-card .player-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .dashboard-player-card .player-skill {
            font-size: 0.7rem;
            margin: 0.25rem 0;
        }
        .dashboard-player-card .game-count {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        /* Edit Mode */
        .edit-mode input, .edit-mode select {
            background-color: #fff3cd;
            border-color: var(--accent);
        }
        .edit-form {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1.5rem;
        }
        .bulk-edit-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }
        .bulk-edit-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .bulk-edit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 4px;
        }


        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            header h1 { font-size: 1.5rem; }
            nav button { padding: 0.8rem 0.5rem; font-size: 0.9rem; }
            .card { padding: 1rem; }
            .match-teams { flex-direction: column; }
            .vs { transform: rotate(90deg); }
            .check-in-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            .manual-selection-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
            .dashboard-player-list { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <h1>üè∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏ö‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡∏ô üè∏</h1>
        </div>
    </header>

    <nav>
        <button onclick="showView('dashboard')" class="active">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        <button onclick="showView('player-management')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
        <button onclick="showView('check-in')">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</button>
        <button onclick="showView('match-setup')">‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà/‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å</button>
        <button onclick="showView('active-matches')">‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô</button>
        <button onclick="showView('player-history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
        <button onclick="showView('settings')">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button onclick="showView('manager-tools')">‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
    </nav>

    <main class="container">
        <section id="dashboard" class="view active">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="icon">üë•</div>
                    <div class="value" id="dash-total-players">0</div>
                    <div class="label">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">‚úÖ</div>
                    <div class="value" id="dash-checked-in">0</div>
                    <div class="label">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">üèüÔ∏è</div>
                    <div class="value" id="dash-active-matches">0</div>
                    <div class="label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">üè∏</div>
                    <div class="value" id="dash-shuttle-in-play">0</div>
                    <div class="label">‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</div>
                </div>
            </div>
            
            <div class="dashboard-player-stats">
                <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</h3>
                <div id="dashboard-player-list" class="dashboard-player-list"></div>
            </div>

            <div class="quick-actions">
                <button class="success" onclick="navigateAndShow('player-management')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
                <button class="warning" onclick="navigateAndShow('match-setup')">üé≤ ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡πà‡∏ô</button>
                <button onclick="navigateAndShow('active-matches')">‚è±Ô∏è ‡∏î‡∏π‡∏™‡∏ô‡∏≤‡∏°</button>
            </div>
        </section>

        <section id="player-management" class="view">
            <div class="card">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</h2>
                <form id="add-player-form">
                    <div>
                        <label for="player-name">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
                        <input type="text" id="player-name" required>
                    </div>
                    <div>
                        <label for="player-skill">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠:</label>
                        <select id="player-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</h2>
                <p>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô (‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏∞ 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                <form id="bulk-add-form">
                    <div style="width: 100%;">
                        <label for="bulk-names">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠:</label>
                        <textarea id="bulk-names" rows="5" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢&#10;‡∏™‡∏°‡∏®‡∏£‡∏µ&#10;‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á"></textarea>
                    </div>
                    <div>
                        <label for="bulk-skill">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô):</label>
                        <select id="bulk-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <input type="text" id="player-search" class="search-bar" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...">
                <ul id="player-list"></ul>
            </div>
            <div class="card bulk-edit-section">
                <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</h3>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏∞ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</p>
                <div class="bulk-edit-list" id="bulk-edit-list"></div>
                <form id="bulk-edit-form">
                    <div>
                        <label for="bulk-edit-skill">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà:</label>
                        <select id="bulk-edit-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N">N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="check-in" class="view">
            <div class="card">
                <h2>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
                <p>‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏£‡∏≠‡∏ö) ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏à‡∏∞‡∏°‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô üè∏</p>
                <div id="check-in-list" class="check-in-grid"></div>
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="danger" onclick="resetAllCheckIns()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>
        </section>

        <section id="match-setup" class="view">
            <div class="card">
                <h2>‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
                <div id="match-setup-controls" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light);">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="court-select-dropdown">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏á:</label>
                            <select id="court-select-dropdown"></select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <button class="warning" onclick="manualSetupStart()" id="btn-manual-setup">‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á</button>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <button class="success" onclick="simpleRandomMatch()" id="btn-random-setup" disabled>‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏π‡πà (4 ‡∏Ñ‡∏ô)</button>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <button class="secondary" onclick="queueMatchStart()" id="btn-queue-setup" disabled>‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)</button>
                        </div>
                    </div>
                </div>
                <div id="match-setup-content">
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ "‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô</p>
                </div>
            </div>
        </section>

        <section id="active-matches" class="view">
            <div class="card">
                <h2>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</h2>
                <div class="shuttle-counter">
                    <div>
                        <div class="count" id="live-shuttle-in-play">0</div>
                        <div>‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°)</div>
                    </div>
                </div>
                <form id="live-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="live-shuttle-action">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å:</label>
                        <select id="live-shuttle-action">
                            <option value="add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å)</option>
                            <option value="add-practice">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à)</option>
                            <option value="remove">‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡∏ó‡∏¥‡πâ‡∏á)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="live-shuttle-amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                        <input type="number" id="live-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
                <p style="color: var(--secondary); font-weight: bold;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏´‡∏±‡∏Å‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°) ‡∏≠‡∏≠‡∏Å 1 ‡∏•‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏°‡∏ï‡∏ä‡πå</p>
                <div id="active-matches-list"></div>
            </div>
        </section>

        <section id="player-history" class="view">
            <div class="card">
                <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
                <label for="history-player-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
                <select id="history-player-select">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                </select>
                <div id="history-details" class="stats-grid" style="margin-top: 20px;"></div>
            </div>
        </section>

        <section id="settings" class="view">
            <div class="card">
                <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏°</h2>
                <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏°</h3>
                <form id="add-court-form">
                    <div>
                        <label for="court-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏≤‡∏°:</label>
                        <input type="text" id="court-name" required>
                    </div>
                    <div>
                        <button type="submit">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏≤‡∏°</button>
                    </div>
                </form>
                <ul id="court-list" style="margin-top: 20px;"></ul>
            </div>
            <div class="card">
                <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î</h3>
                 <div class="shuttle-counter">
                    <div>
                        <div class="count" id="settings-shuttle-in-play">0</div>
                        <div>‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ)</div>
                    </div>
                </div>
                <form id="settings-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="settings-shuttle-action">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥:</label>
                        <select id="settings-shuttle-action">
                            <option value="add">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å)</option>
                            <option value="add-practice">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="settings-shuttle-amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                        <input type="number" id="settings-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </form>
            </div>
        </section>
        
        <section id="manager-tools" class="view">
            <div class="card">
                <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                
                <h3>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <p style="color: var(--danger); font-weight: bold;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)</p>
                <button class="danger" onclick="clearAllPlayers()">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </section>

    </main>

<script>
    // --- DATA STATE ---
    let appState = {
        players: [],
        courts: [],
        matches: [],
        history: {}, // History must be an object
        shuttlecocks: { total: 0, inPlay: 0, repair: 0 }, // Keep structure but only use inPlay
        nextId: { player: 1, court: 1, match: 1 }
    };
    let manualSelectionOrder = [];
    let matchTimers = {}; // Store timer intervals
    
    // Skill to Value mapping for easier calculation
    const SKILL_TO_VALUE = { 'BG': 1, 'N-': 2, 'N': 3, 'N+': 4, 'P': 5 };


    // --- LOCAL STORAGE ---
    function saveState() {
        // Exclude active timers from storage
        const stateToSave = { ...appState };
        localStorage.setItem('badmintonAppState', JSON.stringify(stateToSave));
    }

    function loadState() {
        const savedState = localStorage.getItem('badmintonAppState');
        if (savedState) {
            appState = JSON.parse(savedState);
            
            // --- FIX: Ensure history is initialized correctly ---
            if (typeof appState.history !== 'object' || appState.history === null || Array.isArray(appState.history)) {
                console.warn("History data structure corrupted. Reinitializing history as an object.");
                appState.history = {};
            }
            
            // Ensure all players have necessary fields and correct history structure
            appState.players.forEach(p => {
                if (typeof p.isCheckedIn === 'undefined') p.isCheckedIn = false;
                // Add isPlaying field for the new queue logic
                if (typeof p.isPlaying === 'undefined') p.isPlaying = false; 
                if (!appState.history[p.id]) {
                     appState.history[p.id] = { games: [] };
                } else if (!Array.isArray(appState.history[p.id].games)) {
                     appState.history[p.id].games = [];
                }
            });
            
            appState.matches.forEach(m => {
                if (typeof m.newShuttleUsed === 'undefined') m.newShuttleUsed = 0;
                if (typeof m.practiceShuttleUsed === 'undefined') m.practiceShuttleUsed = 0;
            });
            // ---------------------------------------------------
            
            // Recalculate nextId safely
            const maxPlayerId = appState.players.length > 0 ? Math.max(...appState.players.map(p => p.id)) : 0;
            const maxCourtId = appState.courts.length > 0 ? Math.max(...appState.courts.map(p => p.id)) : 0;
            
            let maxGameId = 0;
            Object.values(appState.history).forEach(playerHistory => {
                if (playerHistory && Array.isArray(playerHistory.games)) {
                    playerHistory.games.forEach(game => {
                        if (game.id > maxGameId) maxGameId = game.id;
                    });
                }
            });
            const maxMatchId = appState.matches.length > 0 ? Math.max(...appState.matches.map(m => m.id)) : 0;

            appState.nextId = {
                player: maxPlayerId + 1,
                court: maxCourtId + 1,
                match: Math.max(maxMatchId, maxGameId) + 1
            };

            // Restart timers for active matches on load
            appState.matches.forEach(match => {
                if (match.startTime) {
                    const card = document.querySelector(`.match-card[data-match-id="${match.id}"]`);
                    if (card) {
                        startTimer(match.id, card);
                    }
                }
            });
        }
    }
    
    // --- UTILITIES ---
    function formatTime(ms) {
        if (!ms) return '00:00';
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function startTimer(matchId, card) {
        // Clear any existing timer for this match
        if (matchTimers[matchId]) {
            clearInterval(matchTimers[matchId]);
        }

        const match = appState.matches.find(m => m.id === matchId);
        if (!match) return;

        if (!match.startTime) {
            match.startTime = Date.now();
            saveState();
        }

        const timerEl = card ? card.querySelector(`#match-timer-${matchId}`) : document.getElementById(`match-timer-${matchId}`);
        if (!timerEl) return;

        const updateTimer = () => {
            const elapsedTime = Date.now() - match.startTime;
            timerEl.textContent = formatTime(elapsedTime);
        };

        updateTimer();
        matchTimers[matchId] = setInterval(updateTimer, 1000);
    }

    function stopTimer(matchId) {
        if (matchTimers[matchId]) {
            clearInterval(matchTimers[matchId]);
            delete matchTimers[matchId];
        }
    }

    // Function to safely format skill for CSS class
    function getSkillClass(skill) {
        return skill.replace('+', 'plus').replace('-', 'minus');
    }

    // Function to get player game count
    function getPlayerGameCount(playerId) {
        const history = appState.history[playerId];
        return (history && Array.isArray(history.games) ? history.games.length : 0);
    }

    // --- VIEW MANAGEMENT ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');

        const activeNavBtn = document.querySelector(`nav button[onclick*="${viewId}"]`);
        if(activeNavBtn) activeNavBtn.classList.add('active');

        // Render functions based on active view
        if (viewId === 'dashboard') renderDashboard();
        if (viewId === 'player-management') renderPlayerList();
        if (viewId === 'check-in') renderCheckInList();
        if (viewId === 'match-setup') renderMatchSetup();
        if (viewId === 'active-matches') renderActiveMatches();
        if (viewId === 'player-history') renderHistoryPlayers();
        if (viewId === 'settings') renderSettings();
    }

    function navigateAndShow(viewId) {
        showView(viewId);
    }

    // *** MODIFIED ***: Simplifies shuttlecock display to only show 'inPlay' (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ)
    function updateShuttleCounterDisplay() {
        const inPlay = appState.shuttlecocks.inPlay; 

        // Dashboard section
        const dashInPlayEl = document.getElementById('dash-shuttle-in-play');
        if(dashInPlayEl) dashInPlayEl.textContent = inPlay;

        // Active Matches section
        const liveInPlayEl = document.getElementById('live-shuttle-in-play');
        if(liveInPlayEl) liveInPlayEl.textContent = inPlay;

        // Settings section
        const settingsInPlayEl = document.getElementById('settings-shuttle-in-play');
        if(settingsInPlayEl) settingsInPlayEl.textContent = inPlay;
    }

    // --- DASHBOARD FUNCTIONS ---
    function renderDashboard() {
        const totalPlayers = appState.players.length;
        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn).length;
        const activeMatches = appState.matches.length;
        const shuttleInPlay = appState.shuttlecocks.inPlay; // Use simplified

        document.getElementById('dash-total-players').textContent = totalPlayers;
        document.getElementById('dash-checked-in').textContent = checkedInPlayers;
        document.getElementById('dash-active-matches').textContent = activeMatches;
        document.getElementById('dash-shuttle-in-play').textContent = shuttleInPlay;

        renderDashboardPlayerStats();
        updateShuttleCounterDisplay();
    }

    function renderDashboardPlayerStats() {
        const listEl = document.getElementById('dashboard-player-list');
        listEl.innerHTML = '';
        
        const playerGameCounts = {};
        appState.players.forEach(p => {
            playerGameCounts[p.id] = getPlayerGameCount(p.id);
        });

        // Sort players by game count (ascending), then by name
        const sortedPlayers = appState.players.slice().sort((a, b) => {
            const countA = playerGameCounts[a.id];
            const countB = playerGameCounts[b.id];
            if (countA !== countB) return countA - countB;
            return a.name.localeCompare(b.name, 'th');
        });

        sortedPlayers.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            const card = document.createElement('div');
            card.classList.add('dashboard-player-card');
            card.onclick = () => showPlayerHistory(player.id);
            card.innerHTML = `
                <div class="player-name">${player.name}</div>
                <div class="player-skill"><span class="skill-badge skill-${skillClass}">${player.skill}</span></div>
                <div class="game-count">${playerGameCounts[player.id]} ‡πÄ‡∏Å‡∏°</div>
            `;
            listEl.appendChild(card);
        });
    }


    // --- PLAYER MANAGEMENT FUNCTIONS ---
    function addPlayer(name, skill) {
        const newPlayer = {
            id: appState.nextId.player++,
            name: name.trim(),
            skill: skill,
            isCheckedIn: false,
            isPlaying: false // New field
        };
        appState.players.push(newPlayer);
        appState.history[newPlayer.id] = { games: [] };
        saveState();
        renderPlayerList();
    }

    function addPlayersBulk(namesText, skill) {
        const names = namesText.split('\n').map(n => n.trim()).filter(n => n.length > 0);
        let addedCount = 0;
        names.forEach(name => {
            if (!appState.players.some(p => p.name === name)) {
                addPlayer(name, skill);
                addedCount++;
            }
        });
        saveState();
        renderPlayerList();
        alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà ${addedCount} ‡∏Ñ‡∏ô (‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥)`);
    }

    function deletePlayer(id) {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')) {
            appState.players = appState.players.filter(p => p.id !== id);
            appState.matches = appState.matches.filter(m => !m.team1.includes(id) && !m.team2.includes(id));
            delete appState.history[id]; // Also remove from history object
            saveState();
            renderPlayerList();
            renderActiveMatches();
        }
    }

    function renderPlayerList(filter = '') {
        const listEl = document.getElementById('player-list');
        const bulkEditListEl = document.getElementById('bulk-edit-list');
        listEl.innerHTML = '';
        bulkEditListEl.innerHTML = '';

        const filteredPlayers = appState.players.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));

        filteredPlayers.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            const li = document.createElement('li');
            li.innerHTML = `
                <div>
                    <a href="#" class="player-name-link" onclick="showPlayerHistory(${player.id}); return false;">
                        ${player.name}
                    </a>
                    <span class="skill-badge skill-${skillClass}">${player.skill}</span>
                </div>
                <div class="edit-form">
                    <select id="edit-skill-${player.id}" class="edit-mode">
                        ${['BG', 'N-', 'N', 'N+', 'P'].map(s => 
                            `<option value="${s}" ${s === player.skill ? 'selected' : ''}>${s}</option>`
                        ).join('')}
                    </select>
                    <button class="success" onclick="updatePlayerSkill(${player.id}, document.getElementById('edit-skill-${player.id}').value)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button class="danger" onclick="deletePlayer(${player.id})">‡∏•‡∏ö</button>
                </div>
            `;
            listEl.appendChild(li);

            // Bulk Edit Item
            const bulkItem = document.createElement('div');
            bulkItem.classList.add('bulk-edit-item');
            bulkItem.innerHTML = `
                <span>${player.name} <span class="skill-badge skill-${skillClass}">${player.skill}</span></span>
                <input type="checkbox" data-player-id="${player.id}">
            `;
            bulkEditListEl.appendChild(bulkItem);
        });
    }

    function updatePlayerSkill(id, newSkill) {
        const player = appState.players.find(p => p.id === id);
        if (player) {
            player.skill = newSkill;
            saveState();
            renderPlayerList(document.getElementById('player-search').value);
            alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á ${player.name} ‡πÄ‡∏õ‡πá‡∏ô ${newSkill} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }
    }

    function updatePlayerSkillBulk(newSkill) {
        const checkboxes = document.querySelectorAll('#bulk-edit-list input[type="checkbox"]:checked');
        let updatedCount = 0;
        checkboxes.forEach(checkbox => {
            const playerId = parseInt(checkbox.dataset.playerId);
            const player = appState.players.find(p => p.id === playerId);
            if (player && player.skill !== newSkill) {
                player.skill = newSkill;
                updatedCount++;
            }
        });

        if (updatedCount > 0) {
            saveState();
            renderPlayerList(document.getElementById('player-search').value);
            alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${updatedCount} ‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${newSkill} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        } else {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
        }
    }

    // --- MANAGER TOOLS FUNCTIONS ---
    function clearAllPlayers() {
        if (appState.matches.length > 0) {
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ! (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ)')) {
            appState.players = [];
            // appState.history remains intact
            appState.nextId.player = 1;
            saveState();
            renderDashboard();
            renderPlayerList();
            renderCheckInList();
            renderHistoryPlayers();
            alert('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
    }
    
    // --- CHECK-IN FUNCTIONS ---
    function toggleCheckIn(id) {
        const player = appState.players.find(p => p.id === id);
        if (player) {
            if (player.isPlaying) {
                alert(`${player.name} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà! ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô`);
                return;
            }
            player.isCheckedIn = !player.isCheckedIn;
            // Record check-in time if checking in (for more advanced queue in future)
            if (player.isCheckedIn) {
                player.checkInTime = Date.now();
            } else {
                delete player.checkInTime;
            }
            saveState();
            renderCheckInList();
            renderDashboard();
        }
    }

    function resetAllCheckIns() {
        if (appState.players.some(p => p.isPlaying)) {
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏î‡πâ! ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
            appState.players.forEach(p => {
                p.isCheckedIn = false;
                p.isPlaying = false; // Reset playing status too
                delete p.checkInTime;
            });
            saveState();
            renderCheckInList();
            renderDashboard();
            alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
    }

    function renderCheckInList() {
        const listEl = document.getElementById('check-in-list');
        listEl.innerHTML = '';

        // Recalculate playing status based on active matches (Safety check, although managed on match finish)
        const playingIds = new Set();
        appState.matches.forEach(m => {
            [...m.team1, ...m.team2].forEach(id => playingIds.add(id));
        });
        
        // Update isPlaying status for display consistency
        appState.players.forEach(p => {
            p.isPlaying = playingIds.has(p.id);
        });
        saveState();


        // Sort by status (Waiting > Playing > Not Checked In), then by time, then name
        const sortedPlayers = appState.players.slice().sort((a, b) => {
            const statusA = a.isCheckedIn ? (a.isPlaying ? 2 : 1) : 3;
            const statusB = b.isCheckedIn ? (b.isPlaying ? 2 : 1) : 3;

            if (statusA !== statusB) return statusA - statusB; // 1 (Waiting) is highest priority

            if (a.isCheckedIn && b.isCheckedIn && !a.isPlaying && !b.isPlaying) {
                // If both are WAITING, sort by checkInTime (earliest first)
                if (a.checkInTime && b.checkInTime) {
                    if (a.checkInTime !== b.checkInTime) return a.checkInTime - b.checkInTime;
                }
            }

            return a.name.localeCompare(b.name, 'th');
        });

        sortedPlayers.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            const gameCount = getPlayerGameCount(player.id);
            const card = document.createElement('div');
            card.classList.add('check-in-card');
            
            if (player.isCheckedIn) card.classList.add('checked-in');
            if (player.isPlaying) card.classList.add('playing-now');
            
            card.onclick = () => toggleCheckIn(player.id);

            let statusIcon = player.isCheckedIn ? '‚úÖ' : '‚ùå';
            if (player.isPlaying) {
                statusIcon = 'üè∏'; // Ensure the card style reflects the playing status
                card.classList.remove('checked-in');
            }

            card.innerHTML = `
                <div class="player-name">${player.name}</div>
                <div class="player-skill"><span class="skill-badge skill-${skillClass}">${player.skill}</span></div>
                <div style="font-size:0.8rem; color:#888;">(${gameCount} ‡πÄ‡∏Å‡∏°)</div>
                <div class="status-icon">${statusIcon}</div>
            `;
            listEl.appendChild(card);
        });
    }

    // --- MATCH SETUP FUNCTIONS ---
    function renderCourtSelectDropdown(targetId) {
        const selectEl = document.getElementById(targetId);
        selectEl.innerHTML = '';
        
        // Add a default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á --';
        selectEl.appendChild(defaultOption);

        const availableCourts = appState.courts.filter(c => c.status === 'free');
        availableCourts.forEach(court => {
            const option = document.createElement('option');
            option.value = court.id;
            option.textContent = court.name;
            selectEl.appendChild(option);
        });

        // Toggle visibility of setup buttons
        const hasAvailableCourt = availableCourts.length > 0;
        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        const canSetup = hasAvailableCourt && checkedInPlayers.length >= 4;
        
        document.getElementById('btn-random-setup').disabled = !canSetup;
        document.getElementById('btn-queue-setup').disabled = !canSetup;
        document.getElementById('btn-manual-setup').disabled = !hasAvailableCourt;
    }

    function renderMatchSetup() {
        renderCourtSelectDropdown('court-select-dropdown');

        // Reset manual setup view
        const setupContentEl = document.getElementById('match-setup-content');
        setupContentEl.innerHTML = '<p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ "‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô</p>';
        manualSelectionOrder = [];
    }

    function getPlayerSkillValue(skill) {
        return SKILL_TO_VALUE[skill] || 3; // Default to 'N' (3)
    }

    // *** MODIFIED ***: Sets default newShuttleUsed = 1 and deducts from inPlay stock
    function createMatch(courtId, team1Ids, team2Ids) {
        // courtId is passed as string from dropdown
        const court = appState.courts.find(c => c.id == courtId);
        if (!court || court.status !== 'free') {
            alert('‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö!');
            return;
        }
        
        // Deduct 1 shuttle from stock
        if (appState.shuttlecocks.inPlay >= 1) {
            appState.shuttlecocks.inPlay -= 1;
        } else {
            alert('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏°‡∏î! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å)');
        }


        const matchId = appState.nextId.match++;
        const newMatch = {
            id: matchId,
            courtId: courtId, // Stored as string
            courtName: court.name,
            team1: team1Ids,
            team2: team2Ids,
            startTime: Date.now(),
            newShuttleUsed: 1, // <<< Default to 1 (Requested by user)
            practiceShuttleUsed: 0
        };

        appState.matches.push(newMatch);
        court.status = 'playing';
        court.currentMatchId = matchId;

        // Set players to isPlaying
        [...team1Ids, ...team2Ids].forEach(playerId => {
            const player = appState.players.find(p => p.id === playerId);
            if (player) {
                player.isPlaying = true;
            }
        });

        saveState();
        renderActiveMatches();
        renderCheckInList();
        renderDashboard();
        showView('active-matches');
        alert(`‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏ô‡∏≤‡∏° ${court.name} ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô (‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà 1 ‡∏•‡∏π‡∏Å)`);
    }

    // --- MANUAL SETUP ---
    function manualSetupStart() {
        const courtId = document.getElementById('court-select-dropdown').value;
        if (!courtId) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        if (checkedInPlayers.length < 4) {
             alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏Ñ‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ');
             return;
        }

        const setupContentEl = document.getElementById('match-setup-content');
        setupContentEl.innerHTML = `
            <h3>‡∏™‡∏ô‡∏≤‡∏° ${appState.courts.find(c => c.id == courtId).name}</h3>
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 4 ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (1-2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏° 1, 3-4 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏° 2) <span id="selection-status" style="font-weight: bold; color: var(--secondary);">: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1</span></p>
            <div id="manual-selection-grid" class="manual-selection-grid"></div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="success" onclick="confirmManualMatch(${courtId})" id="btn-confirm-manual" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</button>
                <button class="danger" onclick="renderMatchSetup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;

        manualSelectionOrder = [];
        renderManualSelectionGrid(checkedInPlayers);
    }

    function renderManualSelectionGrid(players) {
        const gridEl = document.getElementById('manual-selection-grid');
        const statusEl = document.getElementById('selection-status');
        const confirmBtn = document.getElementById('btn-confirm-manual');
        gridEl.innerHTML = '';

        players.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            const gameCount = getPlayerGameCount(player.id);
            const isSelected = manualSelectionOrder.includes(player.id);
            const card = document.createElement('div');
            card.classList.add('manual-selection-card');
            if (isSelected) card.classList.add('selected');
            card.onclick = () => toggleManualSelection(player.id, players);

            let orderBadge = '';
            if (isSelected) {
                const order = manualSelectionOrder.indexOf(player.id) + 1;
                orderBadge = `<div class="selection-order">${order}</div>`;
            }

            card.innerHTML = `
                ${orderBadge}
                <div class="player-name">${player.name}</div>
                <div class="player-skill"><span class="skill-badge skill-${skillClass}">${player.skill}</span></div>
                <div class="game-count">${gameCount}</div>
            `;
            gridEl.appendChild(card);
        });

        statusEl.textContent = `: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${manualSelectionOrder.length + 1}`;
        confirmBtn.disabled = manualSelectionOrder.length !== 4;
    }

    function toggleManualSelection(playerId, players) {
        const index = manualSelectionOrder.indexOf(playerId);
        if (index > -1) {
            manualSelectionOrder.splice(index, 1);
        } else if (manualSelectionOrder.length < 4) {
            manualSelectionOrder.push(playerId);
        }
        renderManualSelectionGrid(players);
    }

    function confirmManualMatch(courtId) {
        if (manualSelectionOrder.length !== 4) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô');
            return;
        }

        const team1Ids = [manualSelectionOrder[0], manualSelectionOrder[1]];
        const team2Ids = [manualSelectionOrder[2], manualSelectionOrder[3]];

        const team1Names = team1Ids.map(id => appState.players.find(p => p.id === id).name).join(' & ');
        const team2Names = team2Ids.map(id => appState.players.find(p => p.id === id).name).join(' & ');

        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà:\n‡∏ó‡∏µ‡∏° 1: ${team1Names}\n‡∏ó‡∏µ‡∏° 2: ${team2Names}\n‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
            createMatch(courtId, team1Ids, team2Ids);
        }
    }

    // --- RANDOM MATCH SETUP (Simple 4 players) ---
    function simpleRandomMatch() {
        const courtId = document.getElementById('court-select-dropdown').value;
        if (!courtId) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        if (checkedInPlayers.length < 4) {
            alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏Ñ‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ');
            return;
        }

        // Shuffle players and pick first 4
        const shuffledPlayers = checkedInPlayers.sort(() => 0.5 - Math.random());
        const selectedIds = shuffledPlayers.slice(0, 4).map(p => p.id);
        
        // Simple assignment: 1st & 3rd vs 2nd & 4th
        const team1Ids = [selectedIds[0], selectedIds[2]];
        const team2Ids = [selectedIds[1], selectedIds[3]];

        const team1Names = team1Ids.map(id => appState.players.find(p => p.id === id).name).join(' & ');
        const team2Names = team2Ids.map(id => appState.players.find(p => p.id === id).name).join(' & ');
        
        if (confirm(`‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Ñ‡∏π‡πà:\n‡∏ó‡∏µ‡∏° 1: ${team1Names}\n‡∏ó‡∏µ‡∏° 2: ${team2Names}\n‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
            createMatch(courtId, team1Ids, team2Ids);
        }
    }


    // --- ADVANCED QUEUE MATCH SETUP (Minimum Games) ---
    function queueMatchStart() {
        const courtId = document.getElementById('court-select-dropdown').value;
        if (!courtId) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        if (checkedInPlayers.length < 4) {
            alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏Ñ‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ');
            return;
        }

        // Get player stats: { id, name, skillValue, gameCount }
        const playerStats = checkedInPlayers.map(p => ({
            id: p.id,
            name: p.name,
            skillValue: getPlayerSkillValue(p.skill),
            gameCount: getPlayerGameCount(p.id)
        }));

        // Sort by gameCount (ascending) to prioritize players who played the least
        playerStats.sort((a, b) => a.gameCount - b.gameCount);

        // Select the top 4 players with the least games
        const top4 = playerStats.slice(0, 4);

        // Sort by skill for pairing
        top4.sort((a, b) => a.skillValue - b.skillValue);

        // Pairing logic (P1+P4 vs P2+P3 for skill balance among the 4 lowest-game players)
        const team1Ids = [top4[0].id, top4[3].id];
        const team2Ids = [top4[1].id, top4[2].id];

        const team1Names = team1Ids.map(id => appState.players.find(p => p.id === id).name).join(' & ');
        const team2Names = team2Ids.map(id => appState.players.find(p => p.id === id).name).join(' & ');

        if (confirm(`‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡∏Ñ‡∏π‡πà (‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î):\n‡∏ó‡∏µ‡∏° 1: ${team1Names}\n‡∏ó‡∏µ‡∏° 2: ${team2Names}\n‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
            createMatch(courtId, team1Ids, team2Ids);
        }
    }


    // --- ACTIVE MATCHES FUNCTIONS ---
    function renderActiveMatches() {
        const listEl = document.getElementById('active-matches-list');
        listEl.innerHTML = '';
        
        if (appState.matches.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; color: #888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>';
            return;
        }

        appState.matches.forEach(match => {
            const team1Names = match.team1.map(id => appState.players.find(p => p.id === id).name).join(' & ');
            const team2Names = match.team2.map(id => appState.players.find(p => p.id === id).name).join(' & ');

            const team1Skills = match.team1.map(id => appState.players.find(p => p.id === id).skill);
            const team2Skills = match.team2.map(id => appState.players.find(p => p.id === id).skill);

            const card = document.createElement('div');
            card.classList.add('match-card');
            card.dataset.matchId = match.id;
            
            card.innerHTML = `
                <h3>‡∏™‡∏ô‡∏≤‡∏° ${match.courtName}</h3>
                <div class="timer" id="match-timer-${match.id}">00:00</div>
                <div class="match-teams">
                    <div class="team">
                        <h4>‡∏ó‡∏µ‡∏° 1</h4>
                        <p>${team1Names}</p>
                        <p>${team1Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${s}</span>`).join(' ')}</p>
                    </div>
                    <div class="vs">VS</div>
                    <div class="team">
                        <h4>‡∏ó‡∏µ‡∏° 2</h4>
                        <p>${team2Names}</p>
                        <p>${team2Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${s}</span>`).join(' ')}</p>
                    </div>
                </div>
                
                <div class="court-shuttle-control">
                    <div class="shuttle-control-item">
                        <span class="shuttle-label">‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà:</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'new', -1)">-</button>
                        <span class="shuttle-count-display" id="match-shuttle-new-${match.id}">${match.newShuttleUsed}</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'new', 1)">+</button>
                    </div>
                    <div class="shuttle-control-item">
                        <span class="shuttle-label">‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°:</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'practice', -1)">-</button>
                        <span class="shuttle-count-display" id="match-shuttle-practice-${match.id}">${match.practiceShuttleUsed}</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'practice', 1)">+</button>
                    </div>
                </div>

                <h4 style="margin-top: 1.5rem; text-align: center;">‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞? (‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</h4>
                <div class="match-controls">
                    <button class="success" onclick="recordMatchResult(${match.id}, 1)">‡∏ó‡∏µ‡∏° 1 ‡∏ä‡∏ô‡∏∞</button>
                    <button class="draw" onclick="recordMatchResult(${match.id}, 0)">‡πÄ‡∏™‡∏°‡∏≠</button>
                    <button class="success" onclick="recordMatchResult(${match.id}, 2)">‡∏ó‡∏µ‡∏° 2 ‡∏ä‡∏ô‡∏∞</button>
                </div>
                <div class="match-controls" style="margin-top: 1rem;">
                    <button class="danger" onclick="cancelMatch(${match.id})">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå</button>
                </div>
            `;
            listEl.appendChild(card);
            startTimer(match.id, card);
        });
        updateShuttleCounterDisplay();
        renderDashboard();
    }

    // *** MODIFIED ***: Only updates match-specific counters for history, DOES NOT affect global stock (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏±‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏°‡∏ï‡∏ä‡πå)
    function updateMatchShuttleUsed(matchId, type, amount) {
        const match = appState.matches.find(m => m.id === matchId);
        if (!match) return;

        if (type === 'new') {
            if (match.newShuttleUsed + amount >= 0) {
                match.newShuttleUsed += amount;
                document.getElementById(`match-shuttle-new-${matchId}`).textContent = match.newShuttleUsed;
            } else {
                 alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
                 return;
            }
        } else if (type === 'practice') {
             if (match.practiceShuttleUsed + amount >= 0) {
                match.practiceShuttleUsed += amount;
                document.getElementById(`match-shuttle-practice-${matchId}`).textContent = match.practiceShuttleUsed;
            } else {
                 alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
                 return;
            }
        }
        
        saveState();
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï updateShuttleCounterDisplay() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏ì‡∏∞‡∏ô‡∏±‡∏ö‡πÉ‡∏ô‡∏™‡∏ô‡∏≤‡∏°
    }

    // *** MODIFIED ***: Removes global stock logic (cost was paid on match start)
    function updateShuttlecocksAfterMatch(match) {
        // We assume the 1 default shuttle cost was deducted when the match started.
        // All usage recorded in match.newShuttleUsed/practiceShuttleUsed is for history/reporting only.
        
        saveState();
        updateShuttleCounterDisplay(); 
    }


    // --- MATCH RESULT AND ENDING FUNCTIONS ---
    
    /**
     * ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô: ‡∏´‡∏¢‡∏∏‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤, ‡∏•‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô, ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ô‡∏≤‡∏°
     * @param {number} matchId - ID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö
     */
    function endMatch(matchId) {
        const matchIndex = appState.matches.findIndex(m => m.id === matchId);
        if (matchIndex === -1) return;

        const match = appState.matches[matchIndex];
        
        stopTimer(matchId);

        // 1. ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ isPlaying ‡πÄ‡∏õ‡πá‡∏ô false
        const allPlayers = [...match.team1, ...match.team2];
        allPlayers.forEach(playerId => {
            const player = appState.players.find(p => p.id === playerId);
            if (player) {
                player.isPlaying = false;
            }
        });

        // 2. ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ô‡∏≤‡∏°: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ status ‡πÄ‡∏õ‡πá‡∏ô 'free'
        // FIX: ‡πÉ‡∏ä‡πâ == ‡πÅ‡∏ó‡∏ô === ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ match.courtId ‡πÄ‡∏õ‡πá‡∏ô String ‡πÅ‡∏ï‡πà c.id ‡πÄ‡∏õ‡πá‡∏ô Number
        const court = appState.courts.find(c => c.id == match.courtId);
        if (court) {
            court.status = 'free';
            delete court.currentMatchId;
        }

        // 3. ‡∏•‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        appState.matches.splice(matchIndex, 1);
        
        saveState();
        renderActiveMatches();
        renderCheckInList(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
        renderDashboard();   // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô
        
        // FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Settings ‡πÅ‡∏•‡∏∞ Match Setup
        renderCourtList();
        renderMatchSetup();
    }
    
    /**
     * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
     * @param {number} matchId - ID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå
     * @param {number} winningTeam - 1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏° 1, 2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏° 2, 0 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏°‡∏≠
     */
    function recordMatchResult(matchId, winningTeam) {
        const match = appState.matches.find(m => m.id === matchId);
        if (!match) return;

        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡∏°
        const gameResult = {
            id: appState.nextId.match++, // ‡πÉ‡∏ä‡πâ ID ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡∏°
            matchId: matchId,
            courtId: match.courtId,
            startTime: match.startTime,
            endTime: Date.now(),
            duration: Date.now() - match.startTime,
            team1: match.team1,
            team2: match.team2,
            winner: winningTeam,
            newShuttleUsed: match.newShuttleUsed,
            practiceShuttleUsed: match.practiceShuttleUsed
        };

        const allPlayers = [...match.team1, ...match.team2];
        allPlayers.forEach(playerId => {
            if (appState.history[playerId] && Array.isArray(appState.history[playerId].games)) {
                 appState.history[playerId].games.push(gameResult);
            }
            // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            else {
                 appState.history[playerId] = { games: [gameResult] };
            }
        });
        
        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° logic ‡πÉ‡∏´‡∏°‡πà)
        updateShuttlecocksAfterMatch(match);
        
        // 3. ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ô‡∏≤‡∏°, ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô)
        endMatch(matchId);
        
        saveState();
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•: ‡∏™‡∏ô‡∏≤‡∏° ${match.courtName} - ‡∏ó‡∏µ‡∏° ${winningTeam === 1 ? '1 ‡∏ä‡∏ô‡∏∞' : winningTeam === 2 ? '2 ‡∏ä‡∏ô‡∏∞' : '‡πÄ‡∏™‡∏°‡∏≠'}`);
    }

    /**
     * ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
     * @param {number} matchId - ID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
     */
    function cancelMatch(matchId) {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡∏µ‡πâ? ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î')) {
            endMatch(matchId); // endMatch ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
            alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
    }


    // --- PLAYER HISTORY FUNCTIONS ---
    function renderHistoryPlayers() {
        const selectEl = document.getElementById('history-player-select');
        const currentSelectedId = selectEl.value;
        selectEl.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';

        appState.players.slice().sort((a, b) => a.name.localeCompare(b.name, 'th')).forEach(player => {
            const option = document.createElement('option');
            option.value = player.id;
            option.textContent = player.name;
            if (player.id == currentSelectedId) option.selected = true;
            selectEl.appendChild(option);
        });

        if (currentSelectedId) {
            showPlayerHistory(parseInt(currentSelectedId));
        } else {
            document.getElementById('history-details').innerHTML = '<p style="text-align: center; color: #888;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
        }
    }

    function showPlayerHistory(playerId) {
        const player = appState.players.find(p => p.id === playerId);
        const history = appState.history[playerId];
        const detailsEl = document.getElementById('history-details');
        
        if (!player || !history) {
            detailsEl.innerHTML = `<div class="stat-card">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${player.name}</div>`;
            return;
        }

        const gamesPlayed = history.games.length;
        const wins = history.games.filter(g => {
            const isTeam1 = g.team1.includes(playerId);
            const isTeam2 = g.team2.includes(playerId);
            
            if (isTeam1 && g.winner === 1) return true;
            if (isTeam2 && g.winner === 2) return true;
            return false;
        }).length;
        
        const draws = history.games.filter(g => g.winner === 0).length;
        const losses = gamesPlayed - wins - draws;

        const totalDuration = history.games.reduce((sum, g) => sum + g.duration, 0);
        const avgDuration = gamesPlayed > 0 ? totalDuration / gamesPlayed : 0;

        detailsEl.innerHTML = `
            <div class="stat-card">
                <h4>${player.name} (${player.skill})</h4>
                <div class="big-number">${gamesPlayed}</div>
                <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</p>
            </div>
            <div class="stat-card">
                <h4>‡∏ä‡∏ô‡∏∞/‡πÅ‡∏û‡πâ/‡πÄ‡∏™‡∏°‡∏≠</h4>
                <div class="big-number" style="color: var(--success);">${wins} / <span style="color: var(--danger);">${losses}</span> / <span style="color: var(--accent);">${draws}</span></div>
                <p>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</p>
            </div>
            <div class="stat-card">
                <h4>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞</h4>
                <div class="big-number">${gamesPlayed > 0 ? ((wins / gamesPlayed) * 100).toFixed(1) : 0}%</div>
                <p>‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${gamesPlayed} ‡πÄ‡∏Å‡∏°</p>
            </div>
            <div class="stat-card">
                <h4>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h4>
                <div class="big-number">${formatTime(avgDuration)}</div>
                <p>‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°</p>
            </div>
        `;
        
        // Ensure the correct player is selected in the dropdown
        document.getElementById('history-player-select').value = playerId;
    }

    // --- SHUTTLECOCK FUNCTIONS ---
    // *** MODIFIED ***: Simplified actions to only manage inPlay (‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ)
    function updateGlobalShuttlecocks(action, amount) {
        amount = parseInt(amount);
        if (isNaN(amount) || amount <= 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }

        switch (action) {
            case 'add': // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°)
            case 'add-practice': // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏°)
                appState.shuttlecocks.inPlay += amount;
                appState.shuttlecocks.total += amount; // keep total increasing for future reports
                break;
            case 'remove': // ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡∏ó‡∏¥‡πâ‡∏á) - ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô
                if (appState.shuttlecocks.inPlay < amount) {
                    alert('‡∏•‡∏π‡∏Å‡∏ã‡πâ‡∏≠‡∏° (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ) ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠');
                    return;
                }
                appState.shuttlecocks.inPlay -= amount;
                // ‡πÑ‡∏°‡πà‡∏•‡∏î total ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ total ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ (‡∏•‡∏π‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å stock ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                break;
        }

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        if (appState.shuttlecocks.inPlay < 0) appState.shuttlecocks.inPlay = 0;

        saveState();
        updateShuttleCounterDisplay();
        alert(`‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ${amount} ‡∏•‡∏π‡∏Å`);
    }

    // --- COURT (SETTINGS) FUNCTIONS ---
    function addCourt(name) {
        const newCourt = {
            id: appState.nextId.court++,
            name: name.trim(),
            status: 'free', // 'free' or 'playing'
            currentMatchId: null
        };
        appState.courts.push(newCourt);
        saveState();
        renderCourtList();
        renderMatchSetup(); // Update dropdown
    }

    function deleteCourt(id) {
        const court = appState.courts.find(c => c.id === id);
        if (court.status === 'playing') {
            alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏ô‡∏≤‡∏° ${court.name} ‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏µ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà`);
            return;
        }
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏ô‡∏≤‡∏° ${court.name}?`)) {
            appState.courts = appState.courts.filter(c => c.id !== id);
            saveState();
            renderCourtList();
            renderMatchSetup(); // Update dropdown
            alert(`‡∏•‡∏ö‡∏™‡∏ô‡∏≤‡∏° ${court.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }
    }

    function renderCourtList() {
        const listEl = document.getElementById('court-list');
        listEl.innerHTML = '';
        appState.courts.forEach(court => {
            const li = document.createElement('li');
            li.style.backgroundColor = court.status === 'playing' ? '#ffe0b2' : 'var(--light)';
            li.innerHTML = `
                <span>
                    ${court.name} 
                    <span style="font-size: 0.8rem; color: ${court.status === 'playing' ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                        (${court.status === 'playing' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô' : '‡∏ß‡πà‡∏≤‡∏á'})
                    </span>
                </span>
                <button class="danger" onclick="deleteCourt(${court.id})">‡∏•‡∏ö</button>
            `;
            listEl.appendChild(li);
        });
    }

    function renderSettings() {
        renderCourtList();
        updateShuttleCounterDisplay();
    }


    // --- EVENT LISTENERS ---
    document.getElementById('add-player-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('player-name').value;
        const skill = document.getElementById('player-skill').value;
        if (name) addPlayer(name, skill);
        document.getElementById('player-name').value = '';
    });

    document.getElementById('bulk-add-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const namesText = document.getElementById('bulk-names').value;
        const skill = document.getElementById('bulk-skill').value;
        if (namesText) addPlayersBulk(namesText, skill);
        document.getElementById('bulk-names').value = '';
    });

    document.getElementById('player-search').addEventListener('input', function(e) {
        renderPlayerList(e.target.value);
    });

    document.getElementById('bulk-edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const newSkill = document.getElementById('bulk-edit-skill').value;
        updatePlayerSkillBulk(newSkill);
    });

    document.getElementById('add-court-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('court-name').value;
        if (name) addCourt(name);
        document.getElementById('court-name').value = '';
    });
    
    // *** MODIFIED ***: Event listener for live-shuttle-form (Active Matches)
    document.getElementById('live-shuttle-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const action = document.getElementById('live-shuttle-action').value;
        const amount = document.getElementById('live-shuttle-amount').value;
        updateGlobalShuttlecocks(action, amount);
        document.getElementById('live-shuttle-amount').value = '1';
    });

    // *** MODIFIED ***: Event listener for settings-shuttle-form (Settings)
    document.getElementById('settings-shuttle-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const action = document.getElementById('settings-shuttle-action').value;
        const amount = document.getElementById('settings-shuttle-amount').value;
        // In settings, the actions are limited to 'add' and 'add-practice'
        updateGlobalShuttlecocks(action, amount);
        document.getElementById('settings-shuttle-amount').value = '1';
    });
    
    document.getElementById('history-player-select').addEventListener('change', function(e) {
         const playerId = parseInt(e.target.value);
         if (!isNaN(playerId)) {
             showPlayerHistory(playerId);
         } else {
             document.getElementById('history-details').innerHTML = '<p style="text-align: center; color: #888;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
         }
    });


    // --- INITIALIZATION ---
    window.onload = function() {
        loadState();
        showView('dashboard');
    };
</script>
</body>
</html>