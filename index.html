<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการสนามแบดมินตัน</title>
    <style>
        :root {
            --primary: #1a2b47;
            --secondary: #00a8cc;
            --accent: #f39c12;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a3c;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light);
            margin: 0;
            padding: 0;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        nav {
            background-color: var(--white);
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav button {
            background-color: transparent;
            color: var(--dark);
            border: none;
            padding: 1rem 1.2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        nav button:hover, nav button.active {
            background-color: rgba(0, 168, 204, 0.1);
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        main {
            padding: 1.5rem 0;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--light);
            padding-bottom: 0.75rem;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .card h3 {
            color: var(--secondary);
            margin-top: 1.5rem;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        form div {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 168, 204, 0.2);
        }

        button {
            background-color: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            min-height: 48px;
        }

        button:hover {
            background-color: #0089a9;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.danger { background-color: var(--danger); }
        button.danger:hover { background-color: #c0392b; }
        button.success { background-color: var(--success); }
        button.success:hover { background-color: #229954; }
        button.warning { background-color: var(--accent); }
        button.warning:hover { background-color: #e67e22; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background-color: var(--light);
        }

        table th {
            background-color: var(--light);
            font-weight: bold;
            color: var(--primary);
        }

        .skill-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            color: var(--white);
            font-size: 0.8rem;
            font-weight: bold;
        }
        .skill-P { background-color: var(--success); }
        .skill-Nminus { background-color: #2c3e50; } 
        .skill-N { background-color: var(--secondary); }
        .skill-Nplus { background-color: #e67e22; }
        .skill-BG { background-color: #95a5a6; }

        .check-in-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }
        .check-in-card {
            background-color: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .check-in-card:hover:not(.checked-in) {
            border-color: var(--secondary);
            transform: scale(1.05);
        }
        .check-in-card.checked-in {
            background-color: #e8f5e9;
            border-color: var(--success);
            cursor: default;
        }
        .check-in-card.playing-now {
            background-color: #fff3e0; 
            border-color: var(--accent);
        }
        .check-in-card .player-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .check-in-card .status-icon {
            font-size: 1.5rem;
            margin-top: 0.5rem;
        }

        .match-card {
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--secondary);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--white);
        }
        .match-card h3 { margin-top: 0; }
        .match-teams { display: flex; justify-content: space-around; align-items: center; margin: 1.5rem 0; flex-wrap: wrap; gap: 1rem; }
        .team { text-align: center; min-width: 120px; }
        .team p { margin: 0.25rem 0; }
        .vs { font-size: 1.5rem; font-weight: bold; color: #888; }
        .match-controls { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .timer { font-size: 1.8rem; font-weight: bold; color: var(--primary); text-align: center; margin: 1rem 0; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .dashboard-card {
            background: linear-gradient(135deg, var(--white), var(--light));
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .dashboard-card .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .dashboard-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        .dashboard-card .label {
            color: var(--dark);
            font-weight: 500;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        .quick-actions button {
            flex: 1;
            min-width: 200px;
        }

        .dashboard-player-stats {
            margin-top: 2rem;
        }
        .dashboard-player-stats h3 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .dashboard-player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
        }
        .dashboard-player-card {
            background-color: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: box-shadow 0.3s;
            cursor: pointer;
        }
        .dashboard-player-card:hover {
            box-shadow: var(--shadow);
        }
        .dashboard-player-card .player-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .dashboard-player-card .player-skill {
            font-size: 0.7rem;
            margin: 0.25rem 0;
        }
        .dashboard-player-card .game-count {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .shuttle-counter {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .shuttle-counter div {
            text-align: center;
        }
        .shuttle-counter .count {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .court-shuttle-control {
            display: flex;
            flex-direction: column;
            gap: 10px; 
            padding: 0.75rem;
            background-color: #f0f8ff;
            border-radius: 8px;
            margin-top: 0.5rem;
        }
        .shuttle-control-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }
        .court-shuttle-control button {
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            min-height: auto;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary);
        }

        .search-bar {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 650px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--white);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--white);
            padding: 0.25rem 0.5rem;
            min-height: auto;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        #modal-player-stats, #modal-game-records {
            padding: 1.5rem;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
        }

        .win-indicator {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .win-indicator.win {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }

        .win-indicator.loss {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }

        .win-indicator.draw {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            box-shadow: 0 2px 8px rgba(149, 165, 166, 0.3);
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .stats-summary-card {
            background-color: var(--light);
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
        }

        .stats-summary-card .value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stats-summary-card .label {
            font-size: 0.65rem;
            color: var(--dark);
            margin-top: 0.1rem;
        }

        .edit-form {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .bulk-edit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background-color: var(--light);
            border-radius: 4px;
        }

        .bulk-edit-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .bulk-edit-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }

        @media (max-width: 768px) {
            .container { padding: 0.5rem; }
            header h1 { font-size: 1.5rem; }
            nav button { padding: 0.8rem 0.5rem; font-size: 0.9rem; }
            .card { padding: 1rem; }
            .modal-content { width: 95%; padding: 1rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <h1>🏸 ระบบจัดการสนามแบดมินตัน 🏸</h1>
        </div>
    </header>

    <nav>
        <button onclick="showView('dashboard')" class="active">แดชบอร์ด</button>
        <button onclick="showView('player-management')">จัดการผู้เล่น</button>
        <button onclick="showView('check-in')">เช็คอิน</button>
        <button onclick="showView('match-setup')">จัดคู่/จับสลาก</button>
        <button onclick="showView('active-matches')">สนามที่กำลังเล่น</button>
        <button onclick="showView('settings')">ตั้งค่า</button>
        <button onclick="showView('manager-tools')">หน้าผู้จัด</button>
    </nav>

    <main class="container">
        <section id="dashboard" class="view active">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="icon">👥</div>
                    <div class="value" id="dash-total-players">0</div>
                    <div class="label">ผู้เล่นทั้งหมด</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">✅</div>
                    <div class="value" id="dash-checked-in">0</div>
                    <div class="label">เช็คอินแล้ว</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">🏟️</div>
                    <div class="value" id="dash-active-matches">0</div>
                    <div class="label">กำลังแข่ง</div>
                </div>
                <div class="dashboard-card">
                    <div class="icon">🏸</div>
                    <div class="value" id="dash-shuttle-in-play">0</div>
                    <div class="label">ลูกแบดพร้อมใช้</div>
                </div>
            </div>
            
            <div class="dashboard-player-stats">
                <h3>สถิติผู้เล่น (เรียงตามจำนวนเกมที่เล่นน้อยที่สุด)</h3>
                <div id="dashboard-player-list" class="dashboard-player-list"></div>
            </div>

            <div class="dashboard-player-stats">
                <h3>👥 ผู้เล่นคู่ที่เล่นด้วยกันบ่อยสุด</h3>
                <p style="font-size: 0.9rem; color: #888;">แสดง ID และชื่อผู้เล่นคู่ที่เล่นด้วยกันบ่อย</p>
                <div id="frequent-partners-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
            </div>

            <div class="dashboard-player-stats">
                <h3>⚔️ ฝ่ายตรงข้ามที่เจอบ่อยสุด</h3>
                <p style="font-size: 0.9rem; color: #888;">แสดง ID และชื่อผู้เล่นที่เป็นฝ่ายตรงข้ามบ่อย</p>
                <div id="frequent-opponents-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
            </div>

            <div class="quick-actions">
                <button class="success" onclick="navigateAndShow('player-management')">➕ เพิ่มผู้เล่น</button>
                <button class="warning" onclick="navigateAndShow('match-setup')">🎲 จัดคู่เล่น</button>
                <button onclick="navigateAndShow('active-matches')">⏱️ ดูสนาม</button>
            </div>
        </section>

        <section id="player-management" class="view">
            <div class="card">
                <h2>เพิ่มผู้เล่นคนเดียว</h2>
                <form id="add-player-form">
                    <div>
                        <label for="player-name">ชื่อผู้เล่น:</label>
                        <input type="text" id="player-name" required>
                    </div>
                    <div>
                        <label for="player-skill">ระดับมือ:</label>
                        <select id="player-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit">เพิ่มผู้เล่น</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>เพิ่มผู้เล่นแบบรวม (วางข้อความ)</h2>
                <p>คัดลอกรายชื่อจากที่อื่น (ชื่อละ 1 บรรทัด) แล้ววางในช่องด้านล่าง</p>
                <form id="bulk-add-form">
                    <div style="width: 100%;">
                        <label for="bulk-names">รายชื่อ:</label>
                        <textarea id="bulk-names" rows="5" placeholder="สมชาย&#10;สมศรี&#10;สมหงิง"></textarea>
                    </div>
                    <div>
                        <label for="bulk-skill">ระดับมือ (สำหรับทุกคน):</label>
                        <select id="bulk-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N" selected>N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success">เพิ่มทั้งหมด</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>รายชื่อผู้เล่นทั้งหมด</h2>
                <input type="text" id="player-search" class="search-bar" placeholder="ค้นหาผู้เล่น...">
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 100px;">ID</th>
                                <th>ชื่อผู้เล่น</th>
                                <th style="width: 100px;">ระดับมือ</th>
                                <th style="width: 300px;">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="player-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="card bulk-edit-section">
                <h3>แก้ไขระดับมือแบบรวม</h3>
                <p>เลือกผู้เล่นที่ต้องการแล้ว และเปลี่ยนระดับมือให้หมด</p>
                <div class="bulk-edit-list" id="bulk-edit-list"></div>
                <form id="bulk-edit-form">
                    <div>
                        <label for="bulk-edit-skill">ระดับมือใหม่:</label>
                        <select id="bulk-edit-skill">
                            <option value="BG">BG (Beginner)</option>
                            <option value="N-">N- (N-Minus)</option>
                            <option value="N">N (Normal)</option>
                            <option value="N+">N+ (N-Plus)</option>
                            <option value="P">P (Pro)</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="success">อัปเดตระดับมือ</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="check-in" class="view">
            <div class="card">
                <h2>เช็คอินผู้เล่น</h2>
                <p>กดที่ชื่อผู้เล่นเพื่อเช็คอิน (ผู้เล่นที่เช็คอินแล้วจะยังคงสถานะนั้นหลังจบเกม 🏸 ผู้เล่นที่กำลังลงสนามจะมีไอคอน 🏸</p>
                <div id="check-in-list" class="check-in-grid"></div>
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="danger" onclick="resetAllCheckIns()">🔄 รีเซ็ตการเช็คอินทั้งหมด</button>
                </div>
            </div>
        </section>

        <section id="match-setup" class="view">
            <div class="card">
                <h2>จัดคู่แข่งขันสนาม</h2>
                <div id="match-setup-controls" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light);">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="court-select-dropdown">เลือกสนามที่จะลง:</label>
                            <select id="court-select-dropdown"></select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <button class="warning" onclick="manualSetupStart()" id="btn-manual-setup">จัดคู่เอง</button>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <button class="success" onclick="simpleRandomMatch()" id="btn-random-setup" disabled>จับสลากสุ่ม (4 คน)</button>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <button class="secondary" onclick="queueMatchStart()" id="btn-queue-setup" disabled>จัดคิวเรือ (เกมต่ำสุด)</button>
                        </div>
                    </div>
                </div>
                <div id="match-setup-content">
                    <p>กรุณาไปที่หน้า "เช็คอิน" เพื่อเลือกผู้เล่นที่จะเข้าร่วมก่อน</p>
                </div>
            </div>
        </section>

        <section id="active-matches" class="view">
            <div class="card">
                <h2>สตั้อกลูกแบดพร้อมใช้</h2>
                <div class="shuttle-counter">
                    <div>
                        <div class="count" id="live-shuttle-in-play">0</div>
                        <div>ลูกแบดพร้อมใช้ (ลูกซ้อม)</div>
                    </div>
                </div>
                <form id="live-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="live-shuttle-action">จัดการสตั้อก:</label>
                        <select id="live-shuttle-action">
                            <option value="add">เพิ่มลูกใหม่ (เข้าสตั้อก)</option>
                            <option value="add-practice">เพิ่มลูกซ้อม (เข้าสตั้อก)</option>
                            <option value="remove">ลบลูกซ้อม (ทิ้ง)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="live-shuttle-amount">จำนวน:</label>
                        <input type="number" id="live-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit">ตกลง</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>สนามที่กำลังแข่งขันสนาม</h2>
                <p style="color: var(--secondary); font-weight: bold;">หมายเหตุ: ระบบได้หักลูกแบดพร้อมใช้ (ลูกซ้อม) ออกไป 1 ลูกแล้ว เมื่อเริ่มแมตช์</p>
                <div id="active-matches-list"></div>
            </div>
        </section>



        <section id="settings" class="view">
            <div class="card">
                <h2>ตั้งค่าสนาม</h2>
                <h3>จัดการสนาม</h3>
                <form id="add-court-form">
                    <div>
                        <label for="court-name">ชื่อสนาม:</label>
                        <input type="text" id="court-name" required>
                    </div>
                    <div>
                        <button type="submit">เพิ่มสนาม</button>
                    </div>
                </form>
                <div id="court-list" style="margin-top: 20px;"></div>
            </div>
            <div class="card">
                <h3>จัดการลูกแบด</h3>
                 <div class="shuttle-counter">
                    <div>
                        <div class="count" id="settings-shuttle-in-play">0</div>
                        <div>ลูกซ้อม (พร้อมใช้)</div>
                    </div>
                </div>
                <form id="settings-shuttle-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; min-width: 150px;">
                        <label for="settings-shuttle-action">การกระทำ:</label>
                        <select id="settings-shuttle-action">
                            <option value="add">เพิ่มลูกใหม่ (เข้าสตั้อก)</option>
                            <option value="add-practice">เพิ่มลูกซ้อม (เข้าสตั้อก)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 80px;">
                        <label for="settings-shuttle-amount">จำนวน:</label>
                        <input type="number" id="settings-shuttle-amount" value="1" min="1">
                    </div>
                    <div>
                        <button type="submit">ตกลง</button>
                    </div>
                </form>
            </div>
        </section>
        
        <section id="manager-tools" class="view">
            <div class="card">
                <h2>เครื่องมือผู้ดูแลระบบ</h2>
                <p>เครื่องมือเหล่านี้ใช้สำหรับจัดการข้อมูลในระบบทั้งหมด</p>
                
                <h3>ล้างข้อมูลผู้เล่นทั้งหมด</h3>
                <p style="color: var(--danger); font-weight: bold;">การกระทำนี้จะลบผู้เล่นทั้งหมดออกจากระบบ (แต่ข้อมูลประวัติการเล่นยังคงอยู่)</p>
                <button class="danger" onclick="clearAllPlayers()">เคลียร์ผู้เล่นทั้งหมด</button>
            </div>
        </section>

    </main>

    <!-- Modal สำหรับประวัติผู้เล่น -->
    <div id="player-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-player-name">ประวัติการเล่น</h2>
                <button class="close-modal" onclick="closePlayerHistoryModal()">✕</button>
            </div>
            <div id="modal-player-stats"></div>
            <div id="modal-game-records"></div>
        </div>
    </div>

<script>
    // ============================================================
    // UTILITY FUNCTIONS - ฟังก์ชันช่วยทั่วไป
    // ============================================================

    function showError(message) {
        alert(`❌ ข้อผิดพลาด: ${message}`);
    }

    function showSuccess(message) {
        alert(`✅ สำเร็จ: ${message}`);
    }

    function validatePlayerName(name) {
        if (!name || name.trim().length === 0) {
            return { valid: false, error: 'ชื่อผู้เล่นห้ามว่าง' };
        }
        if (name.trim().length > 50) {
            return { valid: false, error: 'ชื่อผู้เล่นยาวเกินไป (สูงสุด 50 ตัวอักษร)' };
        }
        if (appState.players.some(p => p.name.toLowerCase() === name.trim().toLowerCase())) {
            return { valid: false, error: 'ชื่อผู้เล่นนี้มีอยู่แล้ว' };
        }
        return { valid: true, error: '' };
    }

    function validateSkill(skill) {
        return ['BG', 'N-', 'N', 'N+', 'P'].includes(skill);
    }

    function validateNumber(value, minValue = 1) {
        const num = parseInt(value);
        if (isNaN(num) || num < minValue) {
            return { valid: false, error: `ต้องเป็นตัวเลขและมากกว่า ${minValue - 1}` };
        }
        return { valid: true, error: '' };
    }

    function saveStateToStorage() {
        try {
            const stateToSave = { ...appState };
            localStorage.setItem('badmintonAppState', JSON.stringify(stateToSave));
            return true;
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                console.warn('⚠️ Storage เต็มแล้ว');
            }
            return false;
        }
    }

    const PlayerUtils = {
        getById: (id) => {
            const player = appState.players.find(p => p.id === id);
            if (!player) {
                console.warn(`❌ ไม่พบผู้เล่น ID: ${id}`);
                return null;
            }
            return player;
        },

        isAvailable: (player) => player && player.isCheckedIn && !player.isPlaying,

        getGameCount: (playerId) => {
            const history = appState.history[playerId];
            return history && Array.isArray(history.games) ? history.games.length : 0;
        }
    };

    const CourtUtils = {
        getAvailable: () => appState.courts.filter(c => c.status === 'free'),

        getById: (id) => {
            const court = appState.courts.find(c => c.id == id);
            if (!court) {
                console.warn(`❌ ไม่พบสนาม ID: ${id}`);
                return null;
            }
            return court;
        }
    };

    // --- DATA STATE ---
    let appState = {
        players: [],
        courts: [],
        matches: [],
        history: {},
        shuttlecocks: { total: 0, inPlay: 0, repair: 0 },
        nextId: { player: 1, court: 1, match: 1 }
    };
    let manualSelectionOrder = [];
    let matchTimers = {};
    
    const SKILL_TO_VALUE = { 'BG': 1, 'N-': 2, 'N': 3, 'N+': 4, 'P': 5 };

    // --- LOCAL STORAGE ---
    function saveState() {
        saveStateToStorage();
    }

    function loadState() {
        try {
            const savedState = localStorage.getItem('badmintonAppState');
            if (savedState) {
                appState = JSON.parse(savedState);
                
                if (typeof appState.history !== 'object' || appState.history === null || Array.isArray(appState.history)) {
                    console.warn("⚠️ History data corrupted");
                    appState.history = {};
                }
                
                appState.players.forEach(p => {
                    if (typeof p.isCheckedIn === 'undefined') p.isCheckedIn = false;
                    if (typeof p.isPlaying === 'undefined') p.isPlaying = false;
                    if (!appState.history[p.id]) {
                        appState.history[p.id] = { games: [] };
                    } else if (!Array.isArray(appState.history[p.id].games)) {
                        appState.history[p.id].games = [];
                    }
                });
                
                appState.matches.forEach(m => {
                    if (typeof m.newShuttleUsed === 'undefined') m.newShuttleUsed = 0;
                    if (typeof m.practiceShuttleUsed === 'undefined') m.practiceShuttleUsed = 0;
                });
                
                const maxPlayerId = appState.players.length > 0 ? Math.max(...appState.players.map(p => p.id)) : 0;
                const maxCourtId = appState.courts.length > 0 ? Math.max(...appState.courts.map(c => c.id)) : 0;
                
                let maxGameId = 0;
                Object.values(appState.history).forEach(playerHistory => {
                    if (playerHistory && Array.isArray(playerHistory.games)) {
                        playerHistory.games.forEach(game => {
                            if (game.id > maxGameId) maxGameId = game.id;
                        });
                    }
                });
                const maxMatchId = appState.matches.length > 0 ? Math.max(...appState.matches.map(m => m.id)) : 0;

                appState.nextId = {
                    player: maxPlayerId + 1,
                    court: maxCourtId + 1,
                    match: Math.max(maxMatchId, maxGameId) + 1
                };

                appState.matches.forEach(match => {
                    if (match.startTime) {
                        const card = document.querySelector(`.match-card[data-match-id="${match.id}"]`);
                        if (card) {
                            startTimer(match.id, card);
                        }
                    }
                });
            }
        } catch (e) {
            console.error('❌ ข้อผิดพลาดในการโหลด state:', e);
        }
    }
    
    // --- UTILITIES ---
    function formatTime(ms) {
        if (!ms) return '00:00';
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function startTimer(matchId, card) {
        if (matchTimers[matchId]) {
            clearInterval(matchTimers[matchId]);
        }

        const match = appState.matches.find(m => m.id === matchId);
        if (!match) return;

        if (!match.startTime) {
            match.startTime = Date.now();
            saveState();
        }

        const timerEl = card ? card.querySelector(`#match-timer-${matchId}`) : document.getElementById(`match-timer-${matchId}`);
        if (!timerEl) return;

        const updateTimer = () => {
            const elapsedTime = Date.now() - match.startTime;
            timerEl.textContent = formatTime(elapsedTime);
        };

        updateTimer();
        matchTimers[matchId] = setInterval(updateTimer, 1000);
    }

    function stopTimer(matchId) {
        if (matchTimers[matchId]) {
            clearInterval(matchTimers[matchId]);
            delete matchTimers[matchId];
        }
    }

    function getSkillClass(skill) {
        return skill.replace('+', 'plus').replace('-', 'minus');
    }

    function getPlayerGameCount(playerId) {
        return PlayerUtils.getGameCount(playerId);
    }

    // --- VIEW MANAGEMENT ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');

        const activeNavBtn = document.querySelector(`nav button[onclick*="${viewId}"]`);
        if(activeNavBtn) activeNavBtn.classList.add('active');

        if (viewId === 'dashboard') renderDashboard();
        if (viewId === 'player-management') renderPlayerList();
        if (viewId === 'check-in') renderCheckInList();
        if (viewId === 'match-setup') renderMatchSetup();
        if (viewId === 'active-matches') renderActiveMatches();
        if (viewId === 'settings') renderSettings();
    }

    function navigateAndShow(viewId) {
        showView(viewId);
    }

    function updateShuttleCounterDisplay() {
        const inPlay = appState.shuttlecocks.inPlay; 

        const dashInPlayEl = document.getElementById('dash-shuttle-in-play');
        if(dashInPlayEl) dashInPlayEl.textContent = inPlay;

        const liveInPlayEl = document.getElementById('live-shuttle-in-play');
        if(liveInPlayEl) liveInPlayEl.textContent = inPlay;

        const settingsInPlayEl = document.getElementById('settings-shuttle-in-play');
        if(settingsInPlayEl) settingsInPlayEl.textContent = inPlay;
    }

    // --- DASHBOARD FUNCTIONS ---
    function renderDashboard() {
        const totalPlayers = appState.players.length;
        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn).length;
        const activeMatches = appState.matches.length;
        const shuttleInPlay = appState.shuttlecocks.inPlay;

        document.getElementById('dash-total-players').textContent = totalPlayers;
        document.getElementById('dash-checked-in').textContent = checkedInPlayers;
        document.getElementById('dash-active-matches').textContent = activeMatches;
        document.getElementById('dash-shuttle-in-play').textContent = shuttleInPlay;

        renderDashboardPlayerStats();
        renderFrequentPartners();
        renderFrequentOpponents();
        updateShuttleCounterDisplay();
    }

    function renderDashboardPlayerStats() {
        const listEl = document.getElementById('dashboard-player-list');
        listEl.innerHTML = '';
        
        const playerGameCounts = {};
        appState.players.forEach(p => {
            playerGameCounts[p.id] = getPlayerGameCount(p.id);
        });

        const sortedPlayers = appState.players.slice().sort((a, b) => {
            const countA = playerGameCounts[a.id];
            const countB = playerGameCounts[b.id];
            if (countA !== countB) return countA - countB;
            return a.name.localeCompare(b.name, 'th');
        });

        sortedPlayers.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            const card = document.createElement('div');
            card.classList.add('dashboard-player-card');
            card.style.cursor = 'pointer';
            card.onclick = () => openPlayerHistoryModal(player.id);
            card.innerHTML = `
                <div class="player-name">#${player.id} ${player.name}</div>
                <div class="player-skill"><span class="skill-badge skill-${skillClass}">${player.skill}</span></div>
                <div class="game-count">${playerGameCounts[player.id]} เกม</div>
            `;
            listEl.appendChild(card);
        });
    }

    function renderFrequentPartners() {
        const listEl = document.getElementById('frequent-partners-list');
        listEl.innerHTML = '';

        const partnerMap = {};

        Object.entries(appState.history).forEach(([playerIdStr, playerHistory]) => {
            if (playerHistory && Array.isArray(playerHistory.games)) {
                const playerId = parseInt(playerIdStr);
                playerHistory.games.forEach(game => {

                    if (game.team1.includes(playerId)) {
                        game.team1.forEach(partnerId => {
                            if (partnerId !== playerId) {
                                partnerMap[partnerId] = (partnerMap[partnerId] || 0) + 1;
                            }
                        });
                    } else if (game.team2.includes(playerId)) {
                        game.team2.forEach(partnerId => {
                            if (partnerId !== playerId) {
                                partnerMap[partnerId] = (partnerMap[partnerId] || 0) + 1;
                            }
                        });
                    }
                });
            }
        });

        const sortedPartners = Object.entries(partnerMap)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 10);

        if (sortedPartners.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1/-1;">ยังไม่มีประวัติการจับคู่</p>';
            return;
        }

        sortedPartners.forEach(([partnerId, count]) => {
            const partner = PlayerUtils.getById(parseInt(partnerId));
            if (!partner) return;

            const card = document.createElement('div');
            card.style.cssText = 'background-color: var(--light); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--success);';
            card.innerHTML = `
                <div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">#${partner.id} ${partner.name}</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${count}</div>
                <div style="font-size: 0.85rem; color: #888;">ครั้งที่เล่นด้วยกัน</div>
            `;
            listEl.appendChild(card);
        });
    }

    function renderFrequentOpponents() {
        const listEl = document.getElementById('frequent-opponents-list');
        listEl.innerHTML = '';

        const opponentMap = {};

        Object.entries(appState.history).forEach(([playerIdStr, playerHistory]) => {
            if (playerHistory && Array.isArray(playerHistory.games)) {
                playerHistory.games.forEach(game => {
                    const playerId = parseInt(playerIdStr);

                    if (game.team1.includes(playerId)) {
                        game.team2.forEach(opponentId => {
                            if (!opponentMap[opponentId]) {
                                opponentMap[opponentId] = { wins: 0, losses: 0 };
                            }
                            if (game.winner === 1) {
                                opponentMap[opponentId].losses++;
                            } else if (game.winner === 2) {
                                opponentMap[opponentId].wins++;
                            }
                        });
                    } else if (game.team2.includes(playerId)) {
                        game.team1.forEach(opponentId => {
                            if (!opponentMap[opponentId]) {
                                opponentMap[opponentId] = { wins: 0, losses: 0 };
                            }
                            if (game.winner === 2) {
                                opponentMap[opponentId].losses++;
                            } else if (game.winner === 1) {
                                opponentMap[opponentId].wins++;
                            }
                        });
                    }
                });
            }
        });

        const sortedOpponents = Object.entries(opponentMap)
            .map(([opponentId, stats]) => ({
                id: opponentId,
                ...stats,
                total: stats.wins + stats.losses
            }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 10);

        if (sortedOpponents.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; color: #888; grid-column: 1/-1;">ยังไม่มีประวัติการเจอหน้า</p>';
            return;
        }

        sortedOpponents.forEach(({ id, wins, losses, total }) => {
            const opponent = PlayerUtils.getById(parseInt(id));
            if (!opponent) return;

            const winRate = total > 0 ? ((wins / total) * 100).toFixed(0) : 0;
            const card = document.createElement('div');
            card.style.cssText = 'background-color: var(--light); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--danger);';
            card.innerHTML = `
                <div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">#${opponent.id} ${opponent.name}</div>
                <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">
                    <span style="color: var(--success);">${wins}W</span> <span style="color: var(--danger);">${losses}L</span>
                </div>
                <div style="font-size: 0.85rem; color: #888;">${total} ครั้ง (ชนะ ${winRate}%)</div>
            `;
            listEl.appendChild(card);
        });
    }

    // --- PLAYER MANAGEMENT FUNCTIONS ---
    function addPlayer(name, skill) {
        const nameValidation = validatePlayerName(name);
        if (!nameValidation.valid) {
            return { success: false, error: nameValidation.error };
        }

        if (!validateSkill(skill)) {
            return { success: false, error: 'ระดับมือไม่ถูกต้อง' };
        }

        const newPlayer = {
            id: appState.nextId.player++,
            name: name.trim(),
            skill: skill,
            isCheckedIn: false,
            isPlaying: false
        };
        
        appState.players.push(newPlayer);
        appState.history[newPlayer.id] = { games: [] };
        return { success: true, player: newPlayer };
    }

    function addPlayersBulk(namesText, skill) {
        if (!validateSkill(skill)) {
            showError('ระดับมือไม่ถูกต้อง');
            return;
        }

        const names = namesText.split('\n').map(n => n.trim()).filter(n => n.length > 0);
        
        if (names.length === 0) {
            showError('ไม่มีชื่อผู้เล่นที่ถูกต้อง');
            return;
        }

        const added = [];
        const duplicates = [];
        const failed = [];

        names.forEach(name => {
            if (appState.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                duplicates.push(name);
                return;
            }
            const result = addPlayer(name, skill);
            if (result.success) {
                added.push(name);
            } else {
                failed.push(`${name} (${result.error})`);
            }
        });

        saveState();
        renderPlayerList();
        
        let message = `📊 สรุปการเพิ่มผู้เล่น\n━━━━━━━━━━━━━━━`;
        
        if (added.length > 0) {
            message += `\n✅ เพิ่มสำเร็จ: ${added.length} คน\n${added.map(n => `   • ${n}`).join('\n')}`;
        }
        
        if (duplicates.length > 0) {
            message += `\n⚠️ ชื่อซ้ำ: ${duplicates.length} คน\n${duplicates.map(n => `   • ${n}`).join('\n')}`;
        }
        
        if (failed.length > 0) {
            message += `\n❌ ล้มเหลว: ${failed.length} คน\n${failed.map(n => `   • ${n}`).join('\n')}`;
        }
        
        message += `\n━━━━━━━━━━━━━━━\nรวมทั้งสิ้น: ${names.length} คน`;
        
        alert(message);
    }

    function deletePlayer(id) {
        const player = PlayerUtils.getById(id);
        if (!player) return;

        const gameCount = getPlayerGameCount(id);
        
        const message = `คุณแน่ใจหรือว่าต้องการลบ ${player.name}?
        
เกมที่เล่นมา: ${gameCount} เกม
⚠️ การกระทำนี้ไม่สามารถยกเลิกได้`;
        
        if (confirm(message)) {
            appState.players = appState.players.filter(p => p.id !== id);
            appState.matches = appState.matches.filter(m => !m.team1.includes(id) && !m.team2.includes(id));
            delete appState.history[id];
            saveState();
            renderPlayerList();
            renderActiveMatches();
            showSuccess(`ลบ ${player.name} สำเร็จ`);
        }
    }

    function updatePlayerName(id, newName) {
        const player = PlayerUtils.getById(id);
        if (!player) return;

        const nameValidation = validatePlayerName(newName);
        if (!nameValidation.valid) {
            showError(nameValidation.error);
            return;
        }

        if (appState.players.some(p => p.id !== id && p.name.toLowerCase() === newName.trim().toLowerCase())) {
            showError('ชื่อผู้เล่นนี้มีอยู่แล้ว');
            return;
        }

        const oldName = player.name;
        player.name = newName.trim();
        saveState();
        renderPlayerList(document.getElementById('player-search').value);
        showSuccess(`เปลี่ยนชื่อจาก "${oldName}" เป็น "${player.name}" สำเร็จ`);
    }

    function updatePlayerSkill(id, newSkill) {
        if (!validateSkill(newSkill)) {
            showError('ระดับมือไม่ถูกต้อง');
            return;
        }

        const player = PlayerUtils.getById(id);
        if (!player) return;

        if (player.skill === newSkill) {
            alert('ระดับมือเดิมอยู่แล้ว');
            return;
        }

        player.skill = newSkill;
        saveState();
        renderPlayerList(document.getElementById('player-search').value);
        showSuccess(`อัปเดตระดับมือ ${player.name} เป็น ${newSkill}`);
    }

    function updatePlayerSkillBulk(newSkill) {
        if (!validateSkill(newSkill)) {
            showError('ระดับมือไม่ถูกต้อง');
            return;
        }

        const checkboxes = document.querySelectorAll('#bulk-edit-list input[type="checkbox"]:checked');
        
        if (checkboxes.length === 0) {
            showError('กรุณาเลือกผู้เล่นอย่างน้อยหนึ่งคน');
            return;
        }

        let updatedCount = 0;
        checkboxes.forEach(checkbox => {
            const playerId = parseInt(checkbox.dataset.playerId);
            const player = PlayerUtils.getById(playerId);
            if (player && player.skill !== newSkill) {
                player.skill = newSkill;
                updatedCount++;
            }
        });

        if (updatedCount > 0) {
            saveState();
            renderPlayerList(document.getElementById('player-search').value);
            showSuccess(`อัปเดตระดับมือผู้เล่น ${updatedCount} คนเป็น ${newSkill}`);
        } else {
            alert('ผู้เล่นที่เลือกมีระดับมือนี้อยู่แล้ว');
        }
    }

    function renderPlayerList(filter = '') {
        const listEl = document.getElementById('player-list');
        const bulkEditListEl = document.getElementById('bulk-edit-list');
        listEl.innerHTML = '';
        bulkEditListEl.innerHTML = '';

        const filteredPlayers = appState.players.filter(p => 
            p.name.toLowerCase().includes(filter.toLowerCase()) || 
            p.id.toString().includes(filter)
        );

        if (filteredPlayers.length === 0 && filter.length > 0) {
            listEl.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888;">ไม่พบผู้เล่นที่ตรงกัน</td></tr>';
        }

        filteredPlayers.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight: bold; color: var(--secondary);">#${player.id}</td>
                <td>
                    <input type="text" id="name-edit-${player.id}" value="${player.name}" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                           placeholder="ชื่อผู้เล่น">
                </td>
                <td><span class="skill-badge skill-${skillClass}">${player.skill}</span></td>
                <td>
                    <div class="edit-form" style="gap: 0.25rem;">
                        <button class="success" style="padding: 0.5rem 1rem; font-size: 0.85rem;" 
                                onclick="updatePlayerName(${player.id}, document.getElementById('name-edit-${player.id}').value)">บันทึกชื่อ</button>
                        <select id="edit-skill-${player.id}" class="edit-mode" style="padding: 0.5rem; width: auto;">
                            ${['BG', 'N-', 'N', 'N+', 'P'].map(s => 
                                `<option value="${s}" ${s === player.skill ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                        <button class="warning" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                onclick="updatePlayerSkill(${player.id}, document.getElementById('edit-skill-${player.id}').value)">อัปเดตระดับ</button>
                        <button class="danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;"
                                onclick="deletePlayer(${player.id})">ลบ</button>
                    </div>
                </td>
            `;
            listEl.appendChild(tr);

            const bulkItem = document.createElement('div');
            bulkItem.classList.add('bulk-edit-item');
            bulkItem.innerHTML = `
                <span>#${player.id} ${player.name} <span class="skill-badge skill-${skillClass}">${player.skill}</span></span>
                <input type="checkbox" data-player-id="${player.id}">
            `;
            bulkEditListEl.appendChild(bulkItem);
        });
    }

    // --- MANAGER TOOLS FUNCTIONS ---
    function clearAllPlayers() {
        if (appState.matches.length > 0) {
            alert('ไม่สามารถถ้างข้อมูลผู้เล่นได้! มีผู้เล่นบางคนกำลังแข่งขันอยู่');
            return;
        }

        if (confirm(`คุณแน่ใจหรือว่าต้องการลบข้อมูลผู้เล่นทั้งหมด?\n⚠️ การกระทำนี้ไม่สามารถถอยกลับได้`)) {
            appState.players = [];
            appState.nextId.player = 1;
            saveState();
            renderDashboard();
            renderPlayerList();
            renderCheckInList();
            renderHistoryPlayers();
            showSuccess('ลบข้อมูลผู้เล่นทั้งหมดสำเร็จ');
        }
    }
    
    // --- CHECK-IN FUNCTIONS ---
    function toggleCheckIn(id) {
        const player = PlayerUtils.getById(id);
        if (!player) return;

        if (player.isPlaying) {
            showError(`${player.name} กำลังแข่งขันอยู่`);
            return;
        }

        player.isCheckedIn = !player.isCheckedIn;
        
        if (player.isCheckedIn) {
            player.checkInTime = Date.now();
        } else {
            delete player.checkInTime;
        }

        saveState();
        renderCheckInList();
        renderDashboard();
    }

    function resetAllCheckIns() {
        if (appState.players.some(p => p.isPlaying)) {
            showError('ไม่สามารถรีเซ็ตได้ มีผู้เล่นบางคนกำลังแข่งขันอยู่');
            return;
        }

        if (confirm('คุณแน่ใจหรือว่าต้องการรีเซ็ตการเช็คอินทั้งหมด?')) {
            appState.players.forEach(p => {
                p.isCheckedIn = false;
                p.isPlaying = false;
                delete p.checkInTime;
            });
            saveState();
            renderCheckInList();
            renderDashboard();
            showSuccess('รีเซ็ตการเช็คอินสำเร็จ');
        }
    }

    function renderCheckInList() {
        const listEl = document.getElementById('check-in-list');
        listEl.innerHTML = '';

        const playingIds = new Set();
        appState.matches.forEach(m => {
            [...m.team1, ...m.team2].forEach(id => playingIds.add(id));
        });
        
        appState.players.forEach(p => {
            p.isPlaying = playingIds.has(p.id);
        });
        saveState();

        const sortedPlayers = appState.players.slice().sort((a, b) => {
            const statusA = a.isCheckedIn ? (a.isPlaying ? 2 : 1) : 3;
            const statusB = b.isCheckedIn ? (b.isPlaying ? 2 : 1) : 3;

            if (statusA !== statusB) return statusA - statusB;

            if (a.isCheckedIn && b.isCheckedIn && !a.isPlaying && !b.isPlaying) {
                if (a.checkInTime && b.checkInTime) {
                    if (a.checkInTime !== b.checkInTime) return a.checkInTime - b.checkInTime;
                }
            }

            return a.name.localeCompare(b.name, 'th');
        });

        sortedPlayers.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            const gameCount = getPlayerGameCount(player.id);
            const card = document.createElement('div');
            card.classList.add('check-in-card');
            
            if (player.isCheckedIn) card.classList.add('checked-in');
            if (player.isPlaying) card.classList.add('playing-now');
            
            card.onclick = () => toggleCheckIn(player.id);

            let statusIcon = player.isCheckedIn ? '✅' : '❌';
            if (player.isPlaying) {
                statusIcon = '🏸';
                card.classList.remove('checked-in');
            }

            card.innerHTML = `
                <div class="player-name">${player.name}</div>
                <div class="player-skill"><span class="skill-badge skill-${skillClass}">${player.skill}</span></div>
                <div style="font-size:0.8rem; color:#888;">(${gameCount} เกม)</div>
                <div class="status-icon">${statusIcon}</div>
            `;
            listEl.appendChild(card);
        });
    }

    // --- MATCH SETUP FUNCTIONS ---
    function renderCourtSelectDropdown(targetId) {
        const selectEl = document.getElementById(targetId);
        selectEl.innerHTML = '';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- เลือกสนามว่าง --';
        selectEl.appendChild(defaultOption);

        const availableCourts = CourtUtils.getAvailable();
        availableCourts.forEach(court => {
            const option = document.createElement('option');
            option.value = court.id;
            option.textContent = court.name;
            selectEl.appendChild(option);
        });

        const hasAvailableCourt = availableCourts.length > 0;
        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        const canSetup = hasAvailableCourt && checkedInPlayers.length >= 4;
        
        document.getElementById('btn-random-setup').disabled = !canSetup;
        document.getElementById('btn-queue-setup').disabled = !canSetup;
        document.getElementById('btn-manual-setup').disabled = !hasAvailableCourt;
    }

    function renderMatchSetup() {
        renderCourtSelectDropdown('court-select-dropdown');

        const setupContentEl = document.getElementById('match-setup-content');
        setupContentEl.innerHTML = '<p>กรุณาไปที่หน้า "เช็คอิน" เพื่อเลือกผู้เล่นที่จะเข้าร่วมก่อน</p>';
        manualSelectionOrder = [];
    }

    function getPlayerSkillValue(skill) {
        return SKILL_TO_VALUE[skill] || 3;
    }

    function createMatch(courtId, team1Ids, team2Ids) {
        if (!courtId || team1Ids.length !== 2 || team2Ids.length !== 2) {
            showError('ข้อมูลเกมไม่ครบถ้วน');
            return false;
        }

        const court = CourtUtils.getById(courtId);
        if (!court || court.status !== 'free') {
            showError('สนามไม่ว่างหรือไม่พบ');
            return false;
        }
        
        if (appState.shuttlecocks.inPlay < 1) {
            showError('ลูกแบดพร้อมใช้ไม่พอ');
            return false;
        }

        appState.shuttlecocks.inPlay -= 1;

        const matchId = appState.nextId.match++;
        const newMatch = {
            id: matchId,
            courtId: courtId,
            courtName: court.name,
            team1: team1Ids,
            team2: team2Ids,
            startTime: Date.now(),
            newShuttleUsed: 1,
            practiceShuttleUsed: 0
        };

        appState.matches.push(newMatch);
        court.status = 'playing';
        court.currentMatchId = matchId;

        [...team1Ids, ...team2Ids].forEach(playerId => {
            const player = PlayerUtils.getById(playerId);
            if (player) {
                player.isPlaying = true;
            }
        });

        saveState();
        renderActiveMatches();
        renderCheckInList();
        renderDashboard();
        showView('active-matches');
        showSuccess(`จัดคู่สำเร็จ! สนาม ${court.name}`);
        return true;
    }

    // --- MANUAL SETUP ---
    function manualSetupStart() {
        const courtId = document.getElementById('court-select-dropdown').value;
        if (!courtId) {
            showError('กรุณาเลือกสนามว่างก่อน');
            return;
        }

        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        if (checkedInPlayers.length < 4) {
            showError('ต้องมีผู้เล่นที่เช็คอินและว่างอยู่ 4 คนขึ้นไป');
            return;
        }

        // เรียงผู้เล่นตามจำนวนเกมที่เล่น (น้อยไปมาก)
        const sortedPlayers = checkedInPlayers.sort((a, b) => {
            const countA = getPlayerGameCount(a.id);
            const countB = getPlayerGameCount(b.id);
            return countA - countB; // น้อยไปมาก
        });

        const setupContentEl = document.getElementById('match-setup-content');
        setupContentEl.innerHTML = `
            <h3>สนาม ${appState.courts.find(c => c.id == courtId).name}</h3>
            <p>เลือกผู้เล่น 4 คนตามลำดับ (1-2 สำหรับทีม 1, 3-4 สำหรับทีม 2) <span id="selection-status" style="font-weight: bold; color: var(--secondary);">: เลือกคนที่ 1</span></p>
            <p style="font-size: 0.85rem; color: #666; margin-top: -0.5rem;">📊 เรียงตามจำนวนเกมที่เล่น (น้อย → มาก)</p>
            <div id="manual-selection-grid" class="check-in-grid"></div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="success" onclick="confirmManualMatch(${courtId})" id="btn-confirm-manual" disabled>ยืนยันคู่แข่งขันสนาม</button>
                <button class="danger" onclick="renderMatchSetup()">ยกเลิก</button>
            </div>
        `;

        manualSelectionOrder = [];
        renderManualSelectionGrid(sortedPlayers);
    }

    function renderManualSelectionGrid(players) {
        const gridEl = document.getElementById('manual-selection-grid');
        const statusEl = document.getElementById('selection-status');
        const confirmBtn = document.getElementById('btn-confirm-manual');
        gridEl.innerHTML = '';

        players.forEach(player => {
            const skillClass = getSkillClass(player.skill);
            const gameCount = getPlayerGameCount(player.id);
            const isSelected = manualSelectionOrder.includes(player.id);
            const card = document.createElement('div');
            card.classList.add('check-in-card');
            if (isSelected) card.style.backgroundColor = '#e0f7fa';
            card.onclick = () => toggleManualSelection(player.id, players);

            let orderBadge = '';
            if (isSelected) {
                const order = manualSelectionOrder.indexOf(player.id) + 1;
                orderBadge = `<div style="position: absolute; top: 5px; right: 5px; background: var(--secondary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${order}</div>`;
            }

            card.innerHTML = `
                ${orderBadge}
                <div class="player-name">#${player.id} ${player.name}</div>
                <div class="player-skill"><span class="skill-badge skill-${skillClass}">${player.skill}</span></div>
                <div style="font-size: 0.8rem; color: #888;">${gameCount} เกม</div>
            `;
            gridEl.appendChild(card);
        });

        statusEl.textContent = `: เลือกคนที่ ${manualSelectionOrder.length + 1}`;
        confirmBtn.disabled = manualSelectionOrder.length !== 4;
    }

    function toggleManualSelection(playerId, players) {
        const index = manualSelectionOrder.indexOf(playerId);
        if (index > -1) {
            manualSelectionOrder.splice(index, 1);
        } else if (manualSelectionOrder.length < 4) {
            manualSelectionOrder.push(playerId);
        }
        renderManualSelectionGrid(players);
    }

    function confirmManualMatch(courtId) {
        if (manualSelectionOrder.length !== 4) {
            showError('กรุณาเลือกผู้เล่นให้ครบ 4 คน');
            return;
        }

        const team1Ids = [manualSelectionOrder[0], manualSelectionOrder[1]];
        const team2Ids = [manualSelectionOrder[2], manualSelectionOrder[3]];

        const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
        const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

        if (confirm(`คุณต้องการจัดคู่:\nทีม 1: ${team1Names}\nทีม 2: ${team2Names}\nลงสนามหรือไม่?`)) {
            const availableCourts = CourtUtils.getAvailable();
            if (availableCourts.length > 0) {
                if (createMatch(availableCourts[0].id, team1Ids, team2Ids)) {
                    manualSelectionOrder = [];
                    renderCourtSelectDropdown('court-select-dropdown');
                }
            } else {
                showError('ไม่มีสนามว่างให้ใช้ในขณะนี้');
            }
        }
    }

    // --- RANDOM MATCH SETUP ---
    function simpleRandomMatch() {
        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        if (checkedInPlayers.length < 4) {
            showError('ต้องมีผู้เล่นที่เช็คอินและว่างอยู่ 4 คนขึ้นไป');
            return;
        }

        const availableCourts = CourtUtils.getAvailable();
        if (availableCourts.length === 0) {
            showError('ไม่มีสนามว่างให้ใช้ในขณะนี้');
            return;
        }

        // สุ่ม 4 คนจากผู้เล่นที่เช็คอิน
        const shuffledPlayers = checkedInPlayers.sort(() => 0.5 - Math.random());
        const selectedPlayers = shuffledPlayers.slice(0, 4);
        
        // เรียงลำดับตามระดับมือ (จากสูงสุดถึงต่ำสุด)
        selectedPlayers.sort((a, b) => 
            getPlayerSkillValue(b.skill) - getPlayerSkillValue(a.skill)
        );

        // จับคู่แบบ balanced: (สูง + ต่ำ) vs (สูง + ต่ำ)
        const team1Ids = [selectedPlayers[0].id, selectedPlayers[3].id];
        const team2Ids = [selectedPlayers[1].id, selectedPlayers[2].id];

        const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
        const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
        
        const team1Skills = team1Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');
        const team2Skills = team2Ids.map(id => PlayerUtils.getById(id).skill).join(' + ');
        
        if (confirm(`จับสลากได้คู่ (Balanced):\n\nทีม 1: ${team1Names}\n       (${team1Skills})\n\nทีม 2: ${team2Names}\n       (${team2Skills})\n\nลงสนามหรือไม่?`)) {
            if (createMatch(availableCourts[0].id, team1Ids, team2Ids)) {
                renderCourtSelectDropdown('court-select-dropdown');
            }
        }
    }

    // --- ADVANCED QUEUE MATCH SETUP ---
    function queueMatchStart() {
        const checkedInPlayers = appState.players.filter(p => p.isCheckedIn && !p.isPlaying);
        if (checkedInPlayers.length < 4) {
            showError('ต้องมีผู้เล่นที่เช็คอินและว่างอยู่ 4 คนขึ้นไป');
            return;
        }

        const availableCourts = CourtUtils.getAvailable();
        if (availableCourts.length === 0) {
            showError('ไม่มีสนามว่างให้ใช้ในขณะนี้');
            return;
        }

        const playerStats = checkedInPlayers.map(p => ({
            id: p.id,
            name: p.name,
            skillValue: getPlayerSkillValue(p.skill),
            gameCount: getPlayerGameCount(p.id)
        }));

        playerStats.sort((a, b) => a.gameCount - b.gameCount);

        const top4 = playerStats.slice(0, 4);
        top4.sort((a, b) => a.skillValue - b.skillValue);

        const team1Ids = [top4[0].id, top4[3].id];
        const team2Ids = [top4[1].id, top4[2].id];

        const team1Names = team1Ids.map(id => PlayerUtils.getById(id).name).join(' & ');
        const team2Names = team2Ids.map(id => PlayerUtils.getById(id).name).join(' & ');

        if (confirm(`จัดคิวได้คู่ (เกมต่ำสุด):\nทีม 1: ${team1Names}\nทีม 2: ${team2Names}\nลงสนามหรือไม่?`)) {
            if (createMatch(availableCourts[0].id, team1Ids, team2Ids)) {
                renderCourtSelectDropdown('court-select-dropdown');
            }
        }
    }

    // --- ACTIVE MATCHES FUNCTIONS ---
    function renderActiveMatches() {
        const listEl = document.getElementById('active-matches-list');
        listEl.innerHTML = '';
        
        if (appState.matches.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; color: #888;">ไม่มีสนามที่กำลังแข่งขันอยู่</p>';
            return;
        }

        appState.matches.forEach(match => {
            const team1Names = match.team1.map(id => PlayerUtils.getById(id).name).join(' & ');
            const team2Names = match.team2.map(id => PlayerUtils.getById(id).name).join(' & ');

            const team1Skills = match.team1.map(id => PlayerUtils.getById(id).skill);
            const team2Skills = match.team2.map(id => PlayerUtils.getById(id).skill);

            const card = document.createElement('div');
            card.classList.add('match-card');
            card.dataset.matchId = match.id;
            
            card.innerHTML = `
                <h3>สนาม ${match.courtName}</h3>
                <div class="timer" id="match-timer-${match.id}">00:00</div>
                <div class="match-teams">
                    <div class="team">
                        <h4>ทีม 1</h4>
                        <p>${team1Names}</p>
                        <p>${team1Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${s}</span>`).join(' ')}</p>
                    </div>
                    <div class="vs">VS</div>
                    <div class="team">
                        <h4>ทีม 2</h4>
                        <p>${team2Names}</p>
                        <p>${team2Skills.map(s => `<span class="skill-badge skill-${getSkillClass(s)}">${s}</span>`).join(' ')}</p>
                    </div>
                </div>
                
                <div class="court-shuttle-control">
                    <div class="shuttle-control-item">
                        <span style="font-weight: bold; color: var(--primary);">ลูกใหม่:</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'new', -1)">-</button>
                        <span style="font-weight: bold; font-size: 1.2rem; min-width: 30px; text-align: center;" id="match-shuttle-new-${match.id}">${match.newShuttleUsed}</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'new', 1)">+</button>
                    </div>
                    <div class="shuttle-control-item">
                        <span style="font-weight: bold; color: var(--primary);">ลูกซ้อม:</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'practice', -1)">-</button>
                        <span style="font-weight: bold; font-size: 1.2rem; min-width: 30px; text-align: center;" id="match-shuttle-practice-${match.id}">${match.practiceShuttleUsed}</span>
                        <button onclick="updateMatchShuttleUsed(${match.id}, 'practice', 1)">+</button>
                    </div>
                </div>

                <h4 style="margin-top: 1.5rem; text-align: center;">ใครชนะ?</h4>
                <div class="match-controls">
                    <button class="success" onclick="recordMatchResult(${match.id}, 1)">ทีม 1 ชนะ</button>
                    <button style="background-color: #f1c40f; color: var(--dark);" onclick="recordMatchResult(${match.id}, 0)">เสมอ</button>
                    <button class="success" onclick="recordMatchResult(${match.id}, 2)">ทีม 2 ชนะ</button>
                </div>
                <div class="match-controls" style="margin-top: 1rem;">
                    <button class="danger" onclick="cancelMatch(${match.id})">ยกเลิกแมตช์</button>
                </div>
            `;
            listEl.appendChild(card);
            startTimer(match.id, card);
        });
        updateShuttleCounterDisplay();
        renderDashboard();
    }

    function updateMatchShuttleUsed(matchId, type, amount) {
        const match = appState.matches.find(m => m.id === matchId);
        if (!match) {
            showError('ไม่พบข้อมูลเกม');
            return;
        }

        if (type === 'new') {
            if (match.newShuttleUsed + amount >= 0) {
                match.newShuttleUsed += amount;
                document.getElementById(`match-shuttle-new-${matchId}`).textContent = match.newShuttleUsed;
            } else {
                showError('จำนวนลูกแบดใหม่ต้องไม่ติดลบ');
                return;
            }
        } else if (type === 'practice') {
            if (match.practiceShuttleUsed + amount >= 0) {
                match.practiceShuttleUsed += amount;
                document.getElementById(`match-shuttle-practice-${matchId}`).textContent = match.practiceShuttleUsed;
            } else {
                showError('จำนวนลูกแบดซ้อมต้องไม่ติดลบ');
                return;
            }
        }
        
        saveState();
    }

    function updateGlobalShuttlecocks(action, amount) {
        const validation = validateNumber(amount);
        if (!validation.valid) {
            showError(validation.error);
            return;
        }

        amount = parseInt(amount);

        switch (action) {
            case 'add':
            case 'add-practice':
                appState.shuttlecocks.inPlay += amount;
                appState.shuttlecocks.total += amount;
                break;
            case 'remove':
                if (appState.shuttlecocks.inPlay < amount) {
                    showError('ลูกแบดซ้อมในสต็อกไม่พอ');
                    return;
                }
                appState.shuttlecocks.inPlay -= amount;
                break;
        }

        if (appState.shuttlecocks.inPlay < 0) appState.shuttlecocks.inPlay = 0;

        saveState();
        updateShuttleCounterDisplay();
        showSuccess(`จัดการสตั้อกสำเร็จ: ${amount} ลูก`);
    }

    // --- MATCH RESULT FUNCTIONS ---
    function recordMatchResult(matchId, winningTeam) {
        const match = appState.matches.find(m => m.id === matchId);
        if (!match) {
            showError('ไม่พบข้อมูลเกม');
            return;
        }

        if (![0, 1, 2].includes(winningTeam)) {
            showError('ผลการแข่งขันไม่ถูกต้อง');
            return;
        }

        const gameResult = {
            id: appState.nextId.match++,
            matchId: matchId,
            courtId: match.courtId,
            startTime: match.startTime,
            endTime: Date.now(),
            duration: Date.now() - match.startTime,
            team1: match.team1,
            team2: match.team2,
            winner: winningTeam,
            newShuttleUsed: match.newShuttleUsed,
            practiceShuttleUsed: match.practiceShuttleUsed
        };

        const allPlayers = [...match.team1, ...match.team2];
        allPlayers.forEach(playerId => {
            if (!appState.history[playerId]) {
                appState.history[playerId] = { games: [] };
            }
            appState.history[playerId].games.push(gameResult);
        });
        
        endMatch(matchId);
        saveState();
        
        const resultText = winningTeam === 1 ? 'ทีม 1 ชนะ' : winningTeam === 2 ? 'ทีม 2 ชนะ' : 'เสมอ';
        showSuccess(`บันทึกผล: ${resultText}`);
    }

    function endMatch(matchId) {
        const matchIndex = appState.matches.findIndex(m => m.id === matchId);
        if (matchIndex === -1) return;

        const match = appState.matches[matchIndex];
        
        stopTimer(matchId);

        const allPlayers = [...match.team1, ...match.team2];
        allPlayers.forEach(playerId => {
            const player = PlayerUtils.getById(playerId);
            if (player) {
                player.isPlaying = false;
            }
        });

        const court = CourtUtils.getById(match.courtId);
        if (court) {
            court.status = 'free';
            delete court.currentMatchId;
        }

        appState.matches.splice(matchIndex, 1);
        
        saveState();
        renderActiveMatches();
        renderCheckInList();
        renderDashboard();
        renderCourtList();
        renderMatchSetup();
    }

    function cancelMatch(matchId) {
        const match = appState.matches.find(m => m.id === matchId);
        if (!match) return;

        if (confirm(`ยกเลิกแมตช์สนาม ${match.courtName}?`)) {
            appState.shuttlecocks.inPlay += 1;
            endMatch(matchId);
            showSuccess(`ยกเลิกแมตช์สนาม ${match.courtName} สำเร็จ`);
        }
    }

    // --- PLAYER HISTORY - MODAL FUNCTIONS ---
    function openPlayerHistoryModal(playerId) {
        const player = PlayerUtils.getById(playerId);
        const history = appState.history[playerId];
        
        if (!player || !history || history.games.length === 0) {
            showError(`ไม่พบประวัติการเล่น`);
            return;
        }

        document.getElementById('modal-player-name').textContent = `ประวัติการเล่น #${player.id} ${player.name}`;
        
        const statsHtml = getPlayerStatsHtml(playerId, player, history);
        document.getElementById('modal-player-stats').innerHTML = statsHtml;

        const gamesHtml = getPlayerGamesHtml(playerId, history);
        document.getElementById('modal-game-records').innerHTML = gamesHtml;

        document.getElementById('player-history-modal').classList.add('active');
    }

    function closePlayerHistoryModal() {
        document.getElementById('player-history-modal').classList.remove('active');
    }

    function getPlayerStatsHtml(playerId, player, history) {
        const gamesPlayed = history.games.length;
        
        const wins = history.games.filter(g => {
            const isTeam1 = g.team1.includes(playerId);
            const isTeam2 = g.team2.includes(playerId);
            
            if (isTeam1 && g.winner === 1) return true;
            if (isTeam2 && g.winner === 2) return true;
            return false;
        }).length;
        
        const draws = history.games.filter(g => g.winner === 0).length;
        const losses = gamesPlayed - wins - draws;

        const totalDuration = history.games.reduce((sum, g) => sum + g.duration, 0);
        const avgDuration = gamesPlayed > 0 ? totalDuration / gamesPlayed : 0;

        const winRate = gamesPlayed > 0 ? ((wins / gamesPlayed) * 100).toFixed(1) : 0;
        const winRateProgress = Math.round(winRate);

        return `
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--secondary), var(--primary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;">#${player.id}</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: var(--primary); font-size: 1.2rem;">${player.name}</h4>
                        <span class="skill-badge skill-${getSkillClass(player.skill)}" style="margin-top: 0.25rem; display: inline-block;">${player.skill}</span>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1.25rem; border-radius: 12px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${gamesPlayed}</div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">เกมทั้งหมด</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--success);">${wins}</div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">ชนะ</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--danger);">${losses}</div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">แพ้</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; font-size: 0.9rem; color: var(--primary);">อัตราชนะ</span>
                            <span style="font-weight: bold; font-size: 1.1rem; color: var(--secondary);">${winRate}%</span>
                        </div>
                        <div style="background: #ddd; height: 12px; border-radius: 20px; overflow: hidden; position: relative;">
                            <div style="background: linear-gradient(90deg, var(--success), var(--secondary)); height: 100%; width: ${winRateProgress}%; transition: width 0.5s ease; border-radius: 20px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function getPlayerGamesHtml(playerId, history) {
        // แสดงทุกเกม เรียงจากล่าสุดไปเก่าสุด
        const allGames = [...history.games].reverse();
        
        return `
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--light);">
                <h4 style="margin: 0 0 1.25rem 0; color: var(--primary); font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.4rem;">📜</span>
                    <span>Timeline ประวัติการแข่งขัน (${history.games.length} เกม)</span>
                </h4>
                
                <div style="position: relative; padding-left: 2rem;">
                    <!-- Timeline Line -->
                    <div style="position: absolute; left: 0.5rem; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--secondary), var(--primary)); border-radius: 3px;"></div>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        ${allGames.map((game, index) => {
                            const gameNumber = history.games.length - index;
                            const myTeam = game.team1.includes(playerId) ? 1 : 2;
                            const myPartners = myTeam === 1 ? game.team1.filter(id => id !== playerId) : game.team2.filter(id => id !== playerId);
                            const opponentTeam = myTeam === 1 ? game.team2 : game.team1;
                            
                            const partnerNames = myPartners.map(id => {
                                const p = PlayerUtils.getById(id);
                                return p.name;
                            }).join(' & ');
                            
                            const opponentNames = opponentTeam.map(id => {
                                const p = PlayerUtils.getById(id);
                                return p.name;
                            }).join(' & ');
                            
                            let resultIcon = '⊚';
                            let resultText = 'เสมอ';
                            let resultClass = 'draw';
                            let bgColor = '#f5f5f5';
                            let borderColor = '#bdbdbd';
                            let dotColor = '#9e9e9e';
                            let dotIcon = '●';

                            if ((myTeam === 1 && game.winner === 1) || (myTeam === 2 && game.winner === 2)) {
                                resultIcon = '✓';
                                resultText = 'ชนะ';
                                resultClass = 'win';
                                bgColor = '#f1f8f4';
                                borderColor = '#27ae60';
                                dotColor = '#27ae60';
                                dotIcon = '✓';
                            } else if ((myTeam === 1 && game.winner === 2) || (myTeam === 2 && game.winner === 1)) {
                                resultIcon = '✗';
                                resultText = 'แพ้';
                                resultClass = 'loss';
                                bgColor = '#fef5f5';
                                borderColor = '#e74c3c';
                                dotColor = '#e74c3c';
                                dotIcon = '✗';
                            }

                            return `
                                <div style="position: relative;">
                                    <!-- Timeline Dot -->
                                    <div style="position: absolute; left: -1.75rem; top: 1rem; width: 28px; height: 28px; background: ${dotColor}; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1;">
                                        ${dotIcon}
                                    </div>
                                    
                                    <!-- Game Card -->
                                    <div style="background: ${bgColor}; padding: 1rem 1.25rem; border-radius: 10px; border-left: 4px solid ${borderColor}; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)';">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-size: 0.75rem; color: #888; font-weight: 600; background: white; padding: 0.2rem 0.5rem; border-radius: 4px;">เกมที่ ${gameNumber}</span>
                                            </div>
                                            <span class="win-indicator ${resultClass}" style="font-size: 0.75rem; padding: 0.3rem 0.7rem;">${resultIcon} ${resultText}</span>
                                        </div>
                                        
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.9rem;">
                                            ${partnerNames ? `
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="color: var(--secondary); font-size: 1.1rem;">👥</span>
                                                    <span style="color: #666;">คู่:</span>
                                                    <span style="font-weight: 600;">${partnerNames}</span>
                                                </div>
                                            ` : ''}
                                            
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="color: var(--danger); font-size: 1.1rem;">⚔️</span>
                                                <span style="color: #666;">VS:</span>
                                                <span style="font-weight: 600;">${opponentNames}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                ${allGames.length === 0 ? '<p style="text-align: center; color: #888; padding: 2rem;">ยังไม่มีประวัติการแข่งขัน</p>' : ''}
            </div>
        `;
    }


    // --- PLAYER HISTORY FUNCTIONS ---
    // ถูกเอาออกแล้ว

    // --- COURT FUNCTIONS ---
    function addCourt(name) {
        name = name.trim();
        
        if (!name || name.length === 0) {
            showError('ชื่อสนามห้ามว่าง');
            return false;
        }

        if (name.length > 50) {
            showError('ชื่อสนามยาวเกินไป');
            return false;
        }

        if (appState.courts.some(c => c.name.toLowerCase() === name.toLowerCase())) {
            showError('ชื่อสนามนี้มีอยู่แล้ว');
            return false;
        }

        const newCourt = {
            id: appState.nextId.court++,
            name: name,
            status: 'free',
            currentMatchId: null
        };
        
        appState.courts.push(newCourt);
        saveState();
        renderCourtList();
        renderMatchSetup();
        showSuccess(`เพิ่มสนาม ${newCourt.name} สำเร็จ`);
        return true;
    }

    function deleteCourt(id) {
        const court = CourtUtils.getById(id);
        if (!court) return;

        if (court.status === 'playing') {
            showError(`ไม่สามารถลบสนาม ${court.name} ได้เนื่องจากมีแมตช์กำลังแข่งขันอยู่`);
            return;
        }

        if (confirm(`คุณแน่ใจหรือว่าต้องการลบสนาม ${court.name}?`)) {
            appState.courts = appState.courts.filter(c => c.id !== id);
            saveState();
            renderCourtList();
            renderMatchSetup();
            showSuccess(`ลบสนาม ${court.name} สำเร็จ`);
        }
    }

    function renderCourtList() {
        const listEl = document.getElementById('court-list');
        listEl.innerHTML = '';
        
        if (appState.courts.length === 0) {
            listEl.innerHTML = '<p style="text-align: center; color: #888;">ยังไม่มีสนามที่เพิ่มเข้ามา</p>';
            return;
        }

        appState.courts.forEach(court => {
            const li = document.createElement('div');
            li.style.cssText = 'background-color: ' + (court.status === 'playing' ? '#ffe0b2' : 'var(--light)') + '; padding: 1rem; margin-bottom: 0.75rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';
            li.innerHTML = `
                <span>
                    ${court.name} 
                    <span style="font-size: 0.8rem; color: ${court.status === 'playing' ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                        (${court.status === 'playing' ? 'กำลังเล่น' : 'ว่าง'})
                    </span>
                </span>
                <button class="danger" style="padding: 0.5rem 1rem;" onclick="deleteCourt(${court.id})">ลบ</button>
            `;
            listEl.appendChild(li);
        });
    }

    function renderSettings() {
        renderCourtList();
        updateShuttleCounterDisplay();
    }

    // --- EVENT LISTENERS ---
    document.getElementById('add-player-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('player-name').value;
        const skill = document.getElementById('player-skill').value;
        const result = addPlayer(name, skill);
        
        if (result.success) {
            saveState();
            renderPlayerList();
            document.getElementById('player-name').value = '';
            showSuccess(`เพิ่ม ${result.player.name} สำเร็จ`);
        } else {
            showError(result.error);
        }
    });

    document.getElementById('bulk-add-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const namesText = document.getElementById('bulk-names').value;
        const skill = document.getElementById('bulk-skill').value;
        if (namesText.trim()) {
            addPlayersBulk(namesText, skill);
            document.getElementById('bulk-names').value = '';
        }
    });

    document.getElementById('player-search').addEventListener('input', function(e) {
        renderPlayerList(e.target.value);
    });

    document.getElementById('bulk-edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const newSkill = document.getElementById('bulk-edit-skill').value;
        updatePlayerSkillBulk(newSkill);
    });

    document.getElementById('add-court-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('court-name').value;
        if (addCourt(name)) {
            document.getElementById('court-name').value = '';
        }
    });
    
    document.getElementById('live-shuttle-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const action = document.getElementById('live-shuttle-action').value;
        const amount = document.getElementById('live-shuttle-amount').value;
        updateGlobalShuttlecocks(action, amount);
        document.getElementById('live-shuttle-amount').value = '1';
    });

    document.getElementById('settings-shuttle-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const action = document.getElementById('settings-shuttle-action').value;
        const amount = document.getElementById('settings-shuttle-amount').value;
        updateGlobalShuttlecocks(action, amount);
        document.getElementById('settings-shuttle-amount').value = '1';
    });

    document.getElementById('player-history-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePlayerHistoryModal();
        }
    });

    // --- INITIALIZATION ---
    window.onload = function() {
        loadState();
        showView('dashboard');
    };
</script>
</body>
</html>